<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New Mash programming language</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For several years, I tried my hand at designing my own programming language. I wanted to create in my opinion the most simple, full-featured and conve...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>New Mash programming language</h1><div class="post__text post__text-html js-mediator-article">  For several years, I tried my hand at designing my own programming language.  I wanted to create in my opinion the most simple, full-featured and convenient language. <br><br>  In this article I want to highlight the main stages of my work and first describe the created concept of the language and its first implementation that I am working on now. <br><a name="habracut"></a><br>  I will say in advance that I wrote the whole project on Free Pascal, because  programs on it can be assembled under a huge number of platforms, and the compiler itself produces very optimized binaries (I collect all the components of a project with the O2 flag). <br><br><h3>  Language runtime </h3><br>  The first thing is to talk about the virtual machine, which I had to write to perform future applications in my language.  I decided to implement the stack architecture, perhaps because it was the easiest way.  I did not find a single normal article on how to do this in Russian, so after becoming familiar with English-language material I sat down to design and write my bicycle.  Next, I will bring my "advanced" ideas and developments in this matter. <br><br><h4>  Stack implementation </h4><br>  Obviously, the VM is headed by the stack.  In my implementation, it works in blocks.  In essence, this is a simple array of pointers and a variable to store the index of the top of the stack. <br>  When it is initialized, an array of 256 elements is created.  If more pointers are thrown onto the stack, then its size increases by the next 256 items.  Accordingly, when removing items from the stack - its size is adjustable. <br><br>  The VM uses several stacks: <br><br><ol><li>  Main stack </li><li>  Stack to store return points. </li><li>  Stack garbage collector. </li><li>  A stack of a try / catch / finally block handler. </li></ol><br><h4>  Constants and variables </h4><br>  It's all simple.  Constants are processed by a separate small piece of code and are available in applications in the future at static addresses.  Variables are an array of pointers of a certain size, access to its cells is carried out by index - i.e.  static address.  Variables can be placed at the top of the stack or read it from there.  Actually, because  Since our variables essentially store pointers to values ‚Äã‚Äãin the VM memory, then work with implicit pointers prevails in the language. <br><br><h4>  Garbage collector </h4><br>  In my VM it is semi-automatic.  Those.  the developer himself decides when to call the garbage collector.  It does not work on the usual pointer count, as in the same Python, Perl, Ruby, Lua, etc.  It is implemented through a system of markers.  Those.  when it is assumed that a variable is assigned a temporary value - a pointer to this value is added to the stack of the garbage collector.  In the future, the collector quickly goes over the already prepared list of pointers. <br><br><h4>  Handling try / catch / finally blocks </h4><br>  As with any modern language, exception handling is an important component.  The VM kernel is wrapped in a try..catch block, which can return to code execution, after catching an exception, by putting some information about it on the stack.  In the application code, you can set try / catch / finally blocks of code, indicating entry points to catch (exception handler) and finally / end (end of block). <br><br><h4>  Multithreading </h4><br>  It is maintained at the VM level.  It is easy and convenient to use.  It works without an interrupt system, so the code should be executed in several threads several times faster, respectively. <br><br><h4>  External Libraries for VMs </h4><br>  Without this can not do.  VM supports import, just as it is implemented in other languages.  You can write part of the code in Mash and part of the code in native languages, then linking them together. <br><br><h3>  Translator from high-level language Mash to Baytkod for VM </h3><br><h4>  Intermediate language </h4><br>  To quickly write a translator from a complex language to a code for a VM, I first developed an intermediate language.  It turned out assembler-like scary sight, which does not have much to consider here.  Let me just say that at this level, the translator processes most constants, variables, calculates their static addresses and addresses of entry points. <br><br><h4>  Translator Architecture </h4><br>  I chose not the best architecture for implementation.  The translator does not build a code tree, as befits other translators.  He looks at the beginning of the design.  Those.  if the piece of code being parsed is of the form ‚Äúwhile &lt;condition&gt;:‚Äù, then it is obvious that this is a while construct of a loop and should be processed as a while construct of a loop.  Something like a complex switch-case. <br><br>  Thanks to this architectural solution, the translator was not very fast.  However, the simplicity of its refinement has increased significantly.  I added the necessary constructions faster than my coffee could cool.  Full support for the PLO was implemented at all in less than a week. <br><br><h4>  Code optimization </h4><br>  Here, of course, it was possible to realize better (and it will be realized, but later, how the hands will reach).  So far, the optimizer only knows how to cut off unused code, constants, and imports from an assembly.  Also, several constants with the same value are replaced by one.  That's all. <br><br><h3>  Language mash </h3><br><h4>  Basic language concept </h4><br>  The main idea was to develop the most functional and simple language.  I believe that the development of the task copes with a bang. <br><br><h4>  Blocks of code, procedures and functions </h4><br>  All constructions in the language are opened with a colon <b>:</b> and closed with the operator <b>end</b> . <br><br>  Procedures and functions are declared as proc and func, respectively.  Arguments are listed in parentheses.  Just like most other languages. <br><br>  The <b>return statement</b> can return a value from a function, the <b>break</b> statement allows you to exit a procedure / function (if it is out of cycles). <br><br>  Code example: <br><br><pre><code class="ruby">...

func summ(a, b):
  return a + b
end

proc main():
  println(summ(inputln(), inputln()))
end
</code></pre><br>
<h4>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</h4><br>
<ul>
<li>–¶–∏–∫–ª—ã: for..end, while..end, until..end</li>
<li>–£—Å–ª–æ–≤–∏—è: if..[else..]end, switch..[case..end..][else..]end</li>
<li>–ú–µ—Ç–æ–¥—ã: proc &lt;–∏–º—è&gt;():‚Ä¶ end, func &lt;–∏–º—è&gt;():‚Ä¶ end</li>
<li>Label &amp; goto: &lt;–∏–º—è&gt;:, jump &lt;–∏–º—è&gt;</li>
<li>Enum –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã.</li>
</ul><br>
<h4>–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ</h4><br>
–¢—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä –∏—Ö –º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ª–∏–±–æ –µ—Å–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∏—à–µ—Ç var –ø–µ—Ä–µ–¥ –∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º.<br>
<br>
–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞:<br>
<br>
<pre><code class="ruby">a ?= 10
b ?= a + 20
</code></pre><br>
<pre><code class="ruby">var a = 10, b = a + 20
</code></pre><br>
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.<br>
<br>
<h4>–û–û–ü</h4><br>
–ù—É –≤–æ—Ç –∏ –ø–æ–¥–æ–±—Ä–∞–ª–∏—Å—å –º—ã –∫ —Å–∞–º–æ–π –≤–∫—É—Å–Ω–æ–π —Ç–µ–º–µ. –í —è–∑—ã–∫–µ Mash –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –ø–∞—Ä–∞–¥–∏–≥–º—ã –æ–±—ä–µ–∫—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –¢.–µ. –∫–ª–∞—Å—Å—ã, –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º (–≤ —Ç.—á. –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π), –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è –∏ –∏–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏—è (–ø–æ–ª–Ω–∞—è).<br>
<br>
–ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–µ–¥—É –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞.<br>
<br>
–ü—Ä–æ—Å—Ç–æ–π –∫–ª–∞—Å—Å –∏ —Ä–∞–±–æ—Ç–∞ —Å –Ω–∏–º:<br>
<br>
<pre><code class="ruby">uses &lt;bf&gt;
uses &lt;crt&gt;

class MyClass:
  var a, b
  proc Create, Free
  func Summ
end

proc MyClass::Create(a, b):
  $a = new(a)
  $b = new(b)
end

proc MyClass::Free():
  Free($a, $b)
  $rem()
end

func MyClass::Summ():
  return $a + $b
end

proc main():
  x ?= new MyClass(10, 20)
  println(x-&gt;Summ())
  x-&gt;Free()
end
</code></pre><br>
–í—ã–≤–µ–¥–µ—Ç: 30.<br>
<br>
–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º:<br>
<br>
<pre><code class="ruby">uses &lt;bf&gt;
uses &lt;crt&gt;

class MyClass:
  var a, b
  proc Create, Free
  func Summ
end

proc MyClass::Create(a, b):
  $a = new(a)
  $b = new(b)
end

proc MyClass::Free():
  Free($a, $b)
  $rem()
end

func MyClass::Summ():
  return $a + $b
end

class MyNewClass(MyClass):
  func Summ
end

func MyNewClass::Summ():
  return ($a + $b) * 2
end

proc main():
  x ?= new MyNewClass(10, 20)
  println(x-&gt;Summ())
  x-&gt;Free()
end
</code></pre><br>
–í—ã–≤–µ–¥–µ—Ç: 60.<br>
<br>
–ß—Ç–æ –Ω–∞ —Å—á–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º–∞? –î–∞ —ç—Ç–æ –∂–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏—è!:<br>
<br>
<pre><code class="ruby">uses &lt;bf&gt;
uses &lt;crt&gt;

class MyClass:
  var a, b
  proc Create, Free
  func Summ
end

proc MyClass::Create(a, b):
  $a = new(a)
  $b = new(b)
end

proc MyClass::Free():
  Free($a, $b)
  $rem()
end

func MyClass::Summ():
  return $a + $b
end

class MyNewClass(MyClass):
  func Summ
end

func MyNewClass::Summ():
  return ($a + $b) * 2
end

proc main():
  x ?= new MyClass(10, 20)
  x-&gt;Summ ?= MyNewClass::Summ
  println(x-&gt;Summ())
  x-&gt;Free()
end
</code></pre><br>
–í—ã–≤–µ–¥–µ—Ç: 60.<br>
<br>
–¢–µ–ø–µ—Ä—å —É–¥–µ–ª–∏–º –º–∏–Ω—É—Ç–∫—É –∏–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏ –∫–ª–∞—Å—Å–æ–≤:<br>
<br>
<pre><code class="ruby">uses &lt;bf&gt;
uses &lt;crt&gt;

class MyClass:
  var a, b
end

proc main():
  x ?= new MyClass
  println(BoolToStr(x-&gt;type == MyClass))
  x-&gt;rem()
  println(BoolToStr(typeof(3.14) == typeReal))
end
</code></pre><br>
–í—ã–≤–µ–¥–µ—Ç: true, true.<br>
<br>
<h4>–û–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞—Ö –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è –∏ —è–≤–Ω—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª—è—Ö</h4><br>
–û–ø–µ—Ä–∞—Ç–æ—Ä ?= —Å–ª—É–∂–∏—Ç –¥–ª—è –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —É–∫–∞–∑–∞—Ç–µ–ª—è –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏.<br>
–û–ø–µ—Ä–∞—Ç–æ—Ä = –∏–∑–º–µ–Ω—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏ –ø–æ —É–∫–∞–∑–∞—Ç–µ–ª—é –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.<br>
–ò —Ç–µ–ø–µ—Ä—å –Ω–µ–º–Ω–æ–≥–æ –æ —è–≤–Ω—ã—Ö —É–∫–∞–∑–∞—Ç–µ–ª—è—Ö. –î–æ–±–∞–≤–∏–ª —è –∏—Ö –≤ —è–∑—ã–∫ —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏.<br>
@&lt;–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è&gt; ‚Äî –≤–∑—è—Ç—å —è–≤–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é.<br>
?&lt;–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è&gt; ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ —É–∫–∞–∑–∞—Ç–µ–ª—é.<br>
@= ‚Äî –ø—Ä–∏—Å–≤–æ–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –ø–æ —è–≤–Ω–æ–º—É —É–∫–∞–∑–∞—Ç–µ–ª—é –Ω–∞ –Ω–µ—ë.<br>
<br>
–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:<br>
<br>
<pre><code class="ruby">uses &lt;bf&gt;
uses &lt;crt&gt;

proc main():
  var a = 10, b
  b ?= @a
  PrintLn(b)
  b ?= ?b
  PrintLn(b)
  b++
  PrintLn(a)
  InputLn()
end
</code></pre><br>
–í—ã–≤–µ–¥–µ—Ç: –∫–∞–∫–æ–µ-—Ç–æ —á–∏—Å–ª–æ, 10, 11.<br>
<br>
<h4>Try..[catch..][finally..]end</h4><br>
–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞:<br>
<br>
<pre><code class="ruby">uses &lt;bf&gt;
uses &lt;crt&gt;

proc main():
  println("Start")
  try:
    println("Trying to do something...")
    a ?= 10 / 0
  catch:
    println(getError())
  finally:
    println("Finally")
  end
  println("End")
  inputln()
end
</code></pre><br>
<h4>–ü–ª–∞–Ω—ã –Ω–∞ –±—É–¥—É—â–µ–µ</h4><br>
–í—Å–µ –ø—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å –¥–∞ –ø—Ä–∏—Å–º–∞—Ç—Ä–∏–≤–∞—é—Å—å –∫ GraalVM &amp; Truffle. –£ –º–æ–µ–π —Å—Ä–µ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç JIT –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä, —Ç–∞–∫ —á—Ç–æ –≤ –ø–ª–∞–Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –æ–Ω –ø–æ–∫–∞ —á—Ç–æ –º–æ–∂–µ—Ç —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—é —Ä–∞–∑–≤–µ —á—Ç–æ –ø–∏—Ç–æ–Ω—É. –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –º–Ω–µ –æ–∫–∞–∂–µ—Ç—Å—è –ø–æ–¥ —Å–∏–ª—É —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å JIT –∫–æ–º–ø–∏–ª—è—Ü–∏—é –Ω–∞ –±–∞–∑–µ GraalVM –∏–ª–∏ LLVM.<br>
<br>
<h4>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</h4><br>
–í—ã –º–æ–∂–µ—Ç–µ –ø–æ–∏–≥—Ä–∞—Ç—å—Å—è —Å –Ω–∞—Ä–∞–±–æ—Ç–∫–∞–º–∏ –∏ –ø—Ä–æ—Å–ª–µ–¥–∏—Ç—å –∑–∞ –ø—Ä–æ–µ–∫—Ç–æ–º —Å–∞–º–∏.<br>
<br>
<a href="http://mash-lang.tech/">–°–∞–π—Ç</a><br>
<a href="http://github.com/RoPi0n/mash-lang">–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub</a><br>
<br>
–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –¥–æ—á–∏—Ç–∞–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞, –µ—Å–ª–∏ –≤—ã —ç—Ç–æ —Å–¥–µ–ª–∞–ª–∏.</div><p>Source: <a href="https://habr.com/ru/post/434966/">https://habr.com/ru/post/434966/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>