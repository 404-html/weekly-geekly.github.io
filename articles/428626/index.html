<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make an extension for PHP7 harder than "hello, world", and not become a red-eyed. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What for? 
 I am writing this article so that the reader, who took a total of not less than a year to complete the journey, could walk a couple of hou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make an extension for PHP7 harder than "hello, world", and not become a red-eyed. Part 1</h1><div class="post__text post__text-html js-mediator-article"><h2>  What for? </h2><br>  I am writing this article so that the reader, who took a total of not less than a year to complete the journey, could walk a couple of hours.  As my personal experience has shown, simply programming in C is somewhat easier than making a serious PHP extension work.  Here I will tell you in as much detail as possible how to make an extension using the example of the <a href="http://github.com/legale/libtrie">libtrie</a> library, which implements a prefix tree, better known as trie.  I will write and perform the described actions in parallel on a freshly installed Lubuntu 18.04 system. <br><br>  Let's start. <br><a name="habracut"></a><br><h2>  Software installation </h2><br><h4>  Php </h4><br><ol><li>  First we install the php7.2-dev package, in it the phpize script needed for building the extension.  In addition, we need a working version of php, on which we will check our extension.  Installing this package will pull up a certain number of dependent packages; we put everything that is offered. <br><br><pre><code class="bash hljs">sudo apt install php7.2-dev</code> </pre> <br></li><li>  Go to the site php.net, go to the downloads section and pull out a link to the archive with the latest stable version of php, now it is version 7.2.11. <br>  Downloading the php source archive: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /tmp &amp;&amp; wget http://it2.php.net/get/php-7.2.11.tar.gz/from/this/mirror -O php7.tar.gz</code> </pre><br></li><li>  Now unpack the archive yourself: <br><br><pre> <code class="bash hljs">sudo tar -xvf php7.tar.gz -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src</code> </pre><br></li></ol><br><h4>  Code editors </h4><br>  I usually use 2 code editors.  Simple and fast geany and pretty brake, but very advanced clion of the company JetBrains.  Geany install from standard turnips Ubuntu. <br><br><pre> <code class="bash hljs">sudo apt install geany</code> </pre><br>  Clion download from the official website of JetBrains: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Downloads &amp;&amp; wget https://download.jetbrains.com/cpp/CLion-2018.2.5.tar.gz -O clion.tar.gz</code> </pre><br><pre> <code class="bash hljs">sudo tar -xvf clion.tar.gz -C /usr/share</code> </pre><br>  Make a link to make it convenient to run clion from the console. <br><br><pre> <code class="bash hljs">sudo ln -s /usr/share/clion-2018.2.5/bin/clion.sh /usr/bin/clion</code> </pre><br>  After the first launch, clion will create shortcuts for itself from the LXpanel shell menu, but the first time you need to launch it with your hands. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#–∑–∞–ø—É—Å—Ç–∏–º clion</span></span></code> </pre><br><h2>  Creating an extension </h2><br>  Here we have at least 3 options: <br><br><ol><li>  Take the raw standard disc from the php sources we downloaded. </li><li>  Saw a standard blank with a special ext_skel script </li><li>  Get a good minimalist blank <a href="https://github.com/c9s/php-ext-skeleton">from here</a> . </li></ol><br>  The third option I like the most, but I will use the second, in case of failure to minimize the number of places where I could be mistaken.  Although picking a pig of developers is still a pleasure :-) <br><br><ol><li>  Go to the directory with standard php extensions. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/ext</code> </pre><br>  In addition to the name of the script, you can set some extension parameters through the proto file.  All this can not be done.  I'll do everything with my hands, but how proto works will show.  We make a trie, so we will call our extension libtrie.  To work in the / usr / local / src directory, you need administrator privileges, so as not to endlessly write sudo, I will enable bash with elevated privileges. <br><br><pre> <code class="bash hljs">sudo bash</code> </pre><br></li><li>  Here I will set the parameters of only 1 function that the extension will implement.  This is just a demonstration function to show how this is done. <br><br>  We will make a complete analog of the standard function. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">array</span></span> array_fill ( int $start_index , int $num , mixed $value )</code> </pre><br>  The syntax in the proto file is very simple, you just need to specify the name of the function.  I will write a little more to look more informative. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> my_array_fill \( int start_index , int num , mixed value \) &gt;&gt; libtrie.proto</code> </pre><br></li><li>  Now run the ext_skel script, giving it the extension name and the proto file we created. <br><br><pre> <code class="bash hljs">./ext_skel --extname=libtrie --proto=./libtrie.proto</code> </pre><br></li><li>  We have created a directory with our extension.  Let's go into it. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> libtrie</code> </pre><br></li></ol><br><h4>  File structure and build principle </h4><br><div class="spoiler">  <b class="spoiler_title">File structure</b> <div class="spoiler_text"><pre> <code class="bash hljs">config.m4 - —Ç—É—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –Ω–∞—á–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞—Å—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –∫–æ—Ç–æ—Ä–æ–π —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ phpize –≥–æ—Ç–æ–≤–∏—Ç —Å–∫—Ä–∏–ø—Ç ./configure, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è makefile. CREDITS - –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª, –≤ –∫–æ—Ç–æ—Ä–æ–º –ø–∏—à—É—Ç –∫—Ç–æ –∞–≤—Ç–æ—Ä, –∫–æ–≥–æ –æ–Ω –±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç libtrie.c - —Ç—É—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ –Ω–∞—à–µ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è php_libtrie.h - —Ç—É—Ç –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è config.w32 - —Ç—É—Ç –Ω–∞—á–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ–¥ windows EXPERIMENTAL - –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª. –¢–∞–∫ –∏ –Ω–µ —Ä–∞–∑–æ–±—Ä–∞–ª, —á—Ç–æ –≤ –Ω–µ–º –ø–∏—à—É—Ç. libtrie.php - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π php —Ñ–∞–π–ª –¥–ª—è –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è. tests - —Ç–µ—Å—Ç—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è</code> </pre><br></div></div><br>  To successfully build the extension, you need only 3 files.  In the minimalist extension bar, which I mentioned above, there are only 3 files. <br><br><pre> <code class="bash hljs">config.m4 php_libtrie.h libtrie.c</code> </pre><br>  I do not like the standard naming convention in php; I like the header files and files with the body of the program to be called the same.  Therefore rename <br> <code>libtrie.c</code> <br>  at <br> <code>php_libtrie.c</code> <br> <br><pre> <code class="bash hljs">mv libtrie.c php_libtrie.c</code> </pre><br><h4>  Editing config.m4 </h4><br>  The default config.m4 file is literally stuffed with content, the abundance of which is confusing and confusing.  As I said, this file is needed to form the configure script.  Read more about it <a href="http://php.net/manual/en/internals2.buildsys.configunix.php">here</a> . <br><br><pre> <code class="bash hljs">geany config.m4 &amp;</code> </pre><br>  We leave only this: <br><br><pre> <code class="bash hljs">PHP_ARG_ENABLE(libtrie, whether to <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> libtrie support, [ --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-libtrie Enable libtrie support]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PHP_LIBTRIE</span></span></span><span class="hljs-string">"</span></span> != <span class="hljs-string"><span class="hljs-string">"no"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment"># –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å –∫–∞–∫–∏–µ-—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã # PHP_ADD_INCLUDE() # –∫–ª—é—á–µ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ PHP_NEW_EXTENSION(libtrie, php_libtrie.c, $ext_shared) # PHP_NEW_EXTENSION(libtrie, php_libtrie.c, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1) fi</span></span></code> </pre><br><img src="https://habrastorage.org/webt/mb/fz/y_/mbfzy_te6ilmvy8oelvaf91_g20.png"><br><br>  The first macro creates the ability to enable and disable our extension when running the configure script being created. <br><br>  The second block is the most important, it determines which files will be compiled as part of our extension, whether the extension will be dynamically connected via the .so file, or the extension will be static and will be integrated when building php.  Our will be dynamic. <br>  Save the file. <br><br>  Copy the file in the user directory, so as not to work in root mode. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#–≤—ã—Ö–æ–¥ –∏–∑ —Ä—É—Ç–æ–≤–æ–≥–æ –±–∞—à–∞ exit</span></span></code> </pre><br>  We copy: <br><br><pre> <code class="bash hljs">cp /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/ext/libtrie ~/Documents/ -r</code> </pre><br><h3>  Demonstration function </h3><br>  Let me remind you that we will do the full analogue of array_fill ().  I will work through clion, but this guide can be done in any editor.  Clion is good in that it allows you to automatically do a basic syntax check, and also supports quick transition to files or functions via ctrl + click.  In order for such transitions to work in our extension, you will have to configure the CMakeLists.txt file. <br><br>  For clion to work properly, you will need to install the cmake build system, along with which a bunch of dependent packages will be installed.  Install all this with the command: <br><br><pre> <code class="bash hljs">sudo apt install cmake</code> </pre><br><h4>  Cmake setup </h4><br>  Open our catalog with the extension in clion.  We create a CMakeLists.txt file with the following contents through the context menu by clicking on the name of the root directory at the top of the screen: <br><br><pre> <code class="bash hljs">cmake_minimum_required(VERSION 3.12) project(php-ext-libtrie C) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(CMAKE_C_STANDARD 11) <span class="hljs-comment"><span class="hljs-comment"># –∑–∞–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é phproot, —á—Ç–æ–±—ã —É–¥–æ–±–Ω–µ–µ –ø—Ä–æ–ø–∏—Å—ã–≤–∞—Ç—å –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º php set(phproot /usr/local/src/php-7.2.11/) # —Ç—É—Ç —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–∞—Ç–∞–ª–æ–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç # –º—ã –¥–µ–ª–∞–µ–º —ç—Ç–æ —á—Ç–æ–±—ã –∑–∞—Å—Ç–∞–≤–∏—Ç—å clion –ø–æ–Ω–∏–º–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –º–∞–∫—Ä–æ—Å—ã —Å–∞–º–æ–≥–æ php include_directories(${phproot}) include_directories(${phproot}TSRM/) include_directories(${phproot}main/) include_directories(${phproot}Zend/) # –±–µ–∑ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ clion –Ω–µ —Å–º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏ –Ω–µ –±—É–¥–µ—Ç –Ω–∏—á–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å add_executable(php-ext-libtrie php_libtrie.c)</span></span></code> </pre><br><img src="https://habrastorage.org/webt/ag/nc/qj/agncqji78vvzfcbyevpwi-9gszy.png"><br><br>  Maybe someone knows how to make this file shorter so that clion starts indexing the project files.  I did not find a shorter way.  If someone knows, write in the comments. <br><br><h4>  Demo function code </h4><br>  Open our body file with our extension <code>php_libtrie.c</code> and <br>  delete all comments so that they do not confuse us. <br><br><img src="https://habrastorage.org/webt/8x/sj/c2/8xsjc2q571audrqfbliblnct4-8.png"><br><br><img src="https://habrastorage.org/webt/vu/ql/mu/vuqlmu48nqu2fkkasdosjsma8zw.png"><br><br>  Clion checks whether all the functions and macros used in the code have been declared and throws an error if this is not the case.  Obviously, PHP developers do not use clion, but they probably would have done something with it.  To prevent these errors from appearing in our extension, we include the missing header files to us. <br><br>  To streamline everything, I do this: <br>  I include all include with headers from the <code>php_libtrie.c</code> file in <code>php_libtrie.h</code> , only 1 entry remains in the first file: <br><br><pre> <code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"php_libtrie.h"</span></span></span></span></code> </pre><br><img src="https://habrastorage.org/webt/ft/fe/yg/ftfeygfd1fznk5jxaccj8i9mt8k.png"><br><br>  In the file <code>php_libtrie.h</code> will be all the other necessary inclusions. <br><br><img src="https://habrastorage.org/webt/_v/_4/jg/_v_4jgpsak4g3aa7clykblcuq8y.png"><br><br><div class="spoiler">  <b class="spoiler_title">Content of my header file</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">PHP_LIBTRIE_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">PHP_LIBTRIE_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#ifdef</span></span> <span class="hljs-type"><span class="hljs-type">HAVE_CONFIG_H</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"config.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;stdarg.h&gt; //—Ç—É—Ç –¥–ª—è –º–∞–∫—Ä–æ—Å–∞ va_start() <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;inttypes.h&gt; //—Ç—É—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ —Ç–∏–ø—ã //–Ω—É–∂–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã <span class="hljs-symbol"><span class="hljs-symbol">#if</span></span> defined(__GNUC__) &amp;&amp; __GNUC__ &gt;= <span class="hljs-number"><span class="hljs-number">4</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> __attribute__ ((visibility(<span class="hljs-comment"><span class="hljs-comment">"default"</span></span>))) # define <span class="hljs-type"><span class="hljs-type">ZEND_DLEXPORT</span></span> __attribute__ ((visibility(<span class="hljs-comment"><span class="hljs-comment">"default"</span></span>))) <span class="hljs-symbol"><span class="hljs-symbol">#else</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> # define <span class="hljs-type"><span class="hljs-type">ZEND_DLEXPORT</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> # define <span class="hljs-type"><span class="hljs-type">SIZEOF_SIZE_T</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> //–Ω—É–∂–Ω–∞ –¥–ª—è –º–∞–∫—Ä–æ—Å–∞ <span class="hljs-type"><span class="hljs-type">ZVAL_COPY_VALUE</span></span>() <span class="hljs-symbol"><span class="hljs-symbol">#ifndef</span></span> <span class="hljs-type"><span class="hljs-type">ZEND_DEBUG</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ZEND_DEBUG</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#endif</span></span> //—Ç—É—Ç –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏ —Ç–æ–≥–æ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–∞—à–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"php.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"php_ini.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_types.h"</span></span> //<span class="hljs-type"><span class="hljs-type">ZVAL_COPY_VALUE</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"ext/standard/info.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_API.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_modules.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"zend_string.h"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> <span class="hljs-comment"><span class="hljs-comment">"spprintf.h"</span></span> extern zend_module_entry libtrie_module_entry; ...</code> </pre><br></div></div><br>  If everything is done correctly, the clion checker will show a yellow or green square in the upper right corner, which means that there are no critical errors. <br><br><img src="https://habrastorage.org/webt/pt/gm/sa/ptgmsa8nlhkn1gs_ykyc8igavao.png"><br><br><h4>  A small theoretical retreat </h4><br>  For the normal operation of the expansion you need 2 things: <br><br><ol><li>  It is necessary to initialize the special structure zend_module_entry, which contains the following: <br><br><pre> <code class="hljs ruby">zend_module_entry libtrie_module_entry = { STANDARD_MODULE_HEADER, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ <span class="hljs-string"><span class="hljs-string">"libtrie"</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>–Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è libtrie_functions, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>–Ω–∞–∑–≤–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è PHP_MINIT(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>—Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞–µ–º–∞—è –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è PHP_MSHUTDOWN(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>—Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ PHP_RINIT(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">/* Replace with NULL if there's nothing to do at request start */</span></span> PHP_RSHUTDOWN(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">/* Replace with NULL if there's nothing to do at request end */</span></span> PHP_MINFO(libtrie), <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>–≤–∏–¥–∏–º–æ —Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å php –≤ phpinfo() PHP_LIBTRIE_VERSION, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>–≤–µ—Ä—Å–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–º —Ñ–∞–π–ª–µ STANDARD_MODULE_PROPERTIES /<span class="hljs-regexp"><span class="hljs-regexp">/–Ω–µ –∑–Ω–∞—é —á—Ç–æ —ç—Ç–æ };</span></span></code> </pre><br></li><li>  Initialize the same array that contains all the functions of our extension. <br><br>  Here, through a special macro wrapper PHP_FE (), the names of all functions in our extension are specified.  In general, macros are very actively used in PHP, there are a lot of such macros that simply refer to other macros, and those in turn are further.  It is necessary to get used to this.  You can figure out if you go through the macros via ctrl + click.  Here just clion is irreplaceable. <br><br>  Remember the proto file?  We set there 1 function my_array_fill ().  So now we have 3 elements here: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zend_function_entry libtrie_functions[] = { PHP_FE(confirm_libtrie_compiled, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* For testing, remove later. */</span></span> PHP_FE(my_array_fill, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) PHP_FE_END <span class="hljs-comment"><span class="hljs-comment">/* Must be the last line in libtrie_functions[] */</span></span> };</code> </pre><br>  The first line is a test function that will indicate that the extension is working, the second is our function, the third is a special macro that should be the last in this array. <br></li></ol><br>  Find our function: <br><br><pre> <code class="hljs lisp">PHP_FUNCTION(<span class="hljs-name"><span class="hljs-name">my_array_fill</span></span>)</code> </pre><br>  As you can see, it is also initialized through a macro.  The thing is that all php functions do not return anything (to be exact, they return void) inside C, and their arguments cannot be changed.  Somewhere it is even convenient. <br><br>  If you look at the file structure (part of the window on the left), all the functions of the file are listed here, but in the form in which they will be after precompiling macros.  The screenshot shows that our function my_array_fill will actually be zif_my_array_fill. <br><br><img src="https://habrastorage.org/webt/ur/cl/m4/urclm4yrxdayv7heohr0puutrm8.png"><br><br>  Arguments from the depths of php to our C function we get a macro.  More information about this macro can be found in the file: <br><br><pre> <code class="bash hljs">/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/src/php-7.2.11/README.PARAMETER_PARSING_API</code> </pre><br>  Below is the code of our analog function with detailed explanations. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="hljs ruby">PHP_FUNCTION(my_array_fill) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>—Å–Ω–∞—á–∞–ª–∞ –æ–±—ä—è–≤–ª—è–µ–º –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º —Ç—É—Ç –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è /<span class="hljs-regexp"><span class="hljs-regexp">/–≤ –ª—é–±—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è 2 –∞—Ä–≥—É–º–µ–Ω—Ç–∞: /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/—É–∫–∞–∑–∞—Ç–µ–ª–∏ zend_execute_data *execute_data, zval *return_value /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/—á–µ—Ä–µ–∑ –ø–µ—Ä–≤—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –∞ —á–µ—Ä–µ–∑ –≤—Ç–æ—Ä–æ–π –æ—Ç–¥–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/zend_long —ç—Ç–æ int64_t –Ω–∞ x64 —Å–∏—Å—Ç–µ–º–∞—Ö –∏ int32_t –Ω–∞ x86 —Å–∏—Å—Ç–µ–º–∞—Ö /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/—á–∏—Å–ª–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏—é —Å —Ç–∏–ø–æ–º zend_long zend_long start_index; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/1 –∞—Ä–≥—É–º–µ–Ω—Ç —á–∏—Å–ª–æ, zend_long num; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/2 —Ç–æ–∂–µ —á–∏—Å–ª–æ zval *value; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–ø–æ—Å–∫–æ–ª—å–∫—É —É –Ω–∞—Å mixed —Ç–∏–ø, —Ç–æ –±–µ—Ä–µ–º zval, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –ª—é–±–æ–π —Ç–∏–ø /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–ø–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Ç—É—Ç —Å—Ä–∞–∑—É –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ç–∏–ø –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ if (zend_parse_parameters(ZEND_NUM_ARGS(), "llz", &amp;start_index, &amp;num, &amp;value) == FAILURE) { /</span></span>*–Ω–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–≤–æ–¥—è—Ç * –ø–æ—ç—Ç–æ–º—É –≤—Å–µ –º–∞–∫—Ä–æ—Å—ã RETURN<span class="hljs-number"><span class="hljs-number">_</span></span> –ø—Ä–æ—Å—Ç–æ –ø–∏—à—É—Ç –≤ * return_value —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Ñ—É–Ω–∫—Ü–∏—é *<span class="hljs-regexp"><span class="hljs-regexp">/ RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–ø—Ä–æ–≤–æ–¥–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Ç–æ—Ä–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞, –≥–¥–µ –∑–∞–¥–∞–µ—Ç—Å—è –∫–æ–ª-–≤–æ –≤—ã–≤–æ–¥–∏–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞ if (num &lt;= 0) { php_error_docref(NULL TSRMLS_CC, E_WARNING, "argument 2 must be &gt; 0"); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–æ—á–µ—Ä–µ–¥–Ω–æ–π –º–∞–∫—Ä–æ—Å –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–∫–∏ RETURN_FALSE; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/zval *return_value —É–∂–µ –µ—Å—Ç—å, –ø–æ—ç—Ç–æ–º—É —Å—Ä–∞–∑—É –≤ –Ω–µ–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/—ç—Ç–æ—Ç –º–∞–∫—Ä–æ—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥–µ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ zval, –≤ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞–¥–æ —Å–¥–µ–ª–∞—Ç—å –º–∞—Å—Å–∏–≤, –∏ –∫–æ–ª-–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–ø—Ä–∏–≤–æ–¥–∏–º —Ç–∏–ø –∏–∑ zend_long –≤ unsigned int32. /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ –†–∞–∑–º–µ—Ä –∫–ª—é—á–µ–π –º–∞—Å—Å–∏–≤–∞ –ø–µ—Ä–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ + –∫–æ–ª-–≤–æ. –¢.–µ. –µ—Å–ª–∏ –ø–µ—Ä–≤–æ–µ 1, –∞ –Ω–∞–¥–æ –≤—Å–µ–≥–æ 3, —Ç–æ –º–∞—Å—Å–∏–≤ –±—É–¥–µ—Ç –∏–∑ 4 —ç–ª–µ–º–µ–Ω—Ç–æ–≤ array_init_size(return_value, (uint32_t)(start_index + num)); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–¥–æ–±–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Ü–∏–∫–ª, –Ω–∞—á–∏–Ω–∞—è —Å –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ, –∑–∞–∫–∞–Ω—á–∏–≤–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏–º for(zend_long i = start_index, last = start_index + num; i &lt; last; ++i) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/–∫–æ–ø–∏—Ä—É–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞—à–µ–≥–æ zval —Å–æ –≤—Ö–æ–¥–∞ –≤ –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ add_index_zval(return_value, i, value); } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/—Ñ—É–Ω–∫—Ü–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç, –∞ –º–∞—Å—Å–∏–≤ —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –≤ return_value return; }</span></span></code> </pre><br></div></div><br><br><br><h2>  Build and test extensions </h2><br>  First, run phpize, which will make us the configure file. <br><br><pre> <code class="bash hljs">phpize</code> </pre><br>  Now run ./configure, which will make the makefile. <br><br><pre> <code class="bash hljs">./configure</code> </pre><br>  Finally, run make, which will build us our extension. <br><br><pre> <code class="bash hljs">make</code> </pre><br>  Check out what we did. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –Ω–∞—à php, –ø–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–∞—à–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ # modules. –ö–ª—é—á -a –∑–∞—Å—Ç–∞–≤–∏—Ç php —Ä–∞–±–æ—Ç—å –≤ —Ä–µ–∂–∏–º–µ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ php -d extension=modules/libtrie.so -a</span></span></code> </pre><br>  Enter in php console: <br><br><pre> <code class="php hljs">print_r(my_array_fill(<span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"hello, baby!"</span></span>));</code> </pre><br>  Enjoying the result. <br><br><img src="https://habrastorage.org/webt/gn/sx/cy/gnsxcy1ihjtn6tgm7mpqjsz9hl4.png"><br><br>  Someone will ask, but where is the trie?  I will write about functions implementing trie in the second part. <br><br>  <b>Stay tuned.</b> </div><p>Source: <a href="https://habr.com/ru/post/428626/">https://habr.com/ru/post/428626/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>