<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write chat bot for VKontakte on python using longpoll</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now bots have become commonplace and are at every turn, but if you need your bot on the social network vkontakte, then it is easy to implement. 

 We ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write chat bot for VKontakte on python using longpoll</h1><div class="post__text post__text-html js-mediator-article">  Now bots have become commonplace and are at every turn, but if you need your bot on the social network vkontakte, then it is easy to implement. <br><br>  We will need: <br><br><ol><li>  <a href="https://www.python.org/">Python</a> </li><li>  <a href="https://github.com/python273/vk_api">VK Api</a> </li><li>  A wish </li></ol><a name="habracut"></a><br><h3>  Well, quite straight for beginners </h3><br><div class="spoiler">  <b class="spoiler_title">How to install Python?</b> <div class="spoiler_text">  <a href="https://www.python.org/">Download</a> , run the installer. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Where to write this code?</b> <div class="spoiler_text">  To a text document with a .py extension <br></div></div><br><div class="spoiler">  <b class="spoiler_title">And what to write?</b> <div class="spoiler_text">  Yes, even a notebook.  I personally recommend <a href="https://notepad-plus-plus.org/download/">Notepad ++</a> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">How to run?</b> <div class="spoiler_text"> Through the command line. <br> <code>python –ø—É—Ç—å –¥–æ –ø–∞–ø–∫–∏ —Å —Ñ–∞–π–ª–æ–º\—Ñ–∞–π–ª.py</code> <br> </div></div><br><h3>  How does it work? </h3><br>  It's very simple, in vk api there is such a thing, called <a href="https://vk.com/dev/using_longpoll">longpool</a> , it works like this: <blockquote>  Long Polling is a technology that allows you to receive data about new events using the "long requests".  The server receives the request, but sends a response to it not immediately, but only when a certain event occurs (for example, a new message arrives), or the specified timeout expires. </blockquote>  Speaking Russian, we send a request to the server, and he, in turn, pokes at VKontakte if something happens there, for example, a message comes to us and he runs and tells us about it.  From this and we will dance. <br><br><h4>  Technical implementation </h4><br>  First of all, we need to prove to Vkontakte that we are us, and not anyone else.  This is done very simply. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk_api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests session = requests.Session() login, password = <span class="hljs-string"><span class="hljs-string">'–í–∞—à –ª–æ–≥–∏–Ω, email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω'</span></span>, <span class="hljs-string"><span class="hljs-string">'–í–∞—à –ø–∞—Ä–æ–ª—å'</span></span> vk_session = vk_api.VkApi(login, password) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: vk_session.auth(token_only=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> vk_api.AuthError <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> error_msg: print(error_msg) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span></code> </pre> <br>  Remark, guys from VK recommend using a phone number as a login because  otherwise, you can run into an anti-robot check, the one where you are asked to enter the missing digits from the phone number. <br><br>  If the bot will sit in a group, then the authorization looks different. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> vk_api vk_session = vk_api.VkApi(token=<span class="hljs-string"><span class="hljs-string">'—Ç–æ–∫–µ–Ω —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º –∏ —Ñ–æ—Ç–æ'</span></span>)</code> </pre> <br><br>  - What is a token? <br>  - Such a thing from tsiferok and letters that you need to get in the settings of the group.  To do this, simply open the ‚ÄúCommunity Management‚Äù section (‚ÄúManage the Page‚Äù if you have a public page), select the ‚ÄúWork with API‚Äù tab and click ‚ÄúCreate Access Key‚Äù. <br><br>  Now we call longpool. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> vk_api.longpoll <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VkLongPoll, VkEventType longpoll = VkLongPoll(vk_session) vk = vk_session.get_api() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> event <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> longpoll.listen(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> event.type == VkEventType.MESSAGE_NEW <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> event.to_me <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> event.text: <span class="hljs-comment"><span class="hljs-comment">#–°–ª—É—à–∞–µ–º longpoll, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ: if event.text == '–ü–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ñ—Ä–∞–∑—ã' or event.text == '–í—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —Ñ—Ä–∞–∑—ã': #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –∑–∞–¥–∞–Ω–Ω—É—é —Ñ—Ä–∞–∑—É if event.from_user: #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ –õ–° vk.messages.send( #–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ user_id=event.user_id, message='–í–∞—à —Ç–µ–∫—Å—Ç' ) elif event.from_chat: #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ –ë–µ—Å–µ–¥–µ vk.messages.send( #–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—â–µ–Ω–∏–µ chat_id=event.chat_id, message='–í–∞—à —Ç–µ–∫—Å—Ç' )</span></span></code> </pre><br>  Messages can be not only the text you specify.  For example: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime vk.messages.send( user_id=event.user_id, message=<span class="hljs-string"><span class="hljs-string">'–ú–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è: '</span></span> + str(now.strftime(<span class="hljs-string"><span class="hljs-string">"%H:%M"</span></span>)) )</code> </pre> <br>  And you can attach pictures. <br><br><pre> <code class="python hljs">attachments = [] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> vk_api <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VkUpload upload = VkUpload(vk_session) image_url = <span class="hljs-string"><span class="hljs-string">'–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É'</span></span> image = session.get(image_url, stream=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) photo = upload.photo_messages(photos=image.raw)[<span class="hljs-number"><span class="hljs-number">0</span></span>] attachments.append( <span class="hljs-string"><span class="hljs-string">'photo{}_{}'</span></span>.format(photo[<span class="hljs-string"><span class="hljs-string">'owner_id'</span></span>], photo[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]) ) vk.messages.send( user_id=event.user_id, attachment=<span class="hljs-string"><span class="hljs-string">','</span></span>.join(attachments), message=<span class="hljs-string"><span class="hljs-string">'–í–∞—à —Ç–µ–∫—Å—Ç'</span></span> )</code> </pre> <br>  You can come up with many more interesting things, but then think for yourself, and I just say that: links can be divided into parts.  For example: <br><br><pre> <code class="python hljs">image_url = <span class="hljs-string"><span class="hljs-string">'http://—Å–∞–π—Ç.com/uploads/'</span></span> + event.text + <span class="hljs-string"><span class="hljs-string">'.png'</span></span></code> </pre> <br>  and no one forbade us to receive a response from the user on the example of Wikipedia: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wikipedia <span class="hljs-comment"><span class="hljs-comment">#–ú–æ–¥—É–ª—å –í–∏–∫–∏–ø–µ–¥–∏–∏ wikipedia.set_lang("RU") if event.text == '–í–∏–∫–∏–ø–µ–¥–∏—è' or event.text == '–í–∏–∫–∏' or event.text == '–≤–∏–∫–∏–ø–µ–¥–∏—è' or event.text == '–≤–∏–∫–∏' or event.text == 'Wikipedia' or event.text == 'wikipedia' or event.text == 'Wiki' or event.text == 'wiki': #–µ—Å–ª–∏ –Ω–∞–º –ø—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–º –í–∏–∫–∏–ø–µ–¥–∏—è –∏–ª–∏ –í–∏–∫–∏ –∏–ª–∏ ... –∏–ª–∏ wiki if event.from_user: #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ KC vk.messages.send( user_id=event.user_id, message='–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å' #–ü–∏—à–µ–º "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å" ) elif event.from_chat: #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ –±–µ—Å–µ–¥–µ vk.messages.send( chat_id=event.chat_id, message='–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å' #–ü–∏—à–µ–º "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å" ) for event in longpoll.listen(): if event.type == VkEventType.MESSAGE_NEW and event.to_me and event.text: #–ü–∏–Ω–∞–µ–º longpoll if event.from_user: vk.messages.send( #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ –õ–° user_id=event.user_id, message='–í–æ—Ç —á—Ç–æ —è –Ω–∞—à—ë–ª: \n' + str(wikipedia.summary(event.text)) #–ü–∏—à–µ–º "–í–æ—Ç —á—Ç–æ —è –Ω–∞—à—ë–ª" –ò —Ç–æ —á—Ç–æ –≤–µ—Ä–Ω—ë—Ç –Ω–∞–º api Wikipedia –ø–æ –∑–∞–ø—Ä–æ—Å—É —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ) break #–≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ elif event.from_chat: #–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ –±–µ—Å–µ–¥–µ vk.messages.send( chat_id=event.chat_id, message='–í–æ—Ç —á—Ç–æ —è –Ω–∞—à—ë–ª: \n' + str(wikipedia.summary(event.text)) #–ü–∏—à–µ–º "–í–æ—Ç —á—Ç–æ —è –Ω–∞—à—ë–ª" –ò —Ç–æ —á—Ç–æ –≤–µ—Ä–Ω—ë—Ç –Ω–∞–º api Wikipedia –ø–æ –∑–∞–ø—Ä–æ—Å—É —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è ) break #–≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ continue</span></span></code> </pre> <br><h3>  Links to examples and documentation </h3><br>  <a href="https://github.com/python273/vk_api/blob/master/examples/messages_bot/user_messages_bot.py">An example of a bot working on DuckDuckGo api</a> <br>  <a href="https://github.com/python273/vk_api/tree/master/examples">Examples of using VK api (common)</a> <br>  Documentation on VK api <a href="https://vk-api.readthedocs.io/en/latest/">One</a> , <a href="https://vk.com/dev/manuals">Two</a> <br><br>  At this I say goodbye to you.  Good coding. </div><p>Source: <a href="https://habr.com/ru/post/428507/">https://habr.com/ru/post/428507/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>