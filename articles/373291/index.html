<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Error handling nested interrupts in STM8 (not described in errata)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The STM8 family has a very useful opportunity to save energy when fast and time-critical processing is performed on interrupts, while low-priority tas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Error handling nested interrupts in STM8 (not described in errata)</h1><div class="post__text post__text-html js-mediator-article">  The STM8 family has a very useful opportunity to save energy when fast and time-critical processing is performed on interrupts, while low-priority tasks run in the background.  To do this, use the AL bit in the GCR register and the WFI machine command.  However, an underwater stone was discovered here that is not described in the current version of <a href="http://www.st.com/en/microcontrollers/stm8l152c6.html">errata</a> on crystal. <br><a name="habracut"></a><br>  This problem was detected on the stm8l152c6t6 crystal installed on the STM8L-Discovery board. <br>  In the main process, the TIM4 timer was initialized for interrupt operation.  The interrupt handler for it is almost empty (well, except for the procedure for resetting the TIM_SR1_UIF bit in the TIM4-&gt; SR1 register).  Further, the main process allowed writing to the EEPROM by unlocking the MASS and initiating the byte writing procedure with the generation of the IRQ after it was completed.  Then in the GCR register the AL bit was set and the WFI command was executed. <br>  In the interrupt handler, upon completion of a write operation in the EEPROM, after reading the contents of the FLASH-&gt; IAPSR, the priority of the executed code is reduced by the RIM command or the PUSH # val / POP CC combination.  Those.  within the EEPROM ISR, all other interrupts are enabled.  And the following was discovered: if the EEPROM ISR was interrupted by another interrupt, then after returning from a nested interrupt, the EEPROM processing of the ISR stops (that is, the impression that the CPU core switches to the WFI state performed by the main process). <br>  This error occurs only when the following conditions exist: <br><ol><li>  Before running WFI in the main process, the AL bit in the GCR register was set </li><li>  The priority of EEPROM IRQ is left by default (i.e. the contents of the register ITC-&gt; ISPR1 is 0xFF) </li></ol><br><br>  Possible workarounds: <br><ol><li>  In the main process, before executing the WFI instruction, clear the AL bit in the GCR.  In this case, after each interruption, the main process will resume its execution, which does not have a very good impact on energy consumption. </li><li>  Before lowering the priority inside the ISR EEPROM (i.e. before the RIM or PUSH # val / POP CC commands), also reset the AL bit in the GCR.  Again, in this case, after the completion of the EEPROM ISR, the main process will continue its execution, which will not have a very good impact on energy consumption. </li><li>  Change the priority of the EEPROM IRQ in the ITC-&gt; ISPR1 register, for example, by writing the value 0b11110111 to it.  What is most incomprehensible, after that, the RIM or PUSH # val / POP CC commands start working inside the EEPROM ISR (that is, after returning from the nested interrupt, the EEPROM processing of the ISR resumes). </li></ol><br><br>  Gentlemen, who have the desire / opportunity, try to reproduce this bug on other crystals of the STM8 / STM8L family.  For if this bug is truly reproducible, then it is necessary to kick the STM in order to fix it or at least include it in the errata sheet. <br><br>  Received an official response from the ST MCU Support Team: <br><blockquote>  SOLUTION PROPOSED BY SUPPORTER - 5/4/2017 15:52:59: <br>  - Dear customer, <br><br>  If you‚Äôre trying to complete the process, you‚Äôll have to go ahead. <br><br>  I recommend to use SW rather than using RIM in the interrupt routine. <br><br>  Best regards, <br>  ST MCU Support Team <br></blockquote></div><p>Source: <a href="https://habr.com/ru/post/373291/">https://habr.com/ru/post/373291/</a></p>
<section class="all-articles-navigation-panel js-all-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>