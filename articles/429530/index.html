<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mono Stacking Machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago on Habr√© there was an excellent and inspiring article about compilers and stack machines. It shows the path from a simple implementati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Mono Stacking Machine</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/hy/th/re/hythree7x7e9oozopoozh9lijw4.png"></div><br><p>  Not so long ago on Habr√© there was an excellent and inspiring <a href="https://habr.com/company/badoo/blog/428878/">article</a> about compilers and stack machines.  It shows the path from a simple implementation of the bytecode artist to more and more efficient versions.  I wanted to show, using the example of the development of a stack machine, how to do this in Haskell-way. </p><br><p>  Using the example of language interpretation for a stack machine, we will see how the mathematical concept of semigroups and monoids helps to develop and expand the program architecture, how one can use mono algebra, and how one can build programs in the form of a set of homomorphisms between algebraic systems.  As working examples, we first build an interpreter that is inseparable from the code in the form of an EDSL, and then we will teach it different things: record arbitrary debugging information, separate the program code from the program itself, carry out a simple static analysis and calculate with different effects. </p><br><p>  The article is intended for those who speak Haskell at an average level and above, for those who already use it in work or research, and for all curious people who have looked at what it is that the functionals have yet realized.  Well, for those, of course, who did not scare the previous paragraph. </p><a name="habracut"></a><br><p>  There was a lot of material, with a lot of examples in the code, and in order to make it easier for the reader to understand whether he needs to dive into it, I‚Äôll give an annotated content. </p><br><div class="spoiler">  <b class="spoiler_title">The content of the article</b> <div class="spoiler_text"><ul><li>  <a href="https://habr.com/ru/post/429530/">Languages ‚Äã‚Äãand programs for stack machines.</a>  <em>We consider the structural features of the languages ‚Äã‚Äãof stack machines that can be used to implement the interpreter.</em> </li><li>  <a href="https://habr.com/ru/post/429530/">Build a car.</a>  <em>The interpreter code for a stack machine with memory, based on transformation monoids, is more or less detailed.</em> </li><li>  <a href="https://habr.com/ru/post/429530/">We combine monoids.</a>  <em>With the help of the algebra of monoids, we add to the interpreter a log of calculations, with almost arbitrary types of records.</em> </li><li>  <a href="https://habr.com/ru/post/429530/">Programs and their codes.</a>  <em>We build an isomorphism between the program and its code, which makes it possible to operate with them separately.</em> </li><li>  <a href="https://habr.com/ru/post/429530/">Release of the monoid.</a>  <em>New homomophysms from programs to other structures are used for formatted listing, static analysis and code optimization.</em> </li><li>  <a href="https://habr.com/ru/post/429530/">From monoids to monads and again to monoids.</a>  <em>We construct homomorphisms into the elements of the Kleisli category, which open up the possibility of using monads.</em>  <em>We extend the interpreter with I / O commands and ambiguous calculations.</em> </li></ul></div></div><br><p>  The tasks of translation and interpretation present many interesting and useful examples to demonstrate various aspects of programming.  They allow you to move to different levels of complexity and abstraction, while remaining quite practical.  In this article, we will focus on demonstrating the capabilities of two important mathematical structures - a <em>semigroup</em> and a <em>monoid</em> .  They are not so often discussed as monads or lenses, and they are not afraid of little programmers, these structures are much easier to understand, but with all that, they are the basis of functional programming.  Masterly mastery of monoidal types, which is demonstrated by professionals, is admired by the simplicity and elegance of solutions. </p><br><p>  The search for the word "monoid" for articles on Habr√© produces no more than four dozen articles (about the same monads, for example, there are three hundred of them).  All of them conceptually start with something like: a <em>monoid is such a lot ...</em> and then, with quite understandable delight, list what is a monoid - from lines to finger trees, from regular expression parsers to <a href="https://www.listal.com/list/one-eyed">God knows what else</a> !  But in practice we think in reverse order: we have an object that needs to be modeled, we analyze its properties and find that it possesses the characteristics of an abstract structure, decide whether we need consequences from this circumstance and how we use it.  We will go this way.  And at the same time we will add a couple of interesting examples to the collection of useful monoids. </p><br><a name="ch1"></a><br><h3 id="yazyki-i-programmy-dlya-stekovyh-mashin">  Languages ‚Äã‚Äãand programs for stack machines </h3><br><p>  Stack machines, when studying functional programming, usually appear at the moment when they approach the concept of convolution.  In this case, an extremely laconic implementation of the performer of the simplest stack calculator is given, for example, this: </p><br><div class="spoiler">  <b class="spoiler_title">Simple Stack Calculator</b> <div class="spoiler_text"><pre><code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">calc</span></span> :: <span class="hljs-type"><span class="hljs-type">String</span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">Int</span></span>] calc = interpretor . lexer <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> lexer = words interpretor = foldl (flip interprete) [] interprete c = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-string"><span class="hljs-string">"add"</span></span> -&gt; binary $ \(x:y:s) -&gt; x + y:s <span class="hljs-string"><span class="hljs-string">"mul"</span></span> -&gt; binary $ \(x:y:s) -&gt; x * y:s <span class="hljs-string"><span class="hljs-string">"sub"</span></span> -&gt; binary $ \(x:y:s) -&gt; y - x:s <span class="hljs-string"><span class="hljs-string">"div"</span></span> -&gt; binary $ \(x:y:s) -&gt; y `div` x:s <span class="hljs-string"><span class="hljs-string">"pop"</span></span> -&gt; unary $ \(x:s) -&gt; s <span class="hljs-string"><span class="hljs-string">"dup"</span></span> -&gt; unary $ \(x:s) -&gt; x:x:s x -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> readMaybe x <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">Just</span></span> n -&gt; \s -&gt; n:s <span class="hljs-type"><span class="hljs-type">Nothing</span></span> -&gt; error $ <span class="hljs-string"><span class="hljs-string">"Error: unknown command "</span></span> ++ c <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> unary fs = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> x:_ -&gt; fs _ -&gt; error $ <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> ++ c ++ <span class="hljs-string"><span class="hljs-string">" expected an argument."</span></span> binary fs = <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> x:y:_ -&gt; fs _ -&gt; error $ <span class="hljs-string"><span class="hljs-string">"Error: "</span></span> ++ c ++ <span class="hljs-string"><span class="hljs-string">" expected two arguments."</span></span></code> </pre> <br><p>  This uses the total <code>readMaybe</code> parser from the <code>Text.Read</code> module.  It would be possible to bring the program two times shorter, but already without informative error messages, and this is ugly. </p></div></div><br><p>  Great start to talk!  Then, as a rule, they begin to <code>foldM</code> effects: change the <code>foldl</code> fold to <code>foldM</code> , provide a totality through the <code>Either String</code> monad, then add logging, wrapping everything with a <code>StateT</code> transformer, embed a <code>StateT</code> dictionary with the help of <code>StateT</code> , and so on.  Sometimes, to demonstrate the coolness of monadic calculations, an ambiguous calculator is implemented, which returns all possible values ‚Äã‚Äãof the expression <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-1"><span class="MJXp-mo" id="MJXp-Span-2" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font></span><span class="MJXp-mn" id="MJXp-Span-3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><font style="vertical-align: inherit;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-5"><font style="vertical-align: inherit;">p </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-6"><font style="vertical-align: inherit;">m </font></span><span class="MJXp-mn" id="MJXp-Span-7"><font style="vertical-align: inherit;">3 </font></span><span class="MJXp-mo" id="MJXp-Span-8" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;">) </font></span><span class="MJXp-mo" id="MJXp-Span-9" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;">‚àó </font></span><span class="MJXp-mo" id="MJXp-Span-10" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;">( </font></span><span class="MJXp-mo" id="MJXp-Span-11" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;">( </font></span><span class="MJXp-mn" id="MJXp-Span-12"><font style="vertical-align: inherit;">4 </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-14"><font style="vertical-align: inherit;">p </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15"><font style="vertical-align: inherit;">m </font></span><span class="MJXp-mn" id="MJXp-Span-16"><font style="vertical-align: inherit;">8 </font></span><span class="MJXp-mo" id="MJXp-Span-17" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;">) </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19"><font style="vertical-align: inherit;">p </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-20"><font style="vertical-align: inherit;">m </font></span><span class="MJXp-mn" id="MJXp-Span-21"><font style="vertical-align: inherit;">5 </font></span><span class="MJXp-mo" id="MJXp-Span-22" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;">)</font></span></font><span class="MJXp-mtext" id="MJXp-Span-4">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-5"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-6"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mn" id="MJXp-Span-7"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mo" id="MJXp-Span-8" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mo" id="MJXp-Span-9" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mo" id="MJXp-Span-10" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mo" id="MJXp-Span-11" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mn" id="MJXp-Span-12"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mtext" id="MJXp-Span-13">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-14"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mn" id="MJXp-Span-16"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mo" id="MJXp-Span-17" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mtext" id="MJXp-Span-18">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-20"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mn" id="MJXp-Span-21"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mo" id="MJXp-Span-22" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"></font></span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.806ex" height="2.66ex" viewBox="0 -832 10680.4 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-28" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-32" x="389" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="1140" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6D" x="1643" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-33" x="2522" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-29" x="3022" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-2217" x="3634" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-28" x="4356" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-28" x="4746" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-34" x="5135" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="5886" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6D" x="6389" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-38" x="7268" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-29" x="7768" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="8408" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6D" x="8911" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-35" x="9790" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-29" x="10290" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-1"> (2 \ pm 3) * ((4 \ pm 8) \ pm 5) </script>  .  This is a long, good and interesting conversation.  However, we will immediately lead our story differently, although we will end it with the same result. </p><br><p>  Why, in general, is it about convolution?  Because convolution (cathamorphism) is an <em>abstraction of sequential processing of inductive data</em> .  A stack machine runs linearly through the code, following a sequence of instructions and generating one value ‚Äî the state of the stack.  I like to imagine the work of a convolutional stack machine as a translation of messenger RNA in a living cell.  The ribosome, step by step, goes through the entire RNA chain, compares the nucleotide triplets with amino acids and <a href="https://youtu.be/8dsTvBaUMvw">creates the</a> primary structure of the protein. </p><br><p>  The convolutional machine has a number of limitations, the main one is that the program is always read from beginning to end and once.  Branching, loops, and subroutine calls require a conceptual change to the interpreter.  Nothing complicated, of course, but such a machine can no longer be described by a simple convolution. </p><br><p>  According to the hypothesis of linguistic relativity, the properties of the language we use directly affect the properties of our thinking.  Let's pay attention not to the machine, but to the <em>languages</em> and <em>programs</em> by which it is controlled. </p><br><p>  All stack-oriented languages, both relatively low-level (bytecodes of Java and Python or .NET virtual machines), and languages ‚Äã‚Äãat a higher level (PostScript, Forth or Joy), have one fundamental common feature: if you write two successively correct programs, then get the correct program.  True, correct does not mean "correct", this program may crash on any data or fall into infinite loops and generally does not make sense, but the main thing is that such a program can be executed by a machine.  At the same time, breaking the correct program into parts, we can easily reuse these parts, precisely because of their correctness.  Finally, in any stack language, you can select a subset of commands that operate only on the internal state of the machine (stack or registers) that do not use any external memory.  This subset will form a language with the property of <em>concatenatability</em> .  In such a language, any program has the meaning of a state machine transducer, and the sequential execution of programs is equivalent to their composition, which means it is also a state transformer. </p><br><p>  The general pattern is viewed: the combination (concatenation) of the correct programs generates the correct program, the combination of transducers generates the transducer.  It turns out that the stack language programs are <em>closed with respect to the operation of concatenation</em> or form a structure called <em>groupoid</em> or <abbr title="A magma is a set M with a binary operation (‚ãÑ) defined on it, such that for any elements of the set a and b it is true that a ‚ãÑ b ‚àà M."><em>magma</em></abbr> .  This means that, writing a program on a tape, it is possible to cut it almost haphazardly and then form new programs from the obtained segments.  And you can cut up to segments with a single instruction. </p><br><p>  When gluing important order.  For example, these two programs are undoubtedly different: </p><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-23"><span class="MJXp-mtext" id="MJXp-Span-24">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-25"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-26"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-27"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-28"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-29"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-30"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mrow" id="MJXp-Span-31"><span class="MJXp-mn" id="MJXp-Span-32"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5 </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-33"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-34"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">u </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-35"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-36"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-37"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-38"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">p</font></font></span></span><font style="vertical-align: inherit;"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40"><font style="vertical-align: inherit;"> n </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-41"><font style="vertical-align: inherit;">e </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-42"><font style="vertical-align: inherit;">q </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-44"><font style="vertical-align: inherit;">t </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-45"><font style="vertical-align: inherit;">e </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-46"><font style="vertical-align: inherit;">x </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-47"><font style="vertical-align: inherit;">t </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-48"><font style="vertical-align: inherit;">t </font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-49"><font style="vertical-align: inherit;">t </font></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mn" id="MJXp-Span-51"><font style="vertical-align: inherit;">5 </font></span></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-52"><font style="vertical-align: inherit;">p </font></span></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-53"><font style="vertical-align: inherit;">o </font></span></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-54"><font style="vertical-align: inherit;">p </font></span></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-55"><font style="vertical-align: inherit;">d </font></span></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-56"><font style="vertical-align: inherit;">u </font></span></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-57"><font style="vertical-align: inherit;">p</font></span></span><span class="MJXp-mo" id="MJXp-Span-58" style="margin-left: 0em; margin-right: 0.222em;"><font style="vertical-align: inherit;"> .</font></span></font><span class="MJXp-mtext" id="MJXp-Span-39">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-40"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-41"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-42"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mtext" id="MJXp-Span-43">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-44"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-45"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-46"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-47"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-48"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-49"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mrow" id="MJXp-Span-50"><span class="MJXp-mn" id="MJXp-Span-51"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-52"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-53"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-54"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-55"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-56"><font style="vertical-align: inherit;"></font></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-57"><font style="vertical-align: inherit;"></font></span></span><span class="MJXp-mo" id="MJXp-Span-58" style="margin-left: 0em; margin-right: 0.222em;"><font style="vertical-align: inherit;"></font></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.168ex" height="2.419ex" viewBox="0 -780.1 14711 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="611" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-78" x="1078" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="1650" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="2012" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="2373" y="0"></use><g transform="translate(2735,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-35" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-64" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-75" x="1024" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="1596" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="2100" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6F" x="2603" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="3089" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6E" x="6577" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="7178" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-71" x="7644" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="8355" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="8716" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-78" x="9183" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="9755" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="10117" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="10478" y="0"></use><g transform="translate(10840,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-35" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6F" x="1004" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="1489" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-64" x="1993" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-75" x="2516" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="3089" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-2E" x="14432" y="0"></use></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-2"> \ texttt {5 dup pop} \ neq \ texttt {5 pop dup}. </script></p><br>  But it doesn‚Äôt matter where we cut the program, if we merge it here in this place: <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-59"><span class="MJXp-mo" id="MJXp-Span-60" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mtext" id="MJXp-Span-61">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-62">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-63">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-64">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-65">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-66">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-67">t</span><span class="MJXp-mrow" id="MJXp-Span-68"><span class="MJXp-mn" id="MJXp-Span-69">5</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-70">d</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-71">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-72">p</span></span><span class="MJXp-mo" id="MJXp-Span-73" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-74" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mtext" id="MJXp-Span-75">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-76">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-77">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-78">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-79">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-80">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-81">t</span><span class="MJXp-mrow" id="MJXp-Span-82"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-83">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-84">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-85">p</span></span><span class="MJXp-mo" id="MJXp-Span-86" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mtext" id="MJXp-Span-87">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-88">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-89">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-90">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-91">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-92">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-93">t</span><span class="MJXp-mrow" id="MJXp-Span-94"><span class="MJXp-mn" id="MJXp-Span-95">5</span></span><span class="MJXp-mo" id="MJXp-Span-96" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-mo" id="MJXp-Span-97" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mtext" id="MJXp-Span-98">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-99">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-100">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-101">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-102">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-103">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-104">t</span><span class="MJXp-mrow" id="MJXp-Span-105"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-106">d</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-107">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-108">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-109">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-110">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-111">p</span></span><span class="MJXp-mo" id="MJXp-Span-112" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-113" style="margin-left: 0em; margin-right: 0.222em;">.</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processed" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="55.142ex" height="2.66ex" viewBox="0 -832 23741.4 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-28" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="639" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-78" x="1467" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="2040" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="2401" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="2763" y="0"></use><g transform="translate(3124,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-35" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-64" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-75" x="1024" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="1596" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-29" x="5224" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-2B" x="5836" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="7086" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="7448" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-78" x="7914" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="8487" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="8848" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="9210" y="0"></use><g transform="translate(9571,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6F" x="503" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="989" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-3D" x="11342" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="12648" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="13010" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-78" x="13476" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="14049" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="14410" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="14772" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-35" x="15133" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-2B" x="15856" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-28" x="16856" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="17496" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-65" x="17857" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-78" x="18324" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="18896" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="19258" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-74" x="19619" y="0"></use><g transform="translate(19981,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-64" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-75" x="523" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="1096" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="1599" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-6F" x="2103" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMATHI-70" x="2588" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-29" x="23073" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/429530/&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgc2cdGvM3tAPHSNwd4MddrCMGw2w#MJMAIN-2E" x="23462" y="0"></use></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-3"> (\ texttt {5 dup}) + \ texttt {pop} = \ texttt {5} + (\ texttt {dup pop}). </script></p><br>  This simple circumstance reflects the <em>associativity of the</em> concatenation operation and takes the structure that the stack programs form to a new level, we understand that this is a <abbr title="A semigroup is a magma with an operation (‚ãÑ), such that for any elements of the set a, b and c it is true that (a ‚ãÑ b) ‚ãÑ c = a (b c)."><em>semigroup</em></abbr> . <br><p>  And what does this give us, as programmers?  Associativity allows you to precompile, optimize and even parallelize arbitrary suitable segments of the program, and then combine them into an equivalent program.  We can afford to carry out a static analysis of any segment of the program and use it in the analysis of the entire program precisely because we do not care where to put the brackets.  These are very important and serious opportunities for a low-level language or an intermediate language in which not a person writes, but a translator.  And from the point of view of a mathematician and an experienced functionary, this makes the state-transformer programs of the state of the machine complete <abbr title="Endomorphism is a mapping of a set into itself. In the narrow sense, this is a function of type a ‚Üí a."><em>endomorphisms</em></abbr> .  Endomorphisms also form a semigroup with the operation of composition.  In algebra, such endomorphisms are called <em>transformation semigroups</em> with respect to some set.  For example, finite automata form a transformation semigroup of a set of states. </p><br><p>  "Semigroup" sounds half-heartedly, somehow defective.  Maybe stack programs form a <abbr title="A group is a set closed with respect to an associative binary operation, and for this operation there is a neutral element, and each element of the set has an inverse."><em>group</em></abbr> ?  E ... no, most programs are irreversible, that is, it will not work out by the result of the execution to unambiguously restore the original data.  But we have a neutral element.  In assembly languages, it is denoted <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-114"><span class="MJXp-mtext" id="MJXp-Span-115">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-116">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-117">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-118">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-119">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-120">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-121">t</span><span class="MJXp-mrow" id="MJXp-Span-122"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-123">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-124">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-125">p</span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-4"> \ texttt {nop} </script>  and does nothing.  If in the stack language such an operator is not explicitly defined, then it can be easily obtained by combining some commands, for example: <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-126"><span class="MJXp-mtext" id="MJXp-Span-127">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-128">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-129">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-130">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-131">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-132">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-133">t</span><span class="MJXp-mrow" id="MJXp-Span-134"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-135">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-136">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-137">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-138">d</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-139">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-140">c</span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-5"> \ texttt {inc dec} </script>  , <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-141"><span class="MJXp-mtext" id="MJXp-Span-142">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-143">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-144">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-145">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-146">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-147">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-148">t</span><span class="MJXp-mrow" id="MJXp-Span-149"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-150">d</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-151">u</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-152">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-153">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-154">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-155">p</span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-6"> \ texttt {dup pop} </script>  or <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-156"><span class="MJXp-mtext" id="MJXp-Span-157">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-158">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-159">e</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-160">x</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-161">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-162">t</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-163">t</span><span class="MJXp-mrow" id="MJXp-Span-164"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-165">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-166">w</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-167">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-168">p</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-169">s</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-170">w</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-171">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-172">p</span></span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-7-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-7"> \ texttt {swap swap} </script>  .  Such pairs can be painlessly cut from programs or, on the contrary, inserted anywhere in any number.  Since there is a unit, our programs form a <em>semigroup with a unit</em> or a <abbr title="A monoid is a semigroup with an operation (‚ãÑ), and a neutral element i, such that for any element a, it is true that a ‚ãÑ i = i a = a."><em>monoid</em></abbr> .  So, you can programmatically implement them in the form of monoids - endomorphisms over the state of the stack machine.  This will allow you to define a small set of basic operations for the machine, and then create programs using their composition, getting a stack language in the form of an embedded domain-oriented language (EDSL). </p><br><p>  In Haskell, semigroups and monoids are described using the <code>Semigroup</code> and <code>Monoid</code> .  Their definitions are simple and reflect only the basic structure, the requirements of associativity and neutrality have to be checked by the programmer: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> a </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> (&lt;&gt;) :: a -&gt; a -&gt; a <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">Semigroup</span></span> a =&gt; <span class="hljs-type"><span class="hljs-type">Monoid</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> mempty :: a</code> </pre> <br><a name="ch2"></a><br><h3 id="stroim-mashinu">  Build a car </h3><br><div class="spoiler">  <b class="spoiler_title">Header of the program</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-meta"><span class="hljs-meta">{-# LANGUAGE LambdaCase, GeneralizedNewtypeDeriving #-}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Semigroup (<span class="hljs-type"><span class="hljs-type">Max(..)</span></span>,<span class="hljs-title"><span class="hljs-title">stimes</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Monoid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Vector ((//),(!),Vector) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">qualified</span></span> Data.Vector <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V (<span class="hljs-title"><span class="hljs-title">replicate</span></span>)</code> </pre> </div></div><br><p>  We will immediately build a machine that has a stack, a finite memory, and can crash in an amicable, clean way.  We implement all this without the use of monads, encapsulating the necessary data in the type describing the machine.  Thus, all the basic programs, and therefore all their combinations, will be pure converters of its state. </p><br><p>  We start by defining the type for the virtual machine and the trivial setter functions. </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stack</span></span></span><span class="hljs-class"> = [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Memory</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Vector</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Processor</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> memSize = 4 </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stack</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Maybe</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Memory</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Show</span></span></span><span class="hljs-class"> emptyVM = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> mempty mempty (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">replicate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memSize</span></span></span><span class="hljs-class"> 0) setStack :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stack</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Processor</span></span></span><span class="hljs-class"> setStack x (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sm</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> xsm setStatus :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Maybe</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Processor</span></span></span><span class="hljs-class"> setStatus x (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> sxm setMemory :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Memory</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Processor</span></span></span><span class="hljs-class"> setMemory x (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">st</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> s st x</span></span></code> </pre> <br><p>  Setters are needed to make the semantics of the program explicit.  Under the processor (type <code>Processor</code> ) we will understand the converter <code>VM -&gt; VM</code> . </p><br><p>  Now we define the wrapper types for the transformation monoid and for the program: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Action</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> <span class="hljs-type"><span class="hljs-type">Action</span></span> f &lt;&gt; <span class="hljs-type"><span class="hljs-type">Action</span></span> g = <span class="hljs-type"><span class="hljs-type">Action</span></span> (g . f) <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> <span class="hljs-type"><span class="hljs-type">Monoid</span></span> (<span class="hljs-type"><span class="hljs-type">Action</span></span> a) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> mempty = <span class="hljs-type"><span class="hljs-type">Action</span></span> id <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">newtype</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getProgram</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Action</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Monoid</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  Wrapping types define the principle of combining programs: these are endomorphisms with the reverse order of the composition (from left to right).  Using wrappers allows the compiler to independently determine how the type <code>Program</code> implements the requirements of the <code>Semigroup</code> and <code>Monoid</code> . </p><br><p>  Performer programs are trivial: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">run</span></span> :: <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Processor</span></span> run = runAction . getProgram exec :: <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">VM</span></span> exec prog = run prog emptyVM</code> </pre> <br><p>  The error message will form the <code>err</code> function: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">err</span></span> :: <span class="hljs-type"><span class="hljs-type">String</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Processor</span></span> err = setStatus . <span class="hljs-type"><span class="hljs-type">Just</span></span> $ <span class="hljs-string"><span class="hljs-string">"Error! "</span></span> ++ m</code> </pre> <br><p>  We use the <code>Maybe</code> type differently than it is used normally: empty <code>Nothing</code> in the status means that nothing dangerous happens, and the calculations can be continued, in turn, the string value marks problems.  For convenience, we define two smart constructors: one for programs that work only with the stack, the other for those who need memory. </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">program</span></span> :: (<span class="hljs-type"><span class="hljs-type">Stack</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Processor</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> program f = <span class="hljs-type"><span class="hljs-type">Program</span></span> . <span class="hljs-type"><span class="hljs-type">Action</span></span> $ \vm -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> status vm <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">Nothing</span></span> -&gt; f (stack vm) vm _ -&gt; vm programM :: ((<span class="hljs-type"><span class="hljs-type">Memory</span></span>, <span class="hljs-type"><span class="hljs-type">Stack</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Processor</span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> programM f = <span class="hljs-type"><span class="hljs-type">Program</span></span> . <span class="hljs-type"><span class="hljs-type">Action</span></span> $ \vm -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> status vm <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">Nothing</span></span> -&gt; f (memory vm, stack vm) vm _ -&gt; vm</code> </pre> <br><p>  Now you can define basic language commands for working with the stack and memory, integer arithmetic, as well as equivalence and order relations. </p><br><div class="spoiler">  <b class="spoiler_title">Work with stack</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">pop</span></span> = program $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; setStack s _ -&gt; err <span class="hljs-string"><span class="hljs-string">"pop expected an argument."</span></span> push x = program $ \s -&gt; setStack (x:s) dup = program $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; setStack (x:x:s) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"dup expected an argument."</span></span> swap = program $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:y:s -&gt; setStack (y:x:s) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"swap expected two arguments."</span></span> exch = program $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:y:s -&gt; setStack (y:x:y:s) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"exch expected two arguments."</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Work with memory</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-comment"><span class="hljs-comment">-- –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –∏–Ω–¥–µ–∫—Å–æ–º indexed if = programM $ if (i &lt; 0 || i &gt;= memSize) then const $ err $ "expected index in within 0 and " ++ show memSize else f put i = indexed i $ \case (m, x:s) -&gt; setStack s . setMemory (m // [(i,x)]) _ -&gt; err "put expected an argument" get i = indexed i $ \(m, s) -&gt; setStack ((m ! i) : s)</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Arithmetic operations and relationships</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">unary</span></span> nf = program $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; setStack (fx:s) _ -&gt; err $ <span class="hljs-string"><span class="hljs-string">"operation "</span></span> ++ show n ++ <span class="hljs-string"><span class="hljs-string">" expected an argument"</span></span> binary nf = program $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:y:s -&gt; setStack (fxy:s) _ -&gt; err $ <span class="hljs-string"><span class="hljs-string">"operation "</span></span> ++ show n ++ <span class="hljs-string"><span class="hljs-string">" expected two arguments"</span></span> add = binary <span class="hljs-string"><span class="hljs-string">"add"</span></span> (+) sub = binary <span class="hljs-string"><span class="hljs-string">"sub"</span></span> (flip (-)) mul = binary <span class="hljs-string"><span class="hljs-string">"mul"</span></span> (*) frac = binary <span class="hljs-string"><span class="hljs-string">"frac"</span></span> (flip div) modulo = binary <span class="hljs-string"><span class="hljs-string">"modulo"</span></span> (flip mod) neg = unary <span class="hljs-string"><span class="hljs-string">"neg"</span></span> (\x -&gt; -x) inc = unary <span class="hljs-string"><span class="hljs-string">"inc"</span></span> (\x -&gt; x+<span class="hljs-number"><span class="hljs-number">1</span></span>) dec = unary <span class="hljs-string"><span class="hljs-string">"dec"</span></span> (\x -&gt; x<span class="hljs-number"><span class="hljs-number">-1</span></span>) eq = binary <span class="hljs-string"><span class="hljs-string">"eq"</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) neq = binary <span class="hljs-string"><span class="hljs-string">"neq"</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x /= y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) lt = binary <span class="hljs-string"><span class="hljs-string">"lt"</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &gt; y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) gt = binary <span class="hljs-string"><span class="hljs-string">"gt"</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> </div></div><br><p>  To complete the work is not enough branching and cycles.  In fact, for a built-in language, only branching is sufficient, cycles can be organized using recursion in the host language (in Haskell), but we will make our language self-sufficient.  In addition, we use the fact that the programs form a semigroup and define a combinator of program repetition a specified number of times.  The number of repetitions he will take from the stack. </p><br><div class="spoiler">  <b class="spoiler_title">Branching and loops</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">branch</span></span> :: <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> branch br1 br2 = program go <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go (x:s) = proceed (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x /= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> br1 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> br2) s go _ = err <span class="hljs-string"><span class="hljs-string">"branch expected an argument."</span></span> while :: <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> while test body = program (const go) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go vm = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = proceed test (stack vm) vm <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (stack res) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:s -&gt; proceed mempty s res _:s -&gt; go $ proceed body s res _ -&gt; err <span class="hljs-string"><span class="hljs-string">"while expected an argument."</span></span> vm rep :: <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Program</span></span> rep body = program go <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go (n:s) = proceed (stimes n body) s go _ = err <span class="hljs-string"><span class="hljs-string">"rep expected an argument."</span></span> proceed :: <span class="hljs-type"><span class="hljs-type">Program</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Stack</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Processor</span></span> proceed prog s = run prog . setStack s</code> </pre> </div></div><br><p>  The types of functions <code>branch</code> and <code>while</code> say that these are not stand-alone programs, but program combinators: a typical approach when creating an EDSL in Haskell.  The <code>stimes</code> function <code>stimes</code> defined for all semigroups, it returns the composition of the specified number of elements. </p><br><p>  Finally, we will write several programs for experiments. </p><br><div class="spoiler">  <b class="spoiler_title">Examples of programs</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-comment"><span class="hljs-comment">-- —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª fact = dup &lt;&gt; push 2 &lt;&gt; lt &lt;&gt; branch (push 1) (dup &lt;&gt; dec &lt;&gt; fact) &lt;&gt; mul -- –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª fact1 = push 1 &lt;&gt; swap &lt;&gt; while (dup &lt;&gt; push 1 &lt;&gt; gt) ( swap &lt;&gt; exch &lt;&gt; mul &lt;&gt; swap &lt;&gt; dec ) &lt;&gt; pop -- –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å—Ç–µ–∫ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —á–∏—Å–µ–ª -- –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ range = exch &lt;&gt; sub &lt;&gt; rep (dup &lt;&gt; inc) -- –µ—â—ë –æ–¥–∏–Ω –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª, -- –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ —Å–≤—ë—Ä—Ç–∫—É —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥ fact2 = mconcat [ dec, push 2, swap, range, push 3, sub, rep mul] -- –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏ fact3 = dup &lt;&gt; put 0 &lt;&gt; dup &lt;&gt; dec &lt;&gt; rep (dec &lt;&gt; dup &lt;&gt; get 0 &lt;&gt; mul &lt;&gt; put 0) &lt;&gt; get 0 &lt;&gt; swap &lt;&gt; pop -- –∫–æ–ø–∏—Ä—É–µ—Ç –¥–≤–∞ –≤–µ—Ä—Ö–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–∞ —Å—Ç–µ–∫–∞ copy2 = exch &lt;&gt; exch -- –≤—ã—á–∏—Å–ª—è–µ—Ç –Ω–∞–∏–±–æ–ª—å—à–∏–π –æ–±—â–∏–π –¥–µ–ª–∏—Ç–µ–ª—å -- –ø–æ –ø—Ä–æ—Å—Ç–µ–π—à–µ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É –ï–≤–∫–ª–∏–¥–∞ gcd1 = while (copy2 &lt;&gt; neq) ( copy2 &lt;&gt; lt &lt;&gt; branch mempty (swap) &lt;&gt; exch &lt;&gt; sub ) &lt;&gt; pop -- –≤–æ–∑–≤–µ–¥–µ–Ω–∏–µ –≤ —Å—Ç–µ–ø–µ–Ω—å –º–µ—Ç–æ–¥–æ–º —Ä—É—Å—Å–∫–æ–≥–æ –∫—Ä–µ—Å—Ç—å—è–Ω–∏–Ω–∞ pow = swap &lt;&gt; put 0 &lt;&gt; push 1 &lt;&gt; put 1 &lt;&gt; while (dup &lt;&gt; push 0 &lt;&gt; gt) ( dup &lt;&gt; push 2 &lt;&gt; modulo &lt;&gt; branch (dec &lt;&gt; get 0 &lt;&gt; dup &lt;&gt; get 1 &lt;&gt; mul &lt;&gt; put 1) (get 0) &lt;&gt; dup &lt;&gt; mul &lt;&gt; put 0 &lt;&gt; push 2 &lt;&gt; frac ) &lt;&gt; pop &lt;&gt; get 1</span></span></code> </pre></div></div><br><p>  It turned out 120 lines of code with comments and annotations of types that define a machine operating with 18 teams with three combinators.  This is how our car works. </p><br><pre> <code class="haskell hljs">Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">6</span></span> &lt;&gt; fact) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">720</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]} Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">6</span></span> &lt;&gt; fact3) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">720</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">720</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]} Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">2</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">6</span></span> &lt;&gt; range) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]} Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">6</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">9</span></span> &lt;&gt; gcd1) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">3</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]} Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">15</span></span> &lt;&gt; pow) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">14348907</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">43046721</span></span>,<span class="hljs-number"><span class="hljs-number">14348907</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]} Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">9</span></span> &lt;&gt; add) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">9</span></span>], status = <span class="hljs-type"><span class="hljs-type">Just</span></span> <span class="hljs-string"><span class="hljs-string">"Error! add expected two arguments"</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]}</code> </pre> <br><p>  In fact, we have not done anything new - by combining transformers-endomorphisms, we essentially returned to the convolution, but it became implicit.  Recall that a convolution gives an abstraction of sequential processing of inductive data.  Data, in our case, is formed in an inductive way when pasting programs by the operator <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-173"><span class="MJXp-mtext" id="MJXp-Span-174">&nbsp;</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-175">d</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-176">i</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-177">a</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-178">m</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-179">o</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-180">n</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-181">d</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-8-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-8"> \ diamond </script>  , and they are ‚Äústored‚Äù in endomorphism in the form of a chain of compositions of functions of machine transformers until this chain is applied to the initial state.  In the case of the use of combinators <code>branch</code> and <code>while</code> chain begins to turn into a tree or into a cycle.  In the general case, we get a graph that reflects the operation of the automaton with the store memory, that is, the stack machine.  It is this structure that we "turn off" during the execution of the program. </p><br><p>  How effective is this implementation?  The composition of functions is the best that the Haskell compiler can do.  He is literally born for this!  When it comes to the benefits of using knowledge of monoids, often give an example of <code>diffList</code> difference lists - the implementation of a linked list in the form of a composition of endomorphisms.  Difference lists fundamentally accelerate the formation of lists of many pieces due to the associativity of the composition of functions.  Fussing with wrapper types does not lead to an increase in overhead costs, they "dissolve" at the compilation stage.  Of the extra work there is only a state check at each step of the program execution. </p><br><a name="ch3"></a><br><h3 id="kombiniruem-monoidy">  We combine monoids </h3><br><p>  I think by this point skeptics and casual readers have already left us, you can afford to relax and go to the next level of abstraction. </p><br><p>  The concept of semigroups and monoids would not be so useful and universal, if not for a number of properties inherent in all semigroups and monoids without exception, which allow us to construct complex structures from simple structures in exactly the same way as we build complex programs from simple ones.  These properties are no longer related to objects, but to types and are best written not in mathematical notation, but in the form of Haskell programs, which, due to the Curry-Howard isomorphism, are their proofs. </p><br><p>  1) Monoids and semigroups can be ‚Äúmultiplied‚Äù.  What is meant here is a product of types whose abstraction in Haskell is a tuple or a pair. </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b</span></span></span><span class="hljs-class">) =&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> (a1, b1) &lt;&gt; (a2, b2) = (a1 &lt;&gt; a2, b1 &lt;&gt; b2) <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> (<span class="hljs-type"><span class="hljs-type">Monoid</span></span> a, <span class="hljs-type"><span class="hljs-type">Monoid</span></span> b) =&gt; <span class="hljs-type"><span class="hljs-type">Monoid</span></span> (a,b) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> mempty = (mempty, mempty )</code> </pre> <br><p>  2) There is a single monoid, it is represented by a single type <code>()</code> : </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> () </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> () &lt;&gt; () = () <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> <span class="hljs-type"><span class="hljs-type">Monoid</span></span> () <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> mempty = ()</code> </pre> <br><p>  With the multiplication operation, the semigroups themselves form a semigroup, and taking into account the unit type, we can say that monoids form a monoid!  The associativity and neutrality of the unit is fulfilled up to isomorphism, but this is not critical. </p><br><p>  3) Mappings into a semigroup or monoid form, respectively, a semigroup or monoid.  And here, too, it is easier to write this statement in Haskell: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">instance</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> a =&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">r</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">where</span></span></span></span> f &lt;&gt; g = \r -&gt; fr &lt;&gt; gr <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span> <span class="hljs-type"><span class="hljs-type">Monoid</span></span> a =&gt; <span class="hljs-type"><span class="hljs-type">Monoid</span></span> (r -&gt; a) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> mempty = const mempty</code> </pre> <br><p>  We use these combinators to expand the capabilities of the stack language we have constructed.  Let's make a major change and make our basic commands <em>functions that return programs</em> .  This will not deprive them of their monoidal properties, but it will allow them to input arbitrary information from the outside into the work of all machine commands.  This is what is meant: </p><br><pre> <code class="haskell hljs">(command1 &lt;&gt; command2) r == command1 r &lt;&gt; command2 r</code> </pre> <br><p>  Information can be any, for example, an external dictionary with some definitions, or a way to keep a journal of calculations, necessary for debugging.  This is very similar to the action of the <code>Reader</code> monad, which is just a function. </p><br><p>  We will enter a log into the structure of the machine, but we will not bind it to any particular type, but will output it into a type parameter.  We will write to the journal with the help of a generalized monoidal operation. </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> a = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stack</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">status</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Maybe</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Memory</span></span></span><span class="hljs-class"> , </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">journal</span></span></span><span class="hljs-class"> :: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Show</span></span></span><span class="hljs-class"> mkVM = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> mempty mempty (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">replicate</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memSize</span></span></span><span class="hljs-class"> 0) setStack x (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">st</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ml</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> x st ml setStatus st (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ml</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> s st ml setMemory m (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">st</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">l</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> s st ml addRecord x (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">st</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mj</span></span></span><span class="hljs-class">) = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> s st m (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">&lt;&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">j</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">newtype</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> a = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getProgram</span></span></span><span class="hljs-class"> :: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Action</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Monoid</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program'</span></span></span><span class="hljs-class"> a = (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> a</span></span></code> </pre> <br><p>  From this point on, we allow ourselves not to specify the type annotations for all definitions, leaving the compiler to deal with them on their own, they are not complicated, although they become cumbersome.  The teams themselves will not have to change, thanks to smart designers who will take over all the changes.  Very small. </p><br><div class="spoiler">  <b class="spoiler_title">New designers and combinators.</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">program</span></span> fp = <span class="hljs-type"><span class="hljs-type">Program</span></span> . <span class="hljs-type"><span class="hljs-type">Action</span></span> $ \vm -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> status vm <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">Nothing</span></span> -&gt; p . (f (stack vm)) $ vm m -&gt; vm programM fp = <span class="hljs-type"><span class="hljs-type">Program</span></span> . <span class="hljs-type"><span class="hljs-type">Action</span></span> $ \vm -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> status vm <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-type"><span class="hljs-type">Nothing</span></span> -&gt; p . (f (memory vm, stack vm)) $ vm m -&gt; vm proceed p prog s = run (prog p) . setStack s rep body p = program go id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go (n:s) = proceed p (stimes n body) s go _ = err <span class="hljs-string"><span class="hljs-string">"rep expected an argument."</span></span> branch br1 br2 p = program go id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go (x:s) = proceed p (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x /= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> br1 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> br2) s go _ = err <span class="hljs-string"><span class="hljs-string">"branch expected an argument."</span></span> while test body p = program (const go) id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go vm = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = proceed p test (stack vm) vm <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (stack res) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:s -&gt; proceed p mempty s res _:s -&gt; go $ proceed p body s res _ -&gt; err <span class="hljs-string"><span class="hljs-string">"while expected an argument."</span></span> vm</code> </pre> </div></div><br><p>  It remains to learn to enter external information in the programmer.  This is very easy to do by creating different artists with a different journaling strategy.  The first performer will be the most simple, silent, not wasting his time on keeping a journal: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">exec</span></span> prog = run (prog id) (mkVM ())</code> </pre> <br><p>  Here a single monoid <code>()</code> is useful to us - a neutral element in the algebra of monoids.  Further, you can define a function for the executor, who is ready to record some information about the state of the machine in the log. </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">execLog</span></span> p prog = run (prog $ \vm -&gt; addRecord (p vm) vm) (mkVM mempty)</code> </pre> <br><p>  Information may be, for example, such: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">logStack</span></span> vm = [stack vm] logStackUsed = <span class="hljs-type"><span class="hljs-type">Max</span></span> . length . stack logSteps = const (<span class="hljs-type"><span class="hljs-type">Sum</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) logMemoryUsed = <span class="hljs-type"><span class="hljs-type">Max</span></span> . getSum . count . memory <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> count = foldMap (\x -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç—É: </p><br><pre> <code class="haskell hljs">Œª&gt; exec (push <span class="hljs-number"><span class="hljs-number">4</span></span> &lt;&gt; fact2) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">24</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>], journal = ()} Œª&gt; journal $ execLog logSteps (push <span class="hljs-number"><span class="hljs-number">4</span></span> &lt;&gt; fact2) <span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">14</span></span>} Œª&gt; mapM_ print $ reverse $ journal $ execLog logStack (push <span class="hljs-number"><span class="hljs-number">4</span></span> &lt;&gt; fact2) [<span class="hljs-number"><span class="hljs-number">4</span></span>] [<span class="hljs-number"><span class="hljs-number">3</span></span>] [<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>] [<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] [<span class="hljs-number"><span class="hljs-number">24</span></span>]</code> </pre> <br><p> –õ–æ–≥–≥–µ—Ä—ã –º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å, –ø–æ–ª—å–∑—É—è—Å—å —Ç–µ–º –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–æ–º, —á—Ç–æ –º–æ–Ω–æ–∏–¥—ã –ø–µ—Ä–µ–º–Ω–æ–∂–∞—é—Ç—Å—è. –í–≤–µ–¥—ë–º –ø—Ä–æ—Å—Ç–æ–π –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä –¥–ª—è –ª–æ–≥–≥–µ—Ä–æ–≤: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">f</span></span> &amp;&amp;&amp; g = \r -&gt; (fr, gr)</code> </pre> <br><p> –¢–∞–∫ –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —á–µ—Ç—ã—Ä—ë—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–∞ –ø–æ —á–∏—Å–ª—É —à–∞–≥–æ–≤ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω–µ —Å—Ç–µ–∫–∞ </p><br><pre> <code class="haskell hljs">Œª&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> report p = journal $ execLog (logSteps &amp;&amp;&amp; logStackUsed) p Œª&gt; report (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; fact) (<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">48</span></span>},<span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">10</span></span>}) Œª&gt; report (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; fact1) (<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">63</span></span>},<span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">4</span></span>}) Œª&gt; report (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; fact2) (<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">26</span></span>},<span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">9</span></span>}) Œª&gt; report (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; fact3) (<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">43</span></span>},<span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">3</span></span>})</code> </pre> <br><p> –õ–æ–≥–≥–µ—Ä—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –æ–±—ä—è–≤–∏—Ç—å –º–æ–Ω–æ–∏–¥–æ–º —Å –æ–ø–µ—Ä–∞—Ü–∏–µ–π <code>&amp;&amp;&amp;</code> , –µ—Å–ª–∏ –±—ã –æ–Ω–∏ –≤—Å–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–∏–ø. –ù–æ —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Ä–∞–∑–Ω—ã–µ, Haskell —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç. –¢–∞–∫ —á—Ç–æ –Ω–µ –≤—Å—ë, —á—Ç–æ –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç—Å—è —è–≤–ª—è–µ—Ç—Å—è —Ä–∞–±–æ—Ç–∞—é—â–∏–º –º–æ–Ω–æ–∏–¥–æ–º. </p><br><a name="ch4"></a><br><h3 id="programmy-i-ih-kody"> –ü—Ä–æ–≥—Ä–∞–º–º—ã –∏ –∏—Ö –∫–æ–¥—ã </h3><br><p> –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö –∫–æ–º–∞–Ω–¥–∞—Ö. –ù–æ –Ω–∞—à–∏ –∫–æ–º–∞–Ω–¥—ã ‚Äî —ç—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, —É –Ω–∏—Ö –Ω–µ—Ç –∏–º–µ–Ω–∏ –≤–Ω–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º—ë–Ω Haskell. –ò —Ç—É—Ç –º—ã –ø—Ä–∏—Ö–æ–¥–∏–º –∫ –∫—Ä–∞—Å–∏–≤–æ–º—É —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—é. </p><br><p> –ú–æ–∂–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∂–¥–æ–π –±–∞–∑–æ–≤–æ–π –∫–æ–º–∞–Ω–¥–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥, –≤ —Ç–æ –∂–µ –≤—Ä–µ–º—è, –º–æ–∂–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥—É ‚Äî –∫–æ–º–∞–Ω–¥—É. –û–±–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ, –∞ –∑–Ω–∞—á–∏—Ç: –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–æ–º–∞–Ω–¥ –∏ –∏–º—ë–Ω <em>–∏–∑–æ–º–æ—Ä—Ñ–Ω—ã</em> . –ü—Ä–æ–≥—Ä–∞–º–º—ã (–∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥) –æ–±—Ä–∞–∑—É—é—Ç –º–æ–Ω–æ–∏–¥, –∏ —Ç–µ–∫—Å—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–æ–≤) –æ–±—Ä–∞–∑—É—é—Ç –º–æ–Ω–æ–∏–¥. –ú—ã –∏ –Ω–∞—á–∏–Ω–∞–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å —Ç–æ–≥–æ, —á—Ç–æ —Ä–∞–∑—Ä–µ–∑–∞–ª–∏ –∏ —Å–∫–ª–µ–∏–≤–∞–ª–∏ –∏–º–µ–Ω–Ω–æ <em>—Ç–µ–∫—Å—Ç—ã</em> –ø—Ä–æ–≥—Ä–∞–º–º, –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –Ω–∞ –ª–µ–Ω—Ç–∞—Ö. –ó–Ω–∞—á–∏—Ç –º–µ–∂–¥—É –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –∏ –∏—Ö –∫–æ–¥–∞–º–∏ –º–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä—É –≤–∑–∞–∏–º–Ω–æ-–æ–±—Ä–∞—Ç–Ω—ã—Ö <abbr title="–ì–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º ‚Äî –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ –¥—Ä—É–≥—É—é, —Å–æ—Ö—Ä–∞–Ω—è—é—â–µ–µ –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –í –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ, f —è–≤–ª—è–µ—Ç—Å—è –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º–æ–º, –µ—Å–ª–∏ f(a ‚ãÑ b) = f(a) ‚ãÑ f(b)  –∏ –µ—Å–ª–∏ i ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ, —Ç–æ f(i) –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–º –∏ –≤ –¥—Ä—É–≥–æ–π."><em>–≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º–æ–≤</em></abbr> . </p><br><p> –î–∞–≤–∞–π—Ç–µ –∂–µ –ø–æ—Å—Ç—Ä–æ–∏–º —ç—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è! –û–ø—Ä–µ–¥–µ–ª–∏–º —Å–Ω–∞—á–∞–ª–∞ —Ç–∏–ø –¥–ª—è –∫–æ–¥–æ–≤ –Ω–∞—à–µ–≥–æ —è–∑—ã–∫–∞: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IF</span></span></span><span class="hljs-class"> [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class">] [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class">] | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">REP</span></span></span><span class="hljs-class"> [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class">] | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WHILE</span></span></span><span class="hljs-class"> [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class">] [</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class">] | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PUT</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GET</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PUSH</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Int</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">POP</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DUP</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SWAP</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EXCH</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">INC</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DEC</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NEG</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ADD</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MUL</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SUB</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DIV</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EQL</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LTH</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GTH</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NEQ</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Read</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Show</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p> –¢–µ–ø–µ—Ä—å –ø–æ—Å—Ç—Ä–æ–∏–º –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º –∫–æ–¥ <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-182"><span class="MJXp-mo" id="MJXp-Span-183" style="margin-left: 0.333em; margin-right: 0.333em;">‚Üí</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-9-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-9">\rightarrow</script> –ø—Ä–æ–≥—Ä–∞–º–º–∞: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">fromCode</span></span> :: [<span class="hljs-type"><span class="hljs-type">Code</span></span>] -&gt; <span class="hljs-type"><span class="hljs-type">Program'</span></span> a fromCode = hom <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> hom = foldMap $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">IF</span></span> b1 b2 -&gt; branch (hom b1) (hom b2) <span class="hljs-type"><span class="hljs-type">REP</span></span> p -&gt; rep (hom p) <span class="hljs-type"><span class="hljs-type">WHILE</span></span> tb -&gt; while (hom t) (hom b) <span class="hljs-type"><span class="hljs-type">PUT</span></span> i -&gt; put i <span class="hljs-type"><span class="hljs-type">GET</span></span> i -&gt; get i <span class="hljs-type"><span class="hljs-type">PUSH</span></span> i -&gt; push i <span class="hljs-type"><span class="hljs-type">POP</span></span> -&gt; pop <span class="hljs-type"><span class="hljs-type">DUP</span></span> -&gt; dup <span class="hljs-type"><span class="hljs-type">SWAP</span></span> -&gt; swap <span class="hljs-type"><span class="hljs-type">EXCH</span></span> -&gt; exch <span class="hljs-type"><span class="hljs-type">INC</span></span> -&gt; inc <span class="hljs-type"><span class="hljs-type">DEC</span></span> -&gt; dec <span class="hljs-type"><span class="hljs-type">ADD</span></span> -&gt; add <span class="hljs-type"><span class="hljs-type">MUL</span></span> -&gt; mul <span class="hljs-type"><span class="hljs-type">SUB</span></span> -&gt; sub <span class="hljs-type"><span class="hljs-type">DIV</span></span> -&gt; frac <span class="hljs-type"><span class="hljs-type">EQL</span></span> -&gt; eq <span class="hljs-type"><span class="hljs-type">LTH</span></span> -&gt; lt <span class="hljs-type"><span class="hljs-type">GTH</span></span> -&gt; gt <span class="hljs-type"><span class="hljs-type">NEQ</span></span> -&gt; neq <span class="hljs-type"><span class="hljs-type">NEG</span></span> -&gt; neg</code> </pre> <br><p> –ó–¥–µ—Å—å –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ, —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã —è–≤–ª—è—é—Ç—Å—è –º–æ–Ω–æ–∏–¥–∞–º–∏. <code>foldMap</code> —ç—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è —Å–≤—ë—Ä—Ç–∫–∞, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–∞—è –Ω–∞ –º–æ–Ω–æ–∏–¥—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—â–∞—è –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–Ω–æ–∏–¥–∞–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π. –ì–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º <code>fromCode</code> —è–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä–æ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–π –≤ –∫–æ–¥–∞—Ö, –æ–Ω —É–∂–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ç—Ä–∞–Ω—Å–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ –∫–æ–¥–æ–≤ –∏ –¥–∞–∂–µ –≤ –≤–∏–¥–µ —Ç–µ–∫c—Ç–∞: </p><br><pre> <code class="haskell hljs">Œª&gt; stack $ exec (fromCode [<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">EXCH</span></span>, <span class="hljs-type"><span class="hljs-type">SUB</span></span>, <span class="hljs-type"><span class="hljs-type">REP</span></span> [<span class="hljs-type"><span class="hljs-type">DUP</span></span>, <span class="hljs-type"><span class="hljs-type">INC</span></span>]]) [<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>] Œª&gt; stack $ exec (fromCode $ read <span class="hljs-string"><span class="hljs-string">"[PUSH 2, PUSH 5, EXCH, SUB, REP [DUP, INC]]"</span></span>) [<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>]</code> </pre> <br><p> –û–±—Ä–∞—Ç–Ω—ã–π –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º <em>–ø—Ä–æ–≥—Ä–∞–º–º–∞</em> <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-184"><span class="MJXp-mo" id="MJXp-Span-185" style="margin-left: 0.333em; margin-right: 0.333em;">‚Üí</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-10-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-10">\rightarrow</script> <em>–∫–æ–¥</em> –ø–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–∞–∫–∏–º –∂–µ –æ–±—Ä–∞–∑–æ–º –Ω–µ –≤—ã–π–¥–µ—Ç, –ø–æ—Å–∫–æ–ª—å–∫—É –º—ã –Ω–µ –º–æ–∂–µ–º –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å –≤ <code>case</code> —Ñ—É–Ω–∫—Ü–∏–∏. –ù–æ –º–æ–∂–Ω–æ —Å–Ω–æ–≤–∞ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–≤—É–º—è –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω—ã–º–∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏: —Ç–µ–º —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—Ä–∞–∑—É—é—Ç –º–æ–Ω–æ–∏–¥ –∏ —Ç–µ–º —á—Ç–æ –º–æ–Ω–æ–∏–¥—ã –æ–±—Ä–∞–∑—É—é—Ç –ø–æ–ª—É–≥—Ä—É–ø–ø—É! –ü–µ—Ä–µ–º–Ω–æ–∂–∏–º –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ —Ç–∏–ø–∞ <code>Program</code> –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –µ–º—É —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">newtype</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> a = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">getProgram</span></span></span><span class="hljs-class"> :: ([</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class">], </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Action</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">)) } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">deriving</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Monoid</span></span></span><span class="hljs-class">) run = runAction . snd . getProgram</span></span></code> </pre> <br><p> –ù–∞—Ä—è–¥—É —Å –∏—Å–ø–æ–ª–Ω—è—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π <code>run</code> –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –≤–æ—Ç –æ–Ω –≤—Ç–æ—Ä–æ–π –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º, –æ–±—Ä–∞—Ç–Ω—ã–π <code>fromCode</code> : </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">toCode</span></span> :: <span class="hljs-type"><span class="hljs-type">Program'</span></span> a -&gt; [<span class="hljs-type"><span class="hljs-type">Code</span></span>] toCode prog = fst . getProgram $ prog id</code> </pre> <br><p> –¢–µ–ø–µ—Ä—å –æ—Å—Ç–∞—ë—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —É–º–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤ —Ç–∞–∫, —á—Ç–æ–±—ã –∫–∞–∂–¥–æ–π –±–∞–∑–æ–≤–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —É–∫–∞–∑–∞—Ç—å –µ—ë –∫–æ–¥. –í–ø—Ä–æ—á–µ–º, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ —è–∑—ã–∫–∞ –∏–∑–º–µ–Ω—è—Ç—Å—è –Ω–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program'</span></span></span><span class="hljs-class"> a = (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Code</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">) -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> a program cfp = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> . ([</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">],) . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Action</span></span></span><span class="hljs-class"> $ \vm -&gt; case status vm of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Nothing</span></span></span><span class="hljs-class"> -&gt; pc . f (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vm</span></span></span><span class="hljs-class">) $ vm _ -&gt; vm programM cfp = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class"> . ([</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">c</span></span></span><span class="hljs-class">],) . </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Action</span></span></span><span class="hljs-class"> $ \vm -&gt; case status vm of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Nothing</span></span></span><span class="hljs-class"> -&gt; pc . f (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vm</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stack</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vm</span></span></span><span class="hljs-class">) $ vm _ -&gt; vm</span></span></code> </pre> <br><p> –ö–∞–∫ –≤–∏–¥–Ω–æ, —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä—É—é –º—ã –ø–µ—Ä–µ–¥–∞—ë–º –¥–ª—è –≤–µ–¥–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ —Å—Ç–∞–ª–∞ –±–∏–Ω–∞—Ä–Ω–æ–π, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞—Å–ø–æ–ª–∞–≥–∞–µ—Ç –∫–æ–¥–æ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ó–Ω–∞—á–∏—Ç –Ω–∞–¥–æ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–º–µ–Ω—è—Ç—å –ª–æ–≥–≥–µ—Ä—ã, –∞ –∑–∞ –æ–¥–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ª–æ–≥–≥–µ—Ä –¥–ª—è –∫–æ–¥–∞ –∏ –≥–æ–≤–æ—Ä–ª–∏–≤—ã–π –ª–æ–≥–≥–µ—Ä-–æ—Ç–ª–∞–¥—á–∏–∫: </p><br><div class="spoiler"> <b class="spoiler_title">–õ–æ–≥–≥–µ—Ä—ã –∏ –æ—Ç–ª–∞–¥—á–∏–∫</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">none</span></span> = const id exec prog = run (prog none) (mkVM ()) execLog p prog = run (prog $ \c -&gt; \vm -&gt; addRecord (pc vm) vm) (mkVM mempty) logStack _ vm = [stack vm] logStackUsed _ = <span class="hljs-type"><span class="hljs-type">Max</span></span> . length . stack logSteps _ = const (<span class="hljs-type"><span class="hljs-type">Sum</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- –Ω–æ–≤—ã–µ –ª–æ–≥–≥–µ—Ä—ã logCode c _ = [c] logRun com vm = [pad 10 c ++ "| " ++ pad 20 s ++ "| " ++ m] where c = show com m = unwords $ show &lt;$&gt; toList (memory vm) s = unwords $ show &lt;$&gt; stack vm pad nx = take n (x ++ repeat ' ') debug :: Program' [String] -&gt; String debug = unlines . reverse . journal . execLog logRun</span></span></code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä–æ–≤</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">pop</span></span> = program <span class="hljs-type"><span class="hljs-type">POP</span></span> $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; setStack s _ -&gt; err <span class="hljs-string"><span class="hljs-string">"POP expected an argument."</span></span> push x = program (<span class="hljs-type"><span class="hljs-type">PUSH</span></span> x) $ \s -&gt; setStack (x:s) dup = program <span class="hljs-type"><span class="hljs-type">DUP</span></span> $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; setStack (x:x:s) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"DUP expected an argument."</span></span> swap = program <span class="hljs-type"><span class="hljs-type">SWAP</span></span> $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:y:s -&gt; setStack (y:x:s) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"SWAP expected two arguments."</span></span> exch = program <span class="hljs-type"><span class="hljs-type">EXCH</span></span> $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:y:s -&gt; setStack (y:x:y:s) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"EXCH expected two arguments."</span></span> app1 cf = program c $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; setStack (fx:s) _ -&gt; err $ <span class="hljs-string"><span class="hljs-string">"operation "</span></span> ++ show c ++ <span class="hljs-string"><span class="hljs-string">" expected an argument"</span></span> app2 cf = program c $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:y:s -&gt; setStack (fxy:s) _ -&gt; err $ <span class="hljs-string"><span class="hljs-string">"operation "</span></span> ++ show c ++ <span class="hljs-string"><span class="hljs-string">" expected two arguments"</span></span> add = app2 <span class="hljs-type"><span class="hljs-type">ADD</span></span> (+) sub = app2 <span class="hljs-type"><span class="hljs-type">SUB</span></span> (flip (-)) mul = app2 <span class="hljs-type"><span class="hljs-type">MUL</span></span> (*) frac = app2 <span class="hljs-type"><span class="hljs-type">DIV</span></span> (flip div) neg = app1 <span class="hljs-type"><span class="hljs-type">NEG</span></span> (\x -&gt; -x) inc = app1 <span class="hljs-type"><span class="hljs-type">INC</span></span> (\x -&gt; x+<span class="hljs-number"><span class="hljs-number">1</span></span>) dec = app1 <span class="hljs-type"><span class="hljs-type">DEC</span></span> (\x -&gt; x<span class="hljs-number"><span class="hljs-number">-1</span></span>) eq = app2 <span class="hljs-type"><span class="hljs-type">EQL</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) neq = app2 <span class="hljs-type"><span class="hljs-type">NEQ</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x /= y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) lt = app2 <span class="hljs-type"><span class="hljs-type">LTH</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &gt; y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) gt = app2 <span class="hljs-type"><span class="hljs-type">GTH</span></span> (\x -&gt; \y -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x &lt; y) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>) proceed p prog s = run (prog p) . setStack s rep body p = program (<span class="hljs-type"><span class="hljs-type">REP</span></span> (toCode body)) go none <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go (n:s) = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> n &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> proceed p (stimes n body) s <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> err <span class="hljs-string"><span class="hljs-string">"REP expected positive argument."</span></span> go _ = err <span class="hljs-string"><span class="hljs-string">"REP expected an argument."</span></span> branch br1 br2 p = program (<span class="hljs-type"><span class="hljs-type">IF</span></span> (toCode br1) (toCode br2)) go none <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go (x:s) = proceed p (<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x /= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> br1 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> br2) s go _ = err <span class="hljs-string"><span class="hljs-string">"IF expected an argument."</span></span> while test body p = program (<span class="hljs-type"><span class="hljs-type">WHILE</span></span> (toCode test) (toCode body)) (const go) none <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go vm = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> res = proceed p test (stack vm) vm <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (stack res) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:s -&gt; proceed p mempty s res _:s -&gt; go $ proceed p body s res _ -&gt; err <span class="hljs-string"><span class="hljs-string">"WHILE expected an argument."</span></span> vm put i = indexed (<span class="hljs-type"><span class="hljs-type">PUT</span></span> i) i $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (m, x:s) -&gt; setStack s . setMemory (m // [(i,x)]) _ -&gt; err <span class="hljs-string"><span class="hljs-string">"PUT expected an argument"</span></span> get i = indexed (<span class="hljs-type"><span class="hljs-type">GET</span></span> i) i $ \(m, s) -&gt; setStack ((m ! i) : s) indexed cif = programM c $ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || i &gt;= memSize) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> const $ err <span class="hljs-string"><span class="hljs-string">"index in [0,16]"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> f</code> </pre> </div></div><br><p> –í—Å—ë, –∏–∑–æ–º–æ—Ä—Ñ–∏–∑–º –º–µ–∂–¥—É –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏ –∏ –∏—Ö –∫–æ–¥–∞–º–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç. </p><br><p> –í–æ-–ø–µ—Ä–≤—ã—Ö, –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ª—é–±–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã: </p><br><pre> <code class="haskell hljs">Œª&gt; toCode fact1 [<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">WHILE</span></span> [<span class="hljs-type"><span class="hljs-type">DUP</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">GTH</span></span>] [<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">MUL</span></span>,<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">DEC</span></span>],<span class="hljs-type"><span class="hljs-type">POP</span></span>]</code> </pre> <br><p> –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≥—Ä–∞–º–º—ã –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å –ø–æ–º–æ—â—å—é EDSL, –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∏—Ö –≤ —Ñ–∞–π–ª –∏ —Å—á–∏—Ç—ã–≤–∞—Ç—å –∏–∑ –Ω–µ–≥–æ. </p><br><p> –í–æ-–≤—Ç–æ—Ä—ã—Ö, –º–æ–∂–µ–º —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ –¥–≤–∞ –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º–∞ <code>toCode</code> –∏ <code>fromCode</code> —è–≤–ª—è—é—Ç—Å—è –≤–∑–∞–∏–º–æ-–æ–±—Ä–∞—Ç–Ω—ã–º–∏. </p><br><pre> <code class="haskell hljs">Œª&gt; toCode $ fromCode [<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-type"><span class="hljs-type">ADD</span></span>] [<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-type"><span class="hljs-type">ADD</span></span>] Œª&gt; exec (fromCode $ toCode (push <span class="hljs-number"><span class="hljs-number">5</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">6</span></span> &lt;&gt; add)) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">11</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>], journal = ()}</code> </pre> <br><p> –ü—Ä–∞–≤–¥–∞, –Ω–∞—à –∏–∑–æ–º–æ—Ä—Ñ–∏–∑–º –∏–º–µ–µ—Ç –æ–¥–∏–Ω —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫: –æ–Ω –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –∫–æ–Ω–µ—á–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Å –ø–æ–º–æ—â—å—é —è–≤–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤ <code>ghci</code> –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã <code>fact</code> , —Ç–æ–ª—å–∫–æ –¥–µ—Ä–∂–∏—Ç–µ –ø–∞–ª—å—Ü—ã –Ω–∞ –≥–æ—Ç–æ–≤–µ, —á—Ç–æ–±—ã –ø–æ—Å–∫–æ—Ä–µ–µ –Ω–∞–∂–∞—Ç—å <code>Ctrl+C</code> . –ü—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø—Ä–∏–∑–Ω–∞—Ç—å, —á—Ç–æ –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º <code>toCode</code> —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –≤—ã—á–∏—Å–ª–∏–º —á–∞—Å—Ç–∏—á–Ω–æ. </p><br><p> –ù–∞–∫–æ–Ω–µ—Ü, –¥–∞–≤–∞–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –æ—Ç–ª–∞–¥—á–∏–∫, –ø—Ä–∏—á—ë–º, –æ–Ω-—Ç–æ –∫–∞–∫ —Ä–∞–∑ —Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ç–æ–∂–µ: </p><br><pre> <code class="haskell hljs">Œª&gt; putStrLn $ debug (push <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&gt; fact) <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> | <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">LTH</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> | <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DEC</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">LTH</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DEC</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">LTH</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">MUL</span></span> | <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">MUL</span></span> | <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">MUL</span></span> | <span class="hljs-number"><span class="hljs-number">6</span></span> | <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><a name="ch5"></a><br><h3 id="osvobozhdenie-monoida"> –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –º–æ–Ω–æ–∏–¥–∞ </h3><br><p> –ö–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏–º–µ–µ—Ç –≤–∏–¥ –¥–µ—Ä–µ–≤–∞ –∏ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —á–∏—Å—Ç—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≥—Ä–∞–º–º–µ. –ú—ã –ø–æ–ª—É—á–∏–ª–∏ <abbr title="–°–≤–æ–±–æ–¥–Ω–æ–π –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–ª–≥–µ–±—Ä–∞–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º –≤ –ª—é–±—É—é –¥—Ä—É–≥—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É."><em>—Å–≤–æ–±–æ–¥–Ω—É—é –∞–ª–≥–µ–±—Ä—É</em></abbr> –ø—Ä–æ–≥—Ä–∞–º–º –¥–ª—è –Ω–∞—à–µ–π —Å—Ç–µ–∫–æ–≤–æ–π –º–∞—à–∏–Ω—ã. –ë–æ–ª–µ–µ —Ç–æ–≥–æ, –∏ —Å–∞–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã —è–≤–ª—è—é—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏, —Ç–∞–∫ –∫–∞–∫ –º—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –∏–∑–æ–º–æ—Ä—Ñ–∏–∑–º –º–µ–∂–¥—É –∫–æ–¥–æ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º! </p><br><p> –ö—Ä–æ–º–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏, —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —Å–≤–æ–±–æ–¥—É –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏. –ú—ã –ø–æ—Å—Ç—Ä–æ–∏–ª–∏ –ø–æ–∫–∞ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ø–æ—Å–æ–± –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ —Å–≤–æ–±–æ–¥–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Äî –≤ –≤–∏–¥–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–µ–∫–æ–≤–æ–π –º–∞—à–∏–Ω—ã. –ù–æ –∏–º–µ—è –ø—Ä–æ–≥—Ä–∞–º–º—É –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Å –Ω–µ–π —á—Ç–æ —É–≥–æ–¥–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä –æ–±–µ—Å–ø–µ—á–∏–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥, –ø—Ä–æ–≤–æ–¥–∏—Ç—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑. </p><br><p> –û–±—ã—á–Ω–æ, –Ω–∞ —ç—Ç–æ–º –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ–º –ø–∞—Å—Å–∞–∂–µ —Å—Ç–∞—Ç—å—è –ø—Ä–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è: –º–æ–∂–Ω–æ –∏ –º–æ–∂–Ω–æ, –ø—Ä–∞–≤–¥–∞ —Å–ª–æ–∂–Ω–æ –∏ –≤ –æ–¥–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ –Ω–µ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å. –ù–æ —Ç–∞–∫ –≤—ã—à–ª–æ, —á—Ç–æ –Ω–∞—à —è–∑—ã–∫ —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ –ø—Ä–æ—Å—Ç –∏ —á—Ä–µ–∑–≤—ã—á–∞–π–Ω–æ –º–æ–Ω–æ–∏–¥–∞–ª–µ–Ω, –∞ —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–µ–ª–∞—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–µ—â–∏ –æ—á–µ–Ω—å –∏–∑—è—â–Ω–æ. –ì—Ä–µ—Ö —ç—Ç–∏–º –Ω–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏ –Ω–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è! </p><br><p> –í–æ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ª–∏—Å—Ç–∏–Ω–≥ –ø—Ä–æ–≥—Ä–∞–º–º—ã: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">listing</span></span> :: <span class="hljs-type"><span class="hljs-type">Program'</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">String</span></span> listing = unlines . hom <span class="hljs-number"><span class="hljs-number">0</span></span> . toCode <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> hom n = foldMap f <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> f = \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">IF</span></span> b1 b2 -&gt; ouput <span class="hljs-string"><span class="hljs-string">"IF"</span></span> &lt;&gt; indent b1 &lt;&gt; ouput <span class="hljs-string"><span class="hljs-string">":"</span></span> &lt;&gt; indent b2 <span class="hljs-type"><span class="hljs-type">REP</span></span> p -&gt; ouput <span class="hljs-string"><span class="hljs-string">"REP"</span></span> &lt;&gt; indent p <span class="hljs-type"><span class="hljs-type">WHILE</span></span> tb -&gt; ouput <span class="hljs-string"><span class="hljs-string">"WHILE"</span></span> &lt;&gt; indent t &lt;&gt; indent b c -&gt; ouput $ show c ouput x = [stimes n <span class="hljs-string"><span class="hljs-string">" "</span></span> ++ x] indent = hom (n+<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p> –ò —Å–Ω–æ–≤–∞ —Å—Ç—Ä–æ–∏—Ç—Å—è –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º: —Ç–µ–ø–µ—Ä—å –∫–æ–º–∞–Ω–¥–∞–º —Å—Ç–∞–≤—è—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä–æ–∫–∏ —Å –æ—Ç—Å—Ç—É–ø–æ–º, –∫–æ—Ç–æ—Ä—ã–µ, –æ–ø—è—Ç—å –∂–µ, –æ–±—Ä–∞–∑—É—é—Ç –º–æ–Ω–æ–∏–¥. </p><br><div class="spoiler"> <b class="spoiler_title">–ü–∞—Ä–∞ —Å–∏–º–ø–∞—Ç–∏—á–Ω–æ –Ω–∞–ø–µ—á–∞—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º:</b> <div class="spoiler_text"><pre> <code class="haskell hljs">Œª&gt; putStrLn . listing $ fact2 <span class="hljs-type"><span class="hljs-type">INC</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">SWAP</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> <span class="hljs-type"><span class="hljs-type">SUB</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">GTH</span></span> <span class="hljs-type"><span class="hljs-type">IF</span></span> <span class="hljs-type"><span class="hljs-type">REP</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> <span class="hljs-type"><span class="hljs-type">INC</span></span> : <span class="hljs-type"><span class="hljs-type">NEG</span></span> <span class="hljs-type"><span class="hljs-type">REP</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> <span class="hljs-type"><span class="hljs-type">DEC</span></span> <span class="hljs-type"><span class="hljs-type">DEC</span></span> <span class="hljs-type"><span class="hljs-type">DEC</span></span> <span class="hljs-type"><span class="hljs-type">REP</span></span> <span class="hljs-type"><span class="hljs-type">MUL</span></span> Œª&gt; putStrLn . listing $ gcd1 <span class="hljs-type"><span class="hljs-type">WHILE</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> <span class="hljs-type"><span class="hljs-type">NEQ</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> <span class="hljs-type"><span class="hljs-type">LTH</span></span> <span class="hljs-type"><span class="hljs-type">IF</span></span> : <span class="hljs-type"><span class="hljs-type">SWAP</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> <span class="hljs-type"><span class="hljs-type">SUB</span></span> <span class="hljs-type"><span class="hljs-type">POP</span></span></code> </pre> </div></div><br><p> –ù–µ –±—É–¥–µ–º –Ω–∞ —ç—Ç–æ–º –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –Ω–µ—Ö–∏—Ç—Ä—ã–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º –¥–ª—è —Å—Ç–µ–∫–æ–≤–æ–π –º–∞—à–∏–Ω—ã. –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö —É –Ω–∞—Å –æ–¥–∏–Ω, —Ç–∞–∫ —á—Ç–æ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –¥–ª—è —è–∑—ã–∫–∞ –Ω–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞, –∑–∞—Ç–æ –Ω–∞ —Å—Ç–µ–∫–µ –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã. –£ –Ω–∞—Å –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–∏—Ç—å —Å—Ç—Ä–æ–≥–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã –¥–æ –µ—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. </p><br><p> –í–≤–µ–¥—ë–º —Ç–∞–∫—É—é —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É –ø—Ä–æ–≥—Ä–∞–º–º, –∫–∞–∫ <em>–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å</em> ‚Äî —ç—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Å—Ç–µ–∫–µ –ø–µ—Ä–µ–¥ –µ—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏ –æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º —á–∏—Å–ª–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –Ω–∞ —Å—Ç–µ–∫–µ –ø–æ—Å–ª–µ –µ—ë –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ù–∞–ø—Ä–∏–º–µ—Ä –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å –Ω–∞ —Å—Ç–µ–∫–µ –Ω–µ –º–µ–Ω–µ–µ –¥–≤—É—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–∞–∫ –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç. –ú—ã –∑–∞–ø–∏—à–µ–º —ç—Ç–æ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–æ –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ: </p><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-186"><span class="MJXp-mrow" id="MJXp-Span-187"><span class="MJXp-mi" id="MJXp-Span-188"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font></span><span class="MJXp-mi" id="MJXp-Span-189"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r </font></font></span><span class="MJXp-mi" id="MJXp-Span-190"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="MJXp-mi" id="MJXp-Span-191"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi" id="MJXp-Span-192"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-193" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font></span><span class="MJXp-mrow" id="MJXp-Span-194"><span class="MJXp-mtext MJXp-mono" id="MJXp-Span-195"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-196" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font></span><span class="MJXp-mo" id="MJXp-Span-197" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mn" id="MJXp-Span-198"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="MJXp-mo" id="MJXp-Span-199" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñπ </font></font></span><span class="MJXp-mn" id="MJXp-Span-200"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-11-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-11">\mathrm{arity}(\texttt{add}) = 2 \triangleright 1</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here are the valencies of some other operators: </font></font><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-201"><span class="MJXp-mrow" id="MJXp-Span-202"><span class="MJXp-mi" id="MJXp-Span-203"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font></span><span class="MJXp-mi" id="MJXp-Span-204"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r </font></font></span><span class="MJXp-mi" id="MJXp-Span-205"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="MJXp-mi" id="MJXp-Span-206"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi" id="MJXp-Span-207"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-208" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font></span><span class="MJXp-mrow" id="MJXp-Span-209"><span class="MJXp-mtext MJXp-mono" id="MJXp-Span-210"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">push</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-211" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font></span><span class="MJXp-mo" id="MJXp-Span-212" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mn" id="MJXp-Span-213"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class="MJXp-mo" id="MJXp-Span-214" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñπ </font></font></span><span class="MJXp-mn" id="MJXp-Span-215"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1</font></font></span><span class="MJXp-mspace" id="MJXp-Span-216" style="width: 0em; height: 0em;"></span><span class="MJXp-mrow" id="MJXp-Span-217"><span class="MJXp-mi" id="MJXp-Span-218"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font></span><span class="MJXp-mi" id="MJXp-Span-219"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r </font></font></span><span class="MJXp-mi" id="MJXp-Span-220"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="MJXp-mi" id="MJXp-Span-221"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi" id="MJXp-Span-222"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-223" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font></span><span class="MJXp-mrow" id="MJXp-Span-224"><span class="MJXp-mtext MJXp-mono" id="MJXp-Span-225"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pop</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-226" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font></span><span class="MJXp-mo" id="MJXp-Span-227" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mn" id="MJXp-Span-228"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="MJXp-mo" id="MJXp-Span-229" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñπ </font></font></span><span class="MJXp-mn" id="MJXp-Span-230"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></span><span class="MJXp-mspace" id="MJXp-Span-231" style="width: 0em; height: 0em;"></span><span class="MJXp-mrow" id="MJXp-Span-232"><span class="MJXp-mi" id="MJXp-Span-233"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a </font></font></span><span class="MJXp-mi" id="MJXp-Span-234"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">r </font></font></span><span class="MJXp-mi" id="MJXp-Span-235"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span><span class="MJXp-mi" id="MJXp-Span-236"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t </font></font></span><span class="MJXp-mi" id="MJXp-Span-237"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-238" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ( </font></font></span><span class="MJXp-mrow" id="MJXp-Span-239"><span class="MJXp-mtext MJXp-mono" id="MJXp-Span-240"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exch</font></font></span></span><span class="MJXp-mo" id="MJXp-Span-241" style="margin-left: 0em; margin-right: 0em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) </font></font></span><span class="MJXp-mo" id="MJXp-Span-242" style="margin-left: 0.333em; margin-right: 0.333em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="MJXp-mn" id="MJXp-Span-243"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="MJXp-mo" id="MJXp-Span-244" style="margin-left: 0.267em; margin-right: 0.267em;"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚ñπ </font></font></span><span class="MJXp-mn" id="MJXp-Span-245"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3</font></font></span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-12-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-12">\mathrm{arity}(\texttt{push}) = 0 \triangleright 1\\ \mathrm{arity}(\texttt{pop}) = 1 \triangleright 0\\ \mathrm{arity}(\texttt{exch}) = 2 \triangleright 3</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why do we always make a reservation: the minimum number, the maximum requirements ..? </font><font style="vertical-align: inherit;">The point is that all basic operators have exactly defined valence, but when branching, different branches may have different requirements and results. </font><font style="vertical-align: inherit;">Our task: to calculate the most stringent requirements that should ensure the work of all branches, no matter how many.</font></font><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> When sequentially executing commands, valencies are combined in the following nontrivial way: </font></font></p><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-295"><span class="MJXp-mo" id="MJXp-Span-296" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-msubsup" id="MJXp-Span-297"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-298" style="margin-right: 0.05em;">i</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-299" style="vertical-align: -0.4em;">1</span></span><span class="MJXp-mo" id="MJXp-Span-300" style="margin-left: 0.267em; margin-right: 0.267em;">‚ñπ</span><span class="MJXp-msubsup" id="MJXp-Span-301"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-302" style="margin-right: 0.05em;">o</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-303" style="vertical-align: -0.4em;">1</span></span><span class="MJXp-mo" id="MJXp-Span-304" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-305" style="margin-left: 0.267em; margin-right: 0.267em;">‚ãÑ</span><span class="MJXp-mo" id="MJXp-Span-306" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-msubsup" id="MJXp-Span-307"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-308" style="margin-right: 0.05em;">i</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-309" style="vertical-align: -0.4em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-310" style="margin-left: 0.267em; margin-right: 0.267em;">‚ñπ</span><span class="MJXp-msubsup" id="MJXp-Span-311"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-312" style="margin-right: 0.05em;">o</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-313" style="vertical-align: -0.4em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-314" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-315" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mo" id="MJXp-Span-316" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-317">a</span><span class="MJXp-mo" id="MJXp-Span-318" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-319"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-320" style="margin-right: 0.05em;">i</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-321" style="vertical-align: -0.4em;">1</span></span><span class="MJXp-mo" id="MJXp-Span-322" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-323" style="margin-left: 0.267em; margin-right: 0.267em;">‚ñπ</span><span class="MJXp-mo" id="MJXp-Span-324" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-325">a</span><span class="MJXp-mo" id="MJXp-Span-326" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-327"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-328" style="margin-right: 0.05em;">o</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-329" style="vertical-align: -0.4em;">1</span></span><span class="MJXp-mo" id="MJXp-Span-330" style="margin-left: 0.267em; margin-right: 0.267em;">+</span><span class="MJXp-msubsup" id="MJXp-Span-331"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-332" style="margin-right: 0.05em;">o</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-333" style="vertical-align: -0.4em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-334" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-msubsup" id="MJXp-Span-335"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-336" style="margin-right: 0.05em;">i</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-337" style="vertical-align: -0.4em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-338" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-339" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-mspace" id="MJXp-Span-340" style="width: 2em; height: 0em;"></span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-341">a</span><span class="MJXp-mo" id="MJXp-Span-342" style="margin-left: 0.333em; margin-right: 0.333em;">=</span><span class="MJXp-mo" id="MJXp-Span-343" style="margin-left: 0.333em; margin-right: 0.333em;">max</span><span class="MJXp-mo" id="MJXp-Span-344" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mn" id="MJXp-Span-345">0</span><span class="MJXp-mo" id="MJXp-Span-346" style="margin-left: 0em; margin-right: 0.222em;">,</span><span class="MJXp-msubsup" id="MJXp-Span-347"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-348" style="margin-right: 0.05em;">i</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-349" style="vertical-align: -0.4em;">2</span></span><span class="MJXp-mo" id="MJXp-Span-350" style="margin-left: 0.267em; margin-right: 0.267em;">‚àí</span><span class="MJXp-msubsup" id="MJXp-Span-351"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-352" style="margin-right: 0.05em;">o</span><span class="MJXp-mn MJXp-script" id="MJXp-Span-353" style="vertical-align: -0.4em;">1</span></span><span class="MJXp-mo" id="MJXp-Span-354" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-355" style="margin-left: 0em; margin-right: 0.222em;">.</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-13-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-13">(i_1 \triangleright o_1) \diamond (i_2 \triangleright o_2) = (a+i_1) \triangleright (a + o_1 + o_2 - i_2),\qquad a = \max(0, i_2 - o_1).</script></p><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This operation is associative and has a neutral element, which is not surprising for an article on monoids. </font><font style="vertical-align: inherit;">Add this result to the program:</font></font><br><pre> <code class="haskell hljs"><span class="hljs-keyword"><span class="hljs-keyword">infix</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> :&gt; data Arity = Int :&gt; Int deriving (Show,Eq) instance Semigroup Arity where (i1 :&gt; o1) &lt;&gt; (i2 :&gt; o2) = let a = <span class="hljs-number"><span class="hljs-number">0</span></span> `max` (i2 - o1) in (a + i1) :&gt; (a + o1 + o2 - i2) instance Monoid Arity where mempty = <span class="hljs-number"><span class="hljs-number">0</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And then you can build a homomorphism: </font></font></p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">arity</span></span> :: <span class="hljs-type"><span class="hljs-type">Program'</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">Arity</span></span> arity = hom . toCode <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> hom = foldMap $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">IF</span></span> b1 b2 -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i1 :&gt; o1 = hom b1 i2 :&gt; o2 = hom b2 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> &lt;&gt; (i1 `max` i2):&gt;(o1 `min` o2) <span class="hljs-type"><span class="hljs-type">REP</span></span> p -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">WHILE</span></span> tb -&gt; hom t &lt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">PUT</span></span> _ -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">GET</span></span> _ -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">PUSH</span></span> _ -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">POP</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">DUP</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">SWAP</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">EXCH</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-type"><span class="hljs-type">INC</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">DEC</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">NEG</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> _ -&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>:&gt;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p> –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã —Ü–∏–∫–ª–æ–≤ –∏–º–µ—é—Ç –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å, –Ω–µ –∑–∞–≤–∏—Å—è—â—É—é –æ—Ç —Ç–µ–ª–∞ —Ü–∏–∫–ª–∞, –ø–æ—Å–∫–æ–ª—å–∫—É –∫–æ–¥ —Ç–µ–ª–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã –º–æ–∂–µ—Ç –Ω–µ –∏—Å–ø–æ–ª–Ω–∏—Ç—å—Å—è –≤–æ–≤—Å–µ. –ê —Ç–∞–∫ –∫–∞–∫ –º—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Å—Ç—Ä–æ–≥–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è, –º—ã –º–æ–∂–µ–º —Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—Ö–æ–¥ –≤ —Ü–∏–∫–ª. </p><br><p> –†–∞—Å—Å—á–∏—Ç–∞–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º (–∫—Ä–æ–º–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö): </p><br><pre> <code class="haskell hljs">Œª&gt; arity (exch &lt;&gt; exch) <span class="hljs-number"><span class="hljs-number">2</span></span> :&gt; <span class="hljs-number"><span class="hljs-number">4</span></span> Œª&gt; arity fact1 <span class="hljs-number"><span class="hljs-number">1</span></span> :&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> Œª&gt; arity range <span class="hljs-number"><span class="hljs-number">2</span></span> :&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> Œª&gt; arity (push <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&gt; dup &lt;&gt; pow) <span class="hljs-number"><span class="hljs-number">0</span></span> :&gt; <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p> –ß—Ç–æ –µ—â—ë –º–æ–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º? –¢–∞–∫ –∫–∞–∫ —Ä–µ–≥–∏—Å—Ç—Ä—ã –ø–∞–º—è—Ç–∏ —É–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏, –∫–∞–∂–¥–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ "–∑–Ω–∞–µ—Ç" –∫–∞–∫–æ–π –æ–±—ä—ë–º –ø–∞–º—è—Ç–∏ –µ–π –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è. –ú–æ–∂–Ω–æ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –≥–æ–º–æ–º–æ—Ä—Ñ–∏–∑–º <code>Program' a -&gt; Max Int</code> , –∏ –ø—Ä–∏ –∏–Ω–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞—à–∏–Ω—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ –Ω—É–∂–Ω–æ–≥–æ –æ–±—ä—ë–º–∞. –û–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">memoryUse</span></span> :: <span class="hljs-type"><span class="hljs-type">Program'</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">Max</span></span> <span class="hljs-type"><span class="hljs-type">Int</span></span> memoryUse = hom . toCode <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> hom = foldMap $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">IF</span></span> b1 b2 -&gt; hom b1 &lt;&gt; hom b2 <span class="hljs-type"><span class="hljs-type">REP</span></span> p -&gt; hom p <span class="hljs-type"><span class="hljs-type">WHILE</span></span> tb -&gt; hom t &lt;&gt; hom b <span class="hljs-type"><span class="hljs-type">PUT</span></span> i -&gt; <span class="hljs-type"><span class="hljs-type">Max</span></span> (i+<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-type"><span class="hljs-type">GET</span></span> i -&gt; <span class="hljs-type"><span class="hljs-type">Max</span></span> (i+<span class="hljs-number"><span class="hljs-number">1</span></span>) _ -&gt; <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><pre> <code class="haskell hljs">Œª&gt; memoryUse fact1 <span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">0</span></span>} Œª&gt; memoryUse fact3 <span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">1</span></span>} Œª&gt; memoryUse pow <span class="hljs-type"><span class="hljs-type">Max</span></span> {getMax = <span class="hljs-number"><span class="hljs-number">2</span></span>}</code> </pre> <br><p> –ü—Ä–∏ –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–∞–º—è—Ç–∏. –≠—Ç–æ –º–æ–∂–Ω–æ —Ä–µ—à–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–≤–æ–¥—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —É–∫–∞–∑—ã–≤–∞–µ–º—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤, –≤–µ–¥—å –Ω–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã. </p><br><p> –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –ø—Ä–æ—Å—Ç—É—é, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é: –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–ª–∏–Ω–Ω—ã–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ –ª–∏–Ω–µ–π–Ω—ã–µ –æ—Ç—Ä–µ–∑–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Ç—Ä–µ–±—É—é—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å—Ç–µ–∫–µ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º, —Ç–æ –µ—Å—Ç—å, —Å –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç—å—é <code>0:&gt;_</code> –∏ –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤—É—é—Ç –ø–∞–º—è—Ç—å. –¢–∞–∫–∏–µ —Ü–µ–ø–æ—á–∫–∏ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ –∏ –∑–∞–º–µ–Ω–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –Ω–∞ —ç—Ç–∞–ø–µ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏–∏. –û–±—ã—á–Ω–æ, —ç—Ç–æ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è. </p><br><div class="spoiler"> <b class="spoiler_title">–ü—Ä–∏–º–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">isReducible</span></span> p = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> p' = fromCode p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> arity p' <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:&gt;_ -&gt; memoryUse p' == <span class="hljs-number"><span class="hljs-number">0</span></span> _ -&gt; <span class="hljs-type"><span class="hljs-type">False</span></span> reducible = go [] . toCode <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go res [] = reverse res go res (p:ps) = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isReducible [p] <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (a,b) = spanBy isReducible (p:ps) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> go (a:res) b <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> go res ps <span class="hljs-comment"><span class="hljs-comment">-- –∑–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–Ω–æ–∏–¥ Last, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç—Å—è, -- –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–µ—Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç spanBy test l = case foldMap tst $ zip (inits l) (tails l) of Last Nothing -&gt; ([],l) Last (Just x) -&gt; x where tst x = Last $ if test (fst x) then Just x else Nothing -- –∑–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–Ω–æ–∏–¥ Endo –∫–æ–º–±–∏–Ω–∏—Ä—É—é—â–∏–π—Å—è –∫–∞–∫ —ç–Ω–¥–æ–º–æ—Ä—Ñ–∏–∑–º -- —Ñ—É–Ω–∫—Ü–∏–∏ intercalate –∏ splitOn –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫ -- Data.List –∏ Data.List.Split reduce p = fromCode . process (reducible p) . toCode $ p where process = appEndo . foldMap (\x -&gt; Endo $ x `replaceBy` shrink x) shrink = toCode . foldMap push . reverse . stack . exec . fromCode replaceBy xy = intercalate y . splitOn x</span></span></code> </pre> <br><p> –ü—Ä–∏–º–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã: </p><br><pre> <code class="haskell hljs">Œª&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> p = push <span class="hljs-number"><span class="hljs-number">6</span></span> &lt;&gt; fact1 &lt;&gt; swap &lt;&gt; push <span class="hljs-number"><span class="hljs-number">5</span></span> &lt;&gt; dup &lt;&gt; push <span class="hljs-number"><span class="hljs-number">14</span></span> &lt;&gt; gcd1 &lt;&gt; put <span class="hljs-number"><span class="hljs-number">1</span></span> Œª&gt; toCode $ p [<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">WHILE</span></span> [<span class="hljs-type"><span class="hljs-type">DUP</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">GTH</span></span>] [<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">MUL</span></span>,<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">DEC</span></span>],<span class="hljs-type"><span class="hljs-type">POP</span></span>,<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-type"><span class="hljs-type">DUP</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>,<span class="hljs-type"><span class="hljs-type">WHILE</span></span> [<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">NEQ</span></span>] [<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">LTH</span></span>,<span class="hljs-type"><span class="hljs-type">IF</span></span> [] [<span class="hljs-type"><span class="hljs-type">SWAP</span></span>],<span class="hljs-type"><span class="hljs-type">EXCH</span></span>,<span class="hljs-type"><span class="hljs-type">SUB</span></span>],<span class="hljs-type"><span class="hljs-type">POP</span></span>,<span class="hljs-type"><span class="hljs-type">PUT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>] Œª&gt; toCode $ reduce p [<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span>,<span class="hljs-type"><span class="hljs-type">SWAP</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-type"><span class="hljs-type">PUSH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">PUT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>] Œª&gt; execLog logSteps (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; p) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">720</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>], journal = <span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">107</span></span>}} Œª&gt; execLog logSteps (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; reduce p) <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">720</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>], journal = <span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">6</span></span>}}</code> </pre> <br><p> –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–∫—Ä–∞—Ç–∏–ª–∞ —á–∏—Å–ª–æ —à–∞–≥–æ–≤ –Ω—É–∂–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–µ —Å–æ 107 –¥–æ 6. </p></div></div><br><p> –î–∞–ª–µ–µ, –æ—Ç –≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏, —Å–∫–∞–∂–µ–º, –∫ —Ç—Ä–æ–π–∫–∞–º –•–æ–∞—Ä–∞ –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—ã, –≤—ã–≤–æ–¥—è –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥- –∏ –ø–æ—Å—Ç—É—Å–ª–æ–≤–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –ª–∏–Ω–µ–π–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º (–¥–ª—è —Ü–∏–∫–ª–æ–≤ –ø—Ä–∏–¥—ë—Ç—Å—è –≤–æ–∑–∏—Ç—å—Å—è –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏). </p><br><a name="ch6"></a><br><h3 id="ot-monoidov-k-monadam-i-snova-k-monoidam"> –û—Ç –º–æ–Ω–æ–∏–¥–æ–≤ –∫ –º–æ–Ω–∞–¥–∞–º –∏ —Å–Ω–æ–≤–∞ –∫ –º–æ–Ω–æ–∏–¥–∞–º </h3><br><p> –ù–æ —á—Ç–æ –µ—Å–ª–∏ –Ω–∞—à–µ–π –º–∞—à–∏–Ω–µ –Ω—É–∂–Ω–æ –≤—ã–π—Ç–∏ –≤ –º–∏—Ä —ç—Ñ—Ñ–µ–∫—Ç–æ–≤: –æ–±—â–∞—Ç—å—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π, –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, —Å–ª—É—á–∞–π–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏ –∏ —Ç.–¥.? –ú–æ–∂–Ω–æ –ª–∏ –Ω–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –æ—Å–Ω–∞—Å—Ç–∏—Ç—å –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏? –ú–æ–∂–Ω–æ, —Ö–æ—Ç—å –∏ –ø—Ä–∏–¥—ë—Ç—Å—è –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –Ω–æ –æ–Ω–æ —Ç–æ–≥–æ —Å—Ç–æ–∏—Ç! </p><br><p> –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –º–æ–Ω–∞–¥—ã <code>m</code> –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–∏ <code>VM -&gt; VM</code> –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å—Å—è –≤ <code>VM -&gt; m VM</code> , —ç—Ç–æ —É–∂–µ –Ω–µ —ç–Ω–¥–æ–º–æ—Ä—Ñ–∏–∑–º. –ù–æ –≤—Å–ø–æ–º–Ω–∏–º –∫—Ä—ã–ª–∞—Ç—É—é —Ñ—Ä–∞–∑—É: <em>"–ú–æ–Ω–∞–¥–∞ ‚Äî —ç—Ç–æ –≤—Å–µ–≥–æ –ª–∏—à—å –º–æ–Ω–æ–∏–¥ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —ç–Ω–¥–æ—Ñ—É–Ω–∫—Ç–æ—Ä–æ–≤, –≤ —á—ë–º –ø—Ä–æ–±–ª–µ–º–∞?!"</em> –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ö–ª–µ–π—Å–ª–∏, –∫–æ—Ç–æ—Ä—É—é –æ–±—Ä–∞–∑—É—é—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–∏ <code>VM -&gt; m VM</code> –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è, –∞ –æ–Ω–∞, —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞ –∏ –∏–º–µ–µ—Ç –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç. –≠—Ç—É –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –≤ Haskell –æ–±–æ–∑–Ω–∞—á–∞—é—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º <code>&gt;=&gt;</code> –∏ –Ω–∞–∑—ã–≤–∞—é—Ç "—Ä—ã–±–∫–æ–π –ö–ª–µ–π—Å–ª–∏". –ó–Ω–∞—á–∏—Ç, –¥–ª—è –≤—ã—Ö–æ–¥–∞ –≤ –º–∏—Ä –≤—ã—á–∏—Å–ª–µ–Ω–∏–π —Å —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞—á–∏–Ω–∫—É <code>Action</code> –Ω–∞ –º–æ–Ω–æ–∏–¥ <code>ActionM</code> , –æ–ø—Ä–µ–¥–µ–ª–∏–≤ –µ–≥–æ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º: </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">newtype</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> ma = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">runActionM</span></span></span><span class="hljs-class"> :: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ma</span></span></span><span class="hljs-class"> } instance </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Monad</span></span></span><span class="hljs-class"> m =&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Semigroup</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ma</span></span></span><span class="hljs-class">) where </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> f &lt;&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> g = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f</span></span></span><span class="hljs-class"> &gt;=&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g</span></span></span><span class="hljs-class">) instance </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Monad</span></span></span><span class="hljs-class"> m =&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Monoid</span></span></span><span class="hljs-class"> (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ma</span></span></span><span class="hljs-class">) where mempty = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ActionM</span></span></span><span class="hljs-class"> return</span></span></code> </pre> <br><p> –ü–æ–º–µ–Ω—è—é—Ç—Å—è —Å–µ—Ç—Ç–µ—Ä—ã, –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å—Ç–∞—Ç—å –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–º–∏, –∏ –≤–µ–∑–¥–µ –≤–º–µ—Å—Ç–æ –∏—Ö –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –Ω–∞–¥–æ –±—É–¥–µ—Ç –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä <code>&gt;=&gt;</code> . –í—Å–µ –∂–µ –ø—Ä–æ—á–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. </p><br><div class="spoiler"> <b class="spoiler_title">–°—Ç–µ–∫–æ–≤–∞—è –º–∞—à–∏–Ω–∞ —Å –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–º–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è–º–∏</b> <div class="spoiler_text"><pre> <code class="haskell hljs"><span class="hljs-meta"><span class="hljs-meta">{-# LANGUAGE LambdaCase, GeneralizedNewtypeDeriving, TupleSections #-}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Monoid <span class="hljs-keyword"><span class="hljs-keyword">hiding</span></span> ((&lt;&gt;)) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Semigroup (<span class="hljs-type"><span class="hljs-type">Semigroup(..)</span></span>,<span class="hljs-title"><span class="hljs-title">stimes</span></span>,<span class="hljs-type"><span class="hljs-type">Max(..)</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Data.Vector ((//),(!),Vector,toList) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">qualified</span></span> Data.Vector <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> V (<span class="hljs-title"><span class="hljs-title">replicate</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Control.Monad <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Control.Monad.Identity type Stack = [Int] type Memory = Vector Int memSize = 4 data VM a = VM { stack :: Stack , status :: Maybe String , memory :: Memory , journal :: a } deriving Show mkVM = VM mempty mempty (<span class="hljs-type"><span class="hljs-type">V</span></span>.<span class="hljs-title"><span class="hljs-title">replicate</span></span> <span class="hljs-title"><span class="hljs-title">memSize</span></span> 0) setStack x (<span class="hljs-type"><span class="hljs-type">VM</span></span> <span class="hljs-title"><span class="hljs-title">_</span></span> <span class="hljs-title"><span class="hljs-title">st</span></span> <span class="hljs-title"><span class="hljs-title">ml</span></span>) = return $ VM x st ml setStatus st (<span class="hljs-type"><span class="hljs-type">VM</span></span> <span class="hljs-title"><span class="hljs-title">s</span></span> <span class="hljs-title"><span class="hljs-title">_</span></span> <span class="hljs-title"><span class="hljs-title">ml</span></span>) = return $ VM s st ml setMemory m (<span class="hljs-type"><span class="hljs-type">VM</span></span> <span class="hljs-title"><span class="hljs-title">s</span></span> <span class="hljs-title"><span class="hljs-title">st</span></span> <span class="hljs-title"><span class="hljs-title">_</span></span> <span class="hljs-title"><span class="hljs-title">l</span></span>) = return $ VM s st ml addRecord x (<span class="hljs-type"><span class="hljs-type">VM</span></span> <span class="hljs-title"><span class="hljs-title">s</span></span> <span class="hljs-title"><span class="hljs-title">st</span></span> <span class="hljs-title"><span class="hljs-title">ml</span></span>) = VM s st m (<span class="hljs-title"><span class="hljs-title">x</span></span>&lt;&gt;<span class="hljs-title"><span class="hljs-title">l</span></span>) <span class="hljs-comment"><span class="hljs-comment">------------------------------------------------------------ data Code = IF [Code] [Code] | REP [Code] | WHILE [Code] [Code] | PUT Int | GET Int | PUSH Int | POP | DUP | SWAP | EXCH | INC | DEC | NEG | ADD | MUL | SUB | DIV | MOD | EQL | LTH | GTH | NEQ | ASK | PRT | PRTS String | FORK [Code] [Code] deriving (Read, Show) newtype ActionM ma = ActionM {runActionM :: a -&gt; ma} instance Monad m =&gt; Semigroup (ActionM ma) where ActionM f &lt;&gt; ActionM g = ActionM (f &gt;=&gt; g) instance Monad m =&gt; Monoid (ActionM ma) where ActionM f `mappend` ActionM g = ActionM (f &gt;=&gt; g) mempty = ActionM return newtype Program ma = Program { getProgram :: ([Code], ActionM m (VM a)) } deriving (Semigroup, Monoid) type Program' ma = (Code -&gt; VM a -&gt; m (VM a)) -&gt; Program ma program cfp = Program . ([c],) . ActionM $ \vm -&gt; case status vm of Nothing -&gt; pc =&lt;&lt; f (stack vm) vm m -&gt; return vm programM cfp = Program . ([c],) . ActionM $ \vm -&gt; case status vm of Nothing -&gt; pc =&lt;&lt; f (memory vm, stack vm) vm m -&gt; return vm run :: Monad m =&gt; Program ma -&gt; VM a -&gt; m (VM a) run = runActionM . snd . getProgram toCode :: Monad m =&gt; Program' ma -&gt; [Code] toCode prog = fst . getProgram $ prog none none :: Monad m =&gt; Code -&gt; VM a -&gt; m (VM a) none = const return -- –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã –≤–Ω–µ –º–æ–Ω–∞–¥ exec :: Program' Identity () -&gt; VM () exec = runIdentity . execM execM :: Monad m =&gt; Program' m () -&gt; m (VM ()) execM prog = run (prog none) (mkVM ()) execLog p prog = run (prog $ \c -&gt; \vm -&gt; return $ addRecord (pc vm) vm) (mkVM mempty) f &amp;&amp;&amp; g = \c -&gt; \r -&gt; (fcr, gcr) logStack _ vm = [stack vm] logStackUsed _ = Max . length . stack logSteps _ = const (Sum 1) logCode c _ = [c] logRun com vm = [pad 10 c ++ "| " ++ pad 20 s ++ "| " ++ m] where c = show com m = unwords $ show &lt;$&gt; toList (memory vm) s = unwords $ show &lt;$&gt; stack vm pad nx = take n (x ++ repeat ' ') debug p = unlines . reverse . journal &lt;$&gt; execLog logRun p ------------------------------------------------------------ pop,dup,swap,exch :: Monad m =&gt; Program' ma put,get,push :: Monad m =&gt; Int -&gt; Program' ma add,mul,sub,frac,modulo,inc,dec,neg :: Monad m =&gt; Program' ma eq,neq,lt,gt :: Monad m =&gt; Program' ma err m = setStatus . Just $ "Error : " ++ m pop = program POP $ \case x:s -&gt; setStack s _ -&gt; err "pop expected an argument." push x = program (PUSH x) $ \s -&gt; setStack (x:s) dup = program DUP $ \case x:s -&gt; setStack (x:x:s) _ -&gt; err "dup expected an argument." swap = program SWAP $ \case x:y:s -&gt; setStack (y:x:s) _ -&gt; err "swap expected two arguments." exch = program EXCH $ \case x:y:s -&gt; setStack (y:x:y:s) _ -&gt; err "expected two arguments." put i = indexed (PUT i) i $ \case (m, x:s) -&gt; setStack s &lt;=&lt; setMemory (m // [(i,x)]) _ -&gt; err "put expected an argument" get i = indexed (GET i) i $ \(m, s) -&gt; setStack ((m ! i) : s) indexed cif = programM c $ if (i &lt; 0 || i &gt;= memSize) then const $ err "index in [0,16]" else f app1 cf = program c $ \case x:s -&gt; setStack (fx:s) _ -&gt; err $ "operation " ++ show c ++ " expected an argument" app2 cf = program c $ \case x:y:s -&gt; setStack (fxy:s) _ -&gt; err $ "operation " ++ show c ++ " expected two arguments" add = app2 ADD (+) sub = app2 SUB (flip (-)) mul = app2 MUL (*) frac = app2 DIV (flip div) modulo = app2 MOD (flip mod) neg = app1 NEG (\x -&gt; -x) inc = app1 INC (\x -&gt; x+1) dec = app1 DEC (\x -&gt; x-1) eq = app2 EQL (\x -&gt; \y -&gt; if (x == y) then 1 else 0) neq = app2 NEQ (\x -&gt; \y -&gt; if (x /= y) then 1 else 0) lt = app2 LTH (\x -&gt; \y -&gt; if (x &gt; y) then 1 else 0) gt = app2 GTH (\x -&gt; \y -&gt; if (x &lt; y) then 1 else 0) proceed p prog s = run (prog p) &lt;=&lt; setStack s rep body p = program (REP (toCode body)) go none where go (n:s) = if n &gt;= 0 then proceed p (stimes n body) s else err "rep expected positive argument." go _ = err "rep expected an argument." branch br1 br2 p = program (IF (toCode br1) (toCode br2)) go none where go (x:s) = proceed p (if (x /= 0) then br1 else br2) s go _ = err "branch expected an argument." while test body p = program (WHILE (toCode test) (toCode body)) (const go) none where go vm = do res &lt;- proceed p test (stack vm) vm case (stack res) of 0:s -&gt; proceed p mempty s res _:s -&gt; go =&lt;&lt; proceed p body s res _ -&gt; err "while expected an argument." vm ask :: Program' IO a ask = program ASK $ \case s -&gt; \vm -&gt; do x &lt;- getLine setStack (read x:s) vm prt :: Program' IO a prt = program PRT $ \case x:s -&gt; \vm -&gt; print x &gt;&gt; return vm _ -&gt; err "PRT expected an argument" prtS :: String -&gt; Program' IO a prtS s = program (PRTS s) $ const $ \vm -&gt; print s &gt;&gt; return vm fork :: Program' [] a -&gt; Program' [] a -&gt; Program' [] a fork br1 br2 p = program (FORK (toCode br1) (toCode br2)) (const go) none where go = run (br1 p) &lt;&gt; run (br2 p) ------------------------------------------------------------ fromCode :: Monad m =&gt; [Code] -&gt; Program' ma fromCode = hom where hom = foldMap $ \case IF b1 b2 -&gt; branch (hom b1) (hom b2) REP p -&gt; rep (hom p) WHILE tb -&gt; while (hom t) (hom b) PUT i -&gt; put i GET i -&gt; get i PUSH i -&gt; push i POP -&gt; pop DUP -&gt; dup SWAP -&gt; swap EXCH -&gt; exch INC -&gt; inc DEC -&gt; dec ADD -&gt; add MUL -&gt; mul SUB -&gt; sub DIV -&gt; frac MOD -&gt; modulo EQL -&gt; eq LTH -&gt; lt GTH -&gt; gt NEQ -&gt; neq NEG -&gt; neg _ -&gt; mempty fromCodeIO :: [Code] -&gt; Program' IO a fromCodeIO = hom where hom = foldMap $ \case IF b1 b2 -&gt; branch (hom b1) (hom b2) REP p -&gt; rep (hom p) WHILE tb -&gt; while (hom t) (hom b) ASK -&gt; ask PRT -&gt; ask PRTS s -&gt; prtS s c -&gt; fromCode [c] fromCodeList :: [Code] -&gt; Program' [] a fromCodeList = hom where hom = foldMap $ \case IF b1 b2 -&gt; branch (hom b1) (hom b2) REP p -&gt; rep (hom p) WHILE tb -&gt; while (hom t) (hom b) FORK b1 b2 -&gt; fork (hom b1) (hom b2) c -&gt; fromCode [c]</span></span></code> </pre> </div></div><br><p> –í —Ä–∞–º–∫–∞—Ö —Ç–∞–∫–æ–π –º–æ–¥–µ–ª–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–≤–µ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥—ã: –¥–ª—è —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ <code>stdin</code> –∏–ª–∏ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ª–∏–±–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ –ø–µ—á–∞—Ç—å. </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">ask</span></span>, prt :: <span class="hljs-type"><span class="hljs-type">Program'</span></span> <span class="hljs-type"><span class="hljs-type">IO</span></span> a ask = program <span class="hljs-type"><span class="hljs-type">ASK</span></span> $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s -&gt; \vm -&gt; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> x &lt;- getLine setStack (read x:s) vm prt = program <span class="hljs-type"><span class="hljs-type">PRT</span></span> $ \<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x:s -&gt; \vm -&gt; print x &gt;&gt; return vm _ -&gt; err <span class="hljs-string"><span class="hljs-string">"PRT expected an argument"</span></span> prtS :: <span class="hljs-type"><span class="hljs-type">String</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Program'</span></span> <span class="hljs-type"><span class="hljs-type">IO</span></span> a prtS s = program (<span class="hljs-type"><span class="hljs-type">PRTS</span></span> s) $ const $ \vm -&gt; print s &gt;&gt; return vm</code> </pre> <br><p> –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —á—Ç–æ-—Ç–æ —Ç–∞–∫–æ–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è –≤ —Ç–æ–º, —á—Ç–æ –Ω–∞–º —É–¥–∞–ª–æ—Å—å —Å–æ–≤–º–µ—Å—Ç–∏—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">ioprog</span></span> = prtS <span class="hljs-string"><span class="hljs-string">"input first number"</span></span> &lt;&gt; ask &lt;&gt; prtS <span class="hljs-string"><span class="hljs-string">"input second number"</span></span> &lt;&gt; ask &lt;&gt; rep (prt &lt;&gt; dup &lt;&gt; inc) &lt;&gt; prt</code> </pre> <br><pre> <code class="haskell hljs">Œª&gt; exec ioprog input first number <span class="hljs-number"><span class="hljs-number">3</span></span> input second number <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-type"><span class="hljs-type">VM</span></span> {stack = [<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>], status = <span class="hljs-type"><span class="hljs-type">Nothing</span></span>, memory = [<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>], journal = ()}</code> </pre> <br><p> –î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä, —Ä–∞–∑–≤–µ—Ç–≤–ª—è—é—â–∏–π –ø–æ—Ç–æ–∫: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">fork</span></span> :: <span class="hljs-type"><span class="hljs-type">Program'</span></span> [] a -&gt; <span class="hljs-type"><span class="hljs-type">Program'</span></span> [] a -&gt; <span class="hljs-type"><span class="hljs-type">Program'</span></span> [] a fork br1 br2 p = program (<span class="hljs-type"><span class="hljs-type">FORK</span></span> (toCode br1) (toCode br2)) (const go) pure <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> go = run (br1 p) &lt;&gt; run (br2 p)</code> </pre> <br><p> –ó–¥–µ—Å—å –æ–ø—è—Ç—å —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –∞–ª–≥–µ–±—Ä–∞ –º–æ–Ω–æ–∏–¥–æ–≤: —Ñ—É–Ω–∫—Ü–∏–∏ <code>run</code> –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å <code>VM -&gt; m VM</code> , –∏—Ö –º–æ–Ω–æ–∏–¥–∞–ª—å–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è ‚Äî —Ñ—É–Ω–∫—Ü–∏—é, –≤–æ–∑–≤—Ä–∞—â–∞—é—â—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–æ —Ç–µ–ø–µ—Ä—å —É–∂–µ –≤ —Ä–∞–º–∫–∞—Ö –º–æ–Ω–∞–¥—ã <code>[]</code> , —Ç–æ –µ—Å—Ç—å ‚Äî —Å–ø–∏—Å–æ–∫ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. </p><br><p> –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–º —Ä–∞–±–æ—Ç—ã —Ä–∞–∑–≤–µ—Ç–≤–ª—ë–Ω–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–µ—á–Ω—ã–π —Å–æ—Å—Ç–æ—è–Ω–∏–π –º–∞—à–∏–Ω—ã: </p><br><pre> <code class="haskell hljs">Œª&gt; stack &lt;$&gt; exec (push <span class="hljs-number"><span class="hljs-number">5</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&gt; add `fork` sub) [[<span class="hljs-number"><span class="hljs-number">8</span></span>],[<span class="hljs-number"><span class="hljs-number">2</span></span>]] Œª&gt; stack &lt;$&gt; exec (push <span class="hljs-number"><span class="hljs-number">5</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">3</span></span> `fork` dup &lt;&gt; push <span class="hljs-number"><span class="hljs-number">2</span></span>) [[<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>],[<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>]]</code> </pre> <br><p> –ü–æ—Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–º–µ—Ä –∏–∑ –Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ç—å–∏: <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-356"><span class="MJXp-mo" id="MJXp-Span-357" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mn" id="MJXp-Span-358">2</span><span class="MJXp-mo" id="MJXp-Span-359" style="margin-left: 0.267em; margin-right: 0.267em;">¬±</span><span class="MJXp-mn" id="MJXp-Span-360">3</span><span class="MJXp-mo" id="MJXp-Span-361" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-362" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span><span class="MJXp-mo" id="MJXp-Span-363" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mo" id="MJXp-Span-364" style="margin-left: 0em; margin-right: 0em;">(</span><span class="MJXp-mn" id="MJXp-Span-365">4</span><span class="MJXp-mo" id="MJXp-Span-366" style="margin-left: 0.267em; margin-right: 0.267em;">¬±</span><span class="MJXp-mn" id="MJXp-Span-367">8</span><span class="MJXp-mo" id="MJXp-Span-368" style="margin-left: 0em; margin-right: 0em;">)</span><span class="MJXp-mo" id="MJXp-Span-369" style="margin-left: 0.267em; margin-right: 0.267em;">¬±</span><span class="MJXp-mn" id="MJXp-Span-370">5</span><span class="MJXp-mo" id="MJXp-Span-371" style="margin-left: 0em; margin-right: 0em;">)</span></span></span><span class="MathJax_SVG MathJax_SVG_Processing" id="MathJax-Element-14-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span><script type="math/tex" id="MathJax-Element-14">(2 \pm 3)*((4 \pm 8)\pm 5)</script>  : </p><br><pre> <code class="haskell hljs">Œª&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> pm = add `fork` sub Œª&gt; stack &lt;$&gt; exec (push <span class="hljs-number"><span class="hljs-number">2</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">3</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">4</span></span> &lt;&gt; push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; pm &lt;&gt; push <span class="hljs-number"><span class="hljs-number">5</span></span> &lt;&gt; pm &lt;&gt; pm &lt;&gt; mul) [[<span class="hljs-number"><span class="hljs-number">40</span></span>],[<span class="hljs-number"><span class="hljs-number">-28</span></span>],[<span class="hljs-number"><span class="hljs-number">20</span></span>],[<span class="hljs-number"><span class="hljs-number">-8</span></span>],[<span class="hljs-number"><span class="hljs-number">8</span></span>],[<span class="hljs-number"><span class="hljs-number">4</span></span>],[<span class="hljs-number"><span class="hljs-number">-12</span></span>],[<span class="hljs-number"><span class="hljs-number">24</span></span>]]</code> </pre> <br><p> –ê –≤–æ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —á–µ—Ç—ã—Ä—ë—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π —Ñ–∞–∫—Ç–æ—Ä–∏–∞–ª–æ–≤: </p><br><pre> <code class="haskell hljs">Œª&gt; journal &lt;$&gt; execLog logSteps (push <span class="hljs-number"><span class="hljs-number">8</span></span> &lt;&gt; fact `fork` fact1 `fork` fact2 `fork` fact3) [<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">48</span></span>},<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">63</span></span>},<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">34</span></span>},<span class="hljs-type"><span class="hljs-type">Sum</span></span> {getSum = <span class="hljs-number"><span class="hljs-number">43</span></span>}]</code> </pre> <br><p> –ó–∞–ø–∏—Å–∞—Ç—å –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —á–µ—Ç—ã—Ä—ë—Ö –≤–µ—Ç–≤–µ–π –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –±–µ–∑ —Å–∫–æ–±–æ–∫ –Ω–∞–º –ø–æ–∑–≤–æ–ª–∏–ª–æ —Ç–æ, —á—Ç–æ –ø—Ä–æ–≥—Ä–∞–º–º—ã –æ–±—Ä–∞–∑—É—é—Ç –º–æ–Ω–æ–∏–¥ —Å –æ–ø–µ—Ä–∞—Ü–∏–µ–π <code>fork</code> , –∑–Ω–∞—á–∏—Ç, –æ–ø–µ—Ä–∞—Ü–∏—è <code>fork</code> –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–∞. </p><br><p> –ü—Ä–∏—è—Ç–Ω–æ —á—Ç–æ –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã —Å–æ—Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤–º–µ—Å—Ç–µ –≤ –æ–¥–Ω–æ–º –º–æ–¥—É–ª–µ –∏ —Å–∫–ª–µ–∏–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ—Ç–∏–ø–Ω–æ. –î–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∞–¥–∫–∞. –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ —Ç–æ–º, —á—Ç–æ –≤ –Ω–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –∏ –≤–≤–æ–¥/–≤—ã–≤–æ–¥, –æ–¥–Ω–∞–∫–æ, –∏ —ç—Ç–æ —Ä–µ—à–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä–æ–≤ –º–æ–Ω–∞–¥. </p><br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math MJXp-display" id="MJXp-Span-372"><span class="MJXp-mo" id="MJXp-Span-373" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span><span class="MJXp-mo" id="MJXp-Span-374" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span><span class="MJXp-mo" id="MJXp-Span-375" style="margin-left: 0.267em; margin-right: 0.267em;">‚àó</span></span></span><div class="MathJax_SVG_Display MathJax_SVG_Processing"><span class="MathJax_SVG" id="MathJax-Element-15-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"></span></div><script type="math/tex;mode=display" id="MathJax-Element-15">* * *</script></p><br><p> –° –¥—Ä–µ–≤–Ω–µ-–≥—Ä–µ—á–µ—Å–∫–æ–≥–æ ŒºŒ¨Œ≥ŒºŒ± –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—Å—è –∫–∞–∫ –≥—Ä—è–∑—å –∏–ª–∏ —Ç–µ—Å—Ç–æ. –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ, —Å–∫–ª–µ–∏–≤–∞—è –∫—É—Å–∫–∏ —Ç–µ—Å—Ç–∞, –º—ã –≤–Ω–æ–≤—å –±—É–¥–µ–º –ø–æ–ª—É—á–∞—Ç—å –∫—É—Å–∫–∏ —Ç–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ —Å–∫–ª–µ–∏–≤–∞—Ç—å. –≠—Ç–æ –∫–∞–∂–µ—Ç—Å—è –±–æ–ª–µ–µ —á–µ–º —Ç—Ä–∏–≤–∏–∞–ª—å–Ω—ã–º –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ–º, –Ω–æ –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –æ—á–∞—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Å—Ç–∏–ª–∏–Ω–∞ –∏–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ Lego: –±–ª–∞–≥–æ–¥–∞—Ä—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∫—É–±–∏–∫–æ–≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫—É–±–∏–∫, –≥–æ—Ç–æ–≤—ã–π —Å –∫–µ–º-–Ω–∏–±—É–¥—å —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è. –° –∏–≥—Ä—É—à–∫–∞–º–∏, —Å–æ–µ–¥–∏–Ω—è–µ–º—ã–º–∏ –ª–∏–ø—É—á–∫–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–∞–∫ —É–∂–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è. </p><br><p> –ö—É–±–∏–∫–∏ Lego –ø–æ–∑–≤–æ–ª—è—é—Ç –º–∞—Å—Ç–µ—Ä–∏—Ç—å —Ç–æ, —á—Ç–æ –¥–∞–∂–µ –Ω–µ –º–æ–≥–ª–æ –ø—Ä–∏–π—Ç–∏ –≤ –≥–æ–ª–æ–≤—É –∏—Ö —Å–æ–∑–¥–∞—Ç–µ–ª—è–º, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ –º–Ω–æ–≥–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –Ω–µ –¥–æ–ø—É—Å–∫–∞—é—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ ‚Äî –∫–∞–∫ –Ω–∞ —Ñ–∞–±—Ä–∏–∫–µ —Å–¥–µ–ª–∞–ª–∏, –∫–∞–∫—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –∑–∞—à–∏–ª–∏, —Ç–∞–∫ –∏ –±—É–¥–µ—Ç. –ò –∫–∞–∫ –Ω–∏ —Å–æ–µ–¥–∏–Ω—è–π, –ø–æ–ª—É—á–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –ª–∏–±–æ –Ω–µ—Ä–∞–±–æ—Ç–∞—é—â–∏–π —Ö–ª–∞–º. –° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É—Ä–∞–∫–∞ ‚Äî —ç—Ç–æ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –ù–æ –µ—Å–ª–∏ —Å–µ—Ä—å—ë–∑–Ω–æ, —Ç–æ —Å—É—Ç—å –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ–∏—Ç –∏–º–µ–Ω–Ω–æ –≤ –±–æ–≥–∞—Ç—Å—Ç–≤–µ –∏ –≥–∏–±–∫–æ—Å—Ç–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –º–æ–≥—É—Ç –æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–Ω–æ–≤–∞ –º–æ–∂–Ω–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å. –î–µ—Å—è—Ç–∫–∞–º–∏ –ª–µ—Ç –ª—é–¥–∏ –Ω–µ –ø–µ—Ä–µ—Å—Ç–∞—é—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ (—ç—Ç–æ –∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –∏ –ø—Ä–µ—Å–ª–æ–≤—É—Ç—ã–µ –º–æ–Ω–∞–¥—ã –∏ –ª–∏–Ω–∑—ã-–ø—Ä–æ—Ñ—É–Ω–∫—Ç–æ—Ä—ã) —Å –ø–æ–ª–µ–∑–Ω—ã–º–∏, –∞ –∏–Ω–æ–≥–¥–∞ –∏ –≤–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏. –ù–æ —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ ‚Äî —ç—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –Ω–µ –ø—Ä–µ—Ä–æ–≥–∞—Ç–∏–≤–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è! –í –ª—é–±–æ–π –ø–∞—Ä–∞–¥–∏–≥–º–µ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∂—ë—Å—Ç–∫–∏–µ "–æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–µ" –±–ª–æ–∫–∏, –≥—Ä–æ–º–æ–∑–¥—è –∏–∑ –Ω–∏—Ö —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –Ω–æ–≤—ã—Ö –∏ –Ω–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤, –ø–æ—Å–∫–æ–ª—å–∫—É –æ–Ω–∏ –Ω–µ –∫–æ–º–±–∏–Ω–∏—Ä—É—é—Ç—Å—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –æ–±—Ä–∞–∑–æ–º, –ª–∏–±–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–∑—è—â–Ω—ã–µ —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–µ –¥–æ–ª–≥–æ–∂–∏–≤—É—â–∏–µ —Ä–µ—à–µ–Ω–∏—è. –ù–æ –∏–º–µ–Ω–Ω–æ –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–∞—Ä–∞–¥–∏–≥–º–µ —Ç–∞–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –¥–æ–∫–∞–∑—ã–≤–∞—Ç—å –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∏—Ö —Å–≤–æ–π—Å—Ç–≤–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ—Ç—Ç–∞—á–∏–≤–∞—Ç—å –∏—Ö –ø—Ä–µ–∂–¥–µ —á–µ–º —É–ø–∞–∫–æ–≤—ã–≤–∞—Ç—å –≤ –∫—Ä–∞—Å–∏–≤—ã–µ –∏ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∫–æ—Ä–æ–±–∫–∏ –∏ –≤—ã–ø—É—Å–∫–∞—Ç—å –≤ –º–∏—Ä —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π. </p><br><hr><br><p> –í—Å–µ –º–æ–¥—É–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ <a href="https://github.com/samsergey/monopig">—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏</a> . –ö–æ–µ-–∫–∞–∫–∏–µ —Ü–∏—Ñ—Ä—ã, –æ—Ç—Ä–∞–∂–∞—é—â–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏. –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–Ω–æ–∏–¥–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ö–ª–µ–π—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è <em>—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</em> —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º —Å—Ç–µ–∫–æ–≤–æ–π –º–∞—à–∏–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–µ–π –ø–∞–º—è—Ç—å. –ü—Ä–∏–Ω—Ü–∏–ø –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø—Ä–∏ —ç—Ç–æ–º –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è. </p></div><p>Source: <a href="https://habr.com/ru/post/429530/">https://habr.com/ru/post/429530/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>