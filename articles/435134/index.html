<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simplify working with databases in Qt using QSqlRelationalTableModel</title>
  <meta name="description" content="Good day, Habrovchane! In this article I want to talk about my experience of simplifying interaction with SQL databases when developing a desktop appl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Simplify working with databases in Qt using QSqlRelationalTableModel</h1><div class="post__text post__text-html js-mediator-article">  Good day, Habrovchane!  In this article I want to talk about my experience of simplifying interaction with SQL databases when developing a desktop application using the QSqlRelationalTableModel class of the Qt cross-platform library. <br><br><h3>  Prologue </h3><br>  I got acquainted with Qt while still a 1st year student, just starting to program in C ++, at the same time I became seriously interested in the library and, since then, I've been following its updates.  A few months ago, at work, I was given a ToR, in which I needed to develop an application that interacts with the SQLite database.  The structure of the base is fixed and is known to me from the TK. <br><br>  The application should be able to conveniently for the operator to present the data stored in the database, allow adding new records, delete and modify existing ones. <br><br>  Next, I will briefly describe the development process with casting pieces of code and try to reasonably explain why in this case the choice was made in favor of <b>QSqlRelationalTableModel</b> . <br><a name="habracut"></a><br><h3>  Start of development </h3><br>  Initially, it was decided to establish interaction with the database using simple database queries, i.e.  <b>SELECT</b> , <b>INSERT</b> , <b>DELETE</b> , which allow you to implement all the necessary functions of the application. <br><br>  To do this, we need the <b>QSqlDatabase</b> and <b>QSQlQuery classes</b> : <br><br><pre><code class="cpp hljs">QSqlDatabase db; <span class="hljs-comment"><span class="hljs-comment">//—Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –Ω–∞—à–µ–π –±–∞–∑—ã db = QSqlDatabase::addDatabase("QSQLITE"); //–¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ db.setHostName("localhost"); //–≤ –æ–±—â–µ–º —Å–ª—É—á–∞–µ, –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–æ–∫–∞–ª—Ö–æ—Å—Ç–æ–º db.setDatabaseName(path); //QString path - –ø—É—Ç—å –∫ –±–∞–∑–µ //–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è if(db.open()){ qDebug() &lt;&lt; "db opened OK..."; }else{ qDebug() &lt;&lt; " db opening failed..."; } }else{ qDebug() &lt;&lt; "file doesnot exist"; exit(0); //–≤ —Å–ª—É—á–∞–µ, –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –±–∞–∑—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, //–ø—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ }</span></span></code> </pre> <br>  After that, all operations on the base are performed as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//—Å—Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å, –∑–Ω–∞—á–µ–Ω–∏–µ –≤–æ–∑—å–º–µ–º –∏–∑ &lt;b&gt;QLineEdit&lt;/b&gt;'–∞ QString query = "INSERT INTO Table (column) VALUES ('" + ui-&gt;Input-&gt;text() + "')"; QSqlQuery sqlQuery(db); //c—Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–ø—Ä–æ—Å–∞ qDebug() &lt;&lt; "QUERY: " &lt;&lt; query; //–≤—ã–≤–æ–¥ //–ø–æ–Ω—è—Ç–Ω–æ –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π if(sqlQuery.exec(query)){ qDebug() &lt;&lt; "query failed..."; } else{ qDebug() &lt;&lt; "query failed..."; }</span></span></code> </pre> <br>  <b>Select statement</b> 's are executed similarly, except that the data still needs to be received and put somewhere: <br><br><pre> <code class="cpp hljs">QString query = <span class="hljs-string"><span class="hljs-string">"SELECT id, ka FROM Table"</span></span>; <span class="hljs-function"><span class="hljs-function">QSqlQuery </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sqlQ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!sqlQ.exec(query)) { qDebug() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"query failed..."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//–æ—Ç–ª–∏—á–∏—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–π —á–∞—Å—Ç–∏ //–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –µ—â–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∞—Ç—å –∏—Ö while (sqlQ.next()){ //–ø–æ–ª—É—á–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ –∫–æ–º–±–æ–±–æ–∫—Å —Å–æ –≤—Å–µ–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ ui-&gt;ComboBox-&gt;addItem(sqlQ.value(1).toString(),sqlQ.value(0).toInt()); }</span></span></code> </pre><br>  <b>Delete-statement</b> 's are executed exactly as insert because nothing is returned. <br><br><h3>  All right, what's the problem? </h3><br>  And the truth is, because you can implement everything through these expressions and queries, <b>why do we need models?</b> <br><br>  When we have one unrelated table, everything seems very simple and does not require the introduction of additional tools.  Now imagine that we have such tables, for example, 5, each with 5 columns, not including id.  And each has a connection with the previous one with the help of a <b>foreign key</b> via <b>id</b> , i.e.  when deleting, it is necessary to cascadely delete all "child" records.  This leads to a huge number of requests, the application slows down, moreover, it is necessary to update the table and its presentation in the interface each time, which leads to writing additional functions for updating, the appearance of bugs or the risk of their occurrence, and generally a decrease in readability code. <br><br>  It is for this reason that the development process had to abandon the concept of using bare <b>SQL</b> queries. <br><br>  A further choice was made in favor of <b>QSqlRelationalTableModel</b> in conjunction with <b>QTableView</b> .  There is an even simpler version of the model implementation - <b>QSqlTableModel</b> , the first is inherited from it, has all the same methods, but adds the ability to create a <b>QSqlRelation</b> connection, which is very convenient if the user needs to show not the id of the record, but the name of the parent record connected. <br><br><h3>  Let's look at the implementation with the models </h3><br>  I will give pod fragments showing the implementation of model / view. <br><br>  In the header file: <br><br><pre> <code class="cpp hljs">QSqlRelationalTableModel *model;</code> </pre><br>  In the constructor: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–µ–¥–∏–Ω–∏—Ç—å —Å–∏–≥–Ω–∞–ª, —ç–º–∏—Ç–∏—Ä—É–µ–º—ã–π –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ //–Ω–∞ —è—á–µ–π–∫—É QTableView —Å–æ —Å–ª–æ—Ç–æ–º, –≤—ã–∑—ã–≤–∞–µ–º—ã–º —ç—Ç–∏–º —Å–∏–≥–Ω–∞–ª–æ–º //QModelIndex —Ö—Ä–∞–Ω–∏—Ç –≤ —Å–µ–±–µ –∏–Ω–¥–µ–∫—Å —è—á–µ–π–∫–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –±—ã–ª–æ —Å–æ–≤–µ—Ä—à–µ–Ω–æ –Ω–∞–∂–∞—Ç–∏–µ connect(ui-&gt;tableView, SIGNAL(clicked(const QModelIndex &amp;)), this, SLOT(onTableClicked(const QModelIndex &amp;))); model = new QSqlRelationalTableModel(parent, db); //—Å–æ–∑–¥–∞–¥–∏–º –º–æ–¥–µ–ª—å, QSqlDatabase –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ model-&gt;setTable("Table"); //—Å–≤—è–∂–µ–º –º–æ–¥–µ–ª—å —Å —Ç–∞–±–ª–∏—Ü–µ–π</span></span></code> </pre><br>  In the line below is one of the most convenient features and advantages of a model over sql queries - it edits, adds, deletes, depending on the context, the data in the sql table when changing from to QTableView.  Convenience is that you no longer need to control the correctness of cascading data deletion and updating them within one QTableView. <br><br><pre> <code class="cpp hljs">model-&gt;setEditStrategy(QSqlRelationalTableModel::OnFieldChange);</code> </pre><br>  Next comes another handy feature provided by this class: a connection is established between two columns of different tables: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//ParentTable - —Ç–∞–±–ª–∏—Ü–∞, —Å –∫–æ–ª–æ–Ω–∫–æ–π –∫–æ—Ç–æ—Ä–æ–π —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ //id - –ø–∞—Ä–∞–º–µ—Ç—Ä, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –±—É–¥–µ—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω –≤—ã–±–æ—Ä –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ //name - –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–æ–ª–æ–Ω–∫–µ –Ω–∞—à–µ–π —Ç–∞–±–ª–∏—Ü—ã model-&gt;setRelation(1,QSqlRelation("ParentTable", "id", "name"));</span></span></code> </pre><br>  Then everything is more standard: select () will execute the SELECT expression, and setHeaderData () will set the text in the QTableView headers: <br><br><pre> <code class="cpp hljs">model-&gt;select(); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">0</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">1</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"id_sub"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">2</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"count"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">3</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"number"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">4</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"data_word"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">5</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"time"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">6</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"name"</span></span>)); model-&gt;setHeaderData(<span class="hljs-number"><span class="hljs-number">7</span></span>, Qt::Horizontal, tr(<span class="hljs-string"><span class="hljs-string">"description"</span></span>)); ui-&gt;tableView-&gt;setModel(model); <span class="hljs-comment"><span class="hljs-comment">//—É—Å—Ç–∞–Ω–æ–≤–∏–º –Ω–∞—à—É –º–æ–¥–µ–ª—å –Ω–∞ –Ω—É–∂–Ω—ã–π QTableView</span></span></code> </pre><br>  Now the model and tableView work together and perform their functions.  By reference to <a href="https://github.com/petukhovlive/easyManage">github</a> , all the sources will be left; in them I implemented adding an entry to the model, deleting it, as well as filters. <br><br><h3>  Conclusion </h3><br>  In this article, I wanted to encourage all those who are already working with the database in Qt to abandon bare sql queries for projects of at least medium difficulty and go to work with models to simplify their lives, make the code more readable and universal, and just do something good and new. <br><br>  That's all!  I hope that my experience with these classes will help readers to successfully solve a similar problem! </div><p>Source: <a href="https://habr.com/ru/post/435134/">https://habr.com/ru/post/435134/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>