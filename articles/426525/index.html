<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing your own working OS for half a year</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 Hello! I strongly welcome everyone, today I would like to tell you about my experience in writing a workable OS for the x86 architecture....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <div class="page-header-logo-container"></div>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing your own working OS for half a year</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/ls/ly/td/lslytdwoo2svs-n5ndwskwdxzmu.png" alt="image"><br><br><h2>  Prehistory </h2><br>  Hello!  I strongly welcome everyone, today I would like to tell you about my experience in writing a workable OS for the x86 architecture. <br><br>  One spring night I had a brilliant idea - try yourself in writing your own OS, which can allow you to run programs, work with devices, and generally squeeze all the power out of Intel's architecture in your needs: for example, for your factory or something else.  My goal was and is to write such an OS that could allow maximum performance for some specific tasks without spending CPU time on all sorts of excesses.  Basically, I am pursuing only sports interest, gaining experience for myself in system programming and writing drivers for devices that are used everywhere.  What came of it is up to you, I immediately say that you don‚Äôt need to write comments about creating your own Linux distribution, and pursued an interest to write everything from scratch from scratch in order to immerse yourself in the OSDev theme.  Just want to express my deep gratitude to Benjamin Lunt and the OSDev forum, as well as their wiki.  Ben helped me deal with EHCI, which undoubtedly made a huge contribution to my OS - USB devices, they are everywhere!  I was also faced with the task of creating my own architecture convenient for me, not excluding the use of ELF file standards. <a name="habracut"></a>  Well, let's get to the point. <br>  UPD: all the info can be found in the <a href="https://vk.com/butterflyos">pump</a> group, there is also a post with docks and a way (old, now I finish writing docks for the stable version) <br><br><h2>  What is done? </h2><br>  Now my OS is able to work with USB flash drives, mice, keyboards, AHCI disks, PCI IDE controller, APIC and ACPI, preemptive multitasking is implemented, program launch is implemented, streamline work with files, SVB driver running on 0x118 VBE mode, DNS, DHCP, TCP, UPD, IPv4, HTTP, full FAT32 driver, RTL8139 (69) driver and Intel Gigabit Ethernet are working. <br><br>  The window system along with my SVGA implementation makes it possible to produce as much as 120 FPS when the screen is completely redrawn.  Let's move on to how this is all implemented and generally can work. <br><br><h2>  How it works? </h2><br>  To begin with, I wrote a bootloader that reads the secondary bootloader with the kernel from FAT32.  The second boot loader switches to protected mode and jumps into the kernel, there I load and configure IDT, then I initialize the PCI devices, start the kernels, and launch CMD. <br><br>  Someone will ask, how did you achieve such a performance with SVGA?  The answer is simple: an assembler, an assembler, and an assembler again.  Not without SSE instructions that greatly speed up the copying of memory.  For example, here is the code for copying the video buffer in the LFB (Linear Frame Buffer): <br><br><pre><code>.byte 0x60#Save registers in stack
mov %2,%%ecx 	#Repeat count to ecx
mov %0,%%edi 	#Video memory start to edi
mov %1,%%esi 	#Video buffer start to esi
ww1sse2:
	movaps  (%%esi),%%xmm0 #Copy 16 bytes to xmm0 from buffer
	movaps 	%%xmm0,(%%edi) #Copy from xmm0 to video memory
	movaps  16(%%esi),%%xmm0	#16 again, but + 16 from current
	movaps 	%%xmm0,16(%%edi)	#16 again, but + 16 from current
	movaps  32(%%esi),%%xmm0	#16 again, but + 32 from current
	movaps 	%%xmm0,32(%%edi)	#16 again, but + 32 from current
	movaps  48(%%esi),%%xmm0	#16 again, but + 48 from current
	movaps 	%%xmm0,48(%%edi)	#16 again, but + 48 from current
	add 	$64,%%edi	#Add 64 bytes to edi
	add 	$64,%%esi	#Add 64 bytes to esi
	dec%%ecx#Decrement count
	#test 	%%ecx,%%ecx #Compare ecx with zero
	jnz 	ww1sse2 	#If not zero, repeat again
.byte 0x61	#Restore registers from stack
</code></pre><br>
–û–∫–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –û–û–ü –∏, –¥—É–º–∞—é, –Ω–µ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö, –≤—Å—ë –ø–æ—á—Ç–∏ –∫–∞–∫ –≤ —à–∏–Ω–¥–µ.<br>
<br>
–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Å—Ç–µ–π—à–∏–π ‚Äî ¬´Watermark Allocator¬ª. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∑–∞ —Å—á–µ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤ —è–¥—Ä–µ –Ω–µ—Ç —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã –Ω–∞–≥–∞–¥–∏—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥—É, –≤—Å—ë –∑–∞–ø—Ä–æ—Å—ã —Å–¥–µ–ª–∞–Ω—ã —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ —Ç.–ø.<br>
<br>
–ü–æ–∫–∞ —á—Ç–æ –Ω–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –ø–æ—Ç–æ–∫–æ–≤ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞, –Ω–æ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –æ–Ω–∏ –±—É–¥—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã.<br>
–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –¥–∏—Å–∫–æ–≤ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ MS-DOS—É: –æ–¥–Ω–∞ –±—É–∫–≤–∞ ‚Äî –æ–¥–∏–Ω –¥–∏—Å–∫. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–∞–∫ MBR —Ä–∞–∑–¥–µ–ª—ã, —Ç–∞–∫ –∏ GPT —Ä–∞–∑–¥–µ–ª—ã.<br>
<br>
<h2>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä–∞–π–≤–µ—Ä–æ–≤ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h2><br>
–ù–µ –æ–±–æ—à–ª–æ—Å—å —Ç—É—Ç –∏ –±–µ–∑ —ç—Ç–æ–≥–æ ‚Äî –±—Ä–∞—Ç—å —á—É–∂–æ–π –∫–æ–¥ –∫–∞–∫-—Ç–æ –Ω–µ–∫—É–ª—å—Ç—É—Ä–Ω–æ –∏ –Ω–µ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ, –µ—Å–ª–∏ —Ä–∞—Å–∫–∞–ø—ã–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ª–∏–Ω—É–∫—Å–∞ ‚Äî —Ç–∞–∫ –º–æ–∂–Ω–æ –∏ –∑–∞–±–ª—É–¥–∏—Ç—å—Å—è.<br>
<br>
–ï—Å–ª–∏ —á–µ—Å—Ç–Ω–æ, —Ç–æ —è —Å—Ç–æ—Ä–æ–Ω–Ω–∏–∫ —Ç–æ–≥–æ, —á—Ç–æ –≥–ª–∞–≤–Ω–æ–µ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ ‚Äî —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –Ω–æ –≤ —Ç–æ–∂–µ –≤—Ä–µ–º—è —Å—á–∏—Ç–∞—é, —á—Ç–æ –∑–∞ –≥—Ä–∞—Ñ–∏–∫—É –º–æ–∂–Ω–æ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞—Ç—å: –∫ –ø—Ä–∏–º–µ—Ä—É, VIM.<br>
<br>
–ö–æ–Ω–µ—á–Ω–æ, —ç—Ç–æ —Å—Ç–∞–ª–æ —Å–∞–º–æ–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–π —Å—Ç–∞–¥–∏–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–æ–Ω–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, –∞ –ø–æ—Ç–æ–º –ø–æ–Ω—è—Ç—å, —á—Ç–æ —Ç—ã –ø–æ—Å—Ç–∞–≤–∏–ª return –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –∏–∑-–∑–∞ —á–µ–≥–æ —á–∞—Å—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–µ –∑–∞–ø–æ–ª–Ω—è–ª–∞—Å—å –≤–æ–≤—Å–µ. –î—É–º–∞—é, —á—Ç–æ —ç—Ç–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–±—è –Ω–∞–ø—Ä—è—á—å –º–æ–∑–≥, –∏–±–æ –¥–∞–∂–µ –ø–æ—Å–ª–µ –¥–µ—Å—è—Ç–æ–≥–æ –ø—Ä–æ—á—Ç–µ–Ω–∏—è –¥–æ–∫–æ–≤ –∫–∞–∫–∏–µ-—Ç–æ –∞—Å–ø–µ–∫—Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ–±–µ –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã, –∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å—Å—è –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –¥–æ–ª–≥–æ–π –æ—Ç–ª–∞–¥–∫–æ–π –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∂–µ–ª–µ–∑–µ.<br>
<br>
<h2>–û—Ç–ª–∞–¥–∫–∞</h2><br>
–û—Ç–ª–∞–¥–∫–∞ –û–° –∑–∞–Ω–∏–º–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—É—é –∫—É—á—É –≤—Ä–µ–º–µ–Ω–∏: —Å–∫–æ–º–ø–∏–ª–∏—Ç—å —Å–æ—Ä—Å—ã, —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –¥–∏—Å–∫, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑ –¥–∏—Å–∫–∞, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ —ç–º—É–ª—è—Ç–æ—Ä–µ, –ø–æ—Å–ª–µ —á–µ–≥–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –Ω–∞ —Ñ–ª–µ—à–∫—É –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —É–∂–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –∂–µ–ª–µ–∑–µ. –ê –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –æ—Ç–ª–∞–¥—á–∏–∫–æ–≤, –≤—ã–≤–æ–¥–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º, –ª–∏–±–æ –≤ –æ–∫–æ—à–µ—á–∫–∏ ‚Äî –ø–æ–≤–∏—Å–ª–æ ‚Äî —Å—Ç–∞–≤—å return'—ã.<br>
<br>
<h2>–ò—Ç–æ–≥–∏</h2><br>
–î–∞, –û–° –≤—Å—ë –µ—â–µ –≤ —Å—Ç–∞–¥–∏–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Ö–æ—á–µ—Ç—Å—è –ø–æ–¥ –Ω–æ–≤—ã–π –≥–æ–¥ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é –±–µ—Ç–∞-–≤–µ—Ä—Å–∏—é, –∞ –º–æ–∂–µ—Ç –≤ –±—É–¥—É—â–µ–º –¥–∞–∂–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –Ω–∞ –±–æ–ª–µ–µ —Å–µ—Ä—å–µ–∑–Ω–æ–º —É—Ä–æ–≤–Ω–µ.<br>
<br>
–ß—Ç–æ —Ö–æ—á—É —Å–∫–∞–∑–∞—Ç—å –Ω–∞–ø–æ—Å–ª–µ–¥–æ–∫ ‚Äî –µ—Å–ª–∏ —Ç–µ–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –û–° –∫–æ–≥–æ-—Ç–æ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞, –∏–ª–∏ –∫—Ç–æ-—Ç–æ —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å –∞—Å–ø–µ–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Å –∫–∞–∫–∏–º–∏-–ª–∏–±–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏, —Ö–∏—Ç—Ä–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–º–æ—á—å –ø—Ä–æ–µ–∫—Ç—É(–Ω–µ –¥–µ–Ω—å–≥–∞–º–∏, –∞ –∫–æ–¥–æ–º) ‚Äî –º–æ–∂–µ—Ç–µ –æ—Ç–ø–∏—Å–∞—Ç—å –æ–± —ç—Ç–æ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö, –≤—Å–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –±—É–¥—É—Ç —É—á—Ç–µ–Ω—ã, –∏ –≤ –¥–µ—Ç–∞–ª—è—Ö –∏ –∫—Ä–∞—Å–∫–∞—Ö –±—É–¥—É—Ç –æ–ø–∏—Å–∞–Ω—ã –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–µ–µ –≤–∞—Å –∞—Å–ø–µ–∫—Ç—ã.<br>
<br>
–≠—Ç–∏—á–Ω–æ–≥–æ —Ö–∞–∫–∏–Ω–≥–∞!</div><p>Source: <a href="https://habr.com/ru/post/426525/">https://habr.com/ru/post/426525/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>