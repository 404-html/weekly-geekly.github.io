<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Real validation for uniqueness</title>
  <meta name="description" content="Every rubist who has worked with Ruby on Rails is familiar with the ORM ActiveRecord . Let's discuss one of the validations proposed from the box, nam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="https://quick-geek.github.io/search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <section class="page js-page"><h1>Real validation for uniqueness</h1><div class="post__text post__text-html js-mediator-article">  Every rubist who has worked with <a href="https://rubyonrails.org/">Ruby on Rails is</a> familiar with the <a href="https://ru.wikipedia.org/wiki/ORM">ORM</a> <a href="https://github.com/rails/rails/tree/master/activerecord">ActiveRecord</a> .  Let's discuss one of the validations proposed from the box, namely, validation for uniqueness, and why <a href="https://github.com/toptal/database_validations">database_validations</a> gem will save the consistency of your database. <br><a name="habracut"></a><br>  Suppose you have a user model with a unique identity on the <i>email</i> field, i.e. <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt; ApplicationRecord </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">validates</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">email</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">uniqueness</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  You may already know that this validation performs the following request. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> email = $<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  every time we try to save a record to the database. <br><br>  This approach has several drawbacks: <br><br>  <b>First</b> , the execution of an additional request, and if the model initializes several validations for uniqueness, the request will be executed for each of them.  This is not efficient, and also requires the presence of indices if we want these queries to be executed quickly. <br><br>  <b>Secondly</b> , this solution does not guarantee uniqueness due to the possible <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BE%25D1%2581%25D1%2582%25D0%25BE%25D1%258F%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B3%25D0%25BE%25D0%25BD%25D0%25BA%25D0%25B8">race for data</a> .  Several competitive operations can simultaneously find out about the absence of a specific record, as a result of which, keep the same data. <br><br>  Of course, it is possible to allow rare cases with data race by adding a unique constraint at the database level.  But in this case, you will not get a validation error, the query to the database will simply fall and the entire transaction will be rolled back. <br><br>  Gem <a href="https://github.com/toptal/database_validations">database_validations</a> , which provides compatibility between database constraints and validations, will help in this situation. <br><br>  The main meaning of gem is presented in the following code: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(options = {})</span></span></span></span> ActiveRecord::Base.connection.transaction(<span class="hljs-symbol"><span class="hljs-symbol">requires_new:</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">rescue</span></span> ActiveRecord::RecordNotUnique =&gt; e Helpers.handle_unique_error!(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, e) <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br>  Thus, we try to save the data, if all other validations are passed, if the transaction drops and rolls back, we parse the error and set the correct values ‚Äã‚Äãin the <code>errors</code> our object. <br><br>  After reviewing the <a href="https://github.com/toptal/database_validations">documentation</a> and <a href="https://github.com/toptal/database_validations">benchmarks</a> , we can conclude that this gem will speed up the process of saving records in the database at least twice. <br><br>  With support for databases such as <i>PostgreSQL</i> , <i>SQLite</i> , <i>MySQL,</i> and backward compatibility with <code>validates_uniqueness_of</code> , the replacement process for <code>validates_db_uniqueness_of</code> takes a few minutes. <br><br>  A convenient matcher for RSpec is also present out of the box: <br><br><pre> <code class="ruby hljs">specify <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(described_class) .to validate_db_uniqueness_of(<span class="hljs-symbol"><span class="hljs-symbol">:field</span></span>) .with_message(<span class="hljs-string"><span class="hljs-string">'duplicate'</span></span>) .with_where(<span class="hljs-string"><span class="hljs-string">'(some_field IS NULL)'</span></span>) .scoped_to(<span class="hljs-symbol"><span class="hljs-symbol">:another_field</span></span>) .with_index(<span class="hljs-symbol"><span class="hljs-symbol">:unique_index</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  When you switch to a new validation, you need to have uniqueness restrictions in the database, but if they are not there yet, gem will indicate this during the launch of the application. <br><br>  The heme has been tested on an application with 100+ uniqueness validations among 50+ models. <br><br>  Use gems and share opinions.  Any contribution to further development is welcome! </div><p>Source: <a href="https://habr.com/ru/post/431298/">https://habr.com/ru/post/431298/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>