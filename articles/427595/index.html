<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Try Micronaut or Honey, I have reduced the framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Try Micronaut or Honey, I have reduced the framework 


 About micronaut framework, I caught a glimpse of the mailing list digest. I wondered what kin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Try Micronaut or Honey, I have reduced the framework</h1><div class="post__text post__text-html js-mediator-article"><h2 id="probuem-micronaut-ili-dorogaya-ya-umenshil-freymvork">  Try Micronaut or Honey, I have reduced the framework </h2><br><p>  About micronaut framework, I caught a glimpse of the mailing list digest.  I wondered what kind of animal it was.  The framework is set in contrast to the Spring stuffed with all the necessary tools. </p><br><p><img src="https://habrastorage.org/webt/eu/iq/eq/euiqeqqehjcvuto1psel_ajypw4.jpeg" alt="Micronaut"></p><br><p>  Anticipating the upcoming conference for developers, where they would just tell and show how to use micronaut in your microservices, I decided to prepare at least once and come at least with some context in my head, with a certain set of problems and questions.  Run homework, so to speak.  I decided to relax some small pet-project for a couple of evenings (as it goes).  At the end of the article there will be a link to the repository of all project sources. </p><a name="habracut"></a><br><blockquote>  Micronaut is a JVM framework, supports three development languages: Java, Kotlin, Groovy.  It was developed by OCI, the same company that gave us Grails.  It has a clipping in the form of a cli-application and a set of recommended libraries (various reactive-http and database clients) <br><br>  There is a DI that implements and repeats the ideas of Spring, adding a number of its own chips - asynchronous, support for AWS Lambda, Client Side Load Balancing. </blockquote><p>  <em>The idea of ‚Äã‚Äãthe service:</em> a friend of mine once bought a half-dozen assorted cryptocurrencies with a fool, investing in non-consumed vacation pay and a nest of a winter jacket.  We all know that the volatility of this whole cryptocurrency substance is wild, and the topic itself is generally unpredictable, a friend eventually decided to take care of his nerves and just forget about what happens to his ‚Äúassets‚Äù.  But sometimes you still want to look, but what about all this is suddenly rich.  So the idea of ‚Äã‚Äãa simple panel (dashboard, like Grafana or something simpler) appeared, a certain web page with dry information, how much it all costs now in a certain fiat currency (USD, RUR). </p><br><h3 id="disclaimers">  Disclaimers </h3><br><ol><li>  Let us leave the expediency of writing our own solution overboard; we just need to try out the new framework on something smarter than HelloWorld. </li><li>  Calculation algorithm, expected errors, errors, etc.  (at least for the first phase of the product), the validity of the choice of cryptobirds for pulling information, a friend‚Äôs ‚Äúinvestment‚Äù crypto portfolio will also be out of the bracket and not subject to discussion or any deep analytics. </li></ol><br><p>  So, a small set of requirements: </p><br><ol><li>  Web service (access from the outside, via http) </li><li>  Display of the page in the browser with a summary of the total value of the cryptocurrency portfolio </li><li>  Ability to configure the portfolio (choose JSON format for loading and unloading the structure of the portfolio).  Some REST API for updating the portfolio and loading it, i.e.  2 API: to save / update - POST, to upload - GET.  The structure of the portfolio is essentially a simple form of the form. <br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">BTC</span></span> ‚Äì –∫—É–ø–∏–ª 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00005</span></span> –µ–¥. <span class="hljs-selector-tag"><span class="hljs-selector-tag">XEM</span></span> ‚Äì –∫—É–ø–∏–ª 4<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> –µ–¥. ...</code> </pre> </li><li>  Data is taken from cryptobirth and currency exchange sources (for fiat currencies) </li><li>  Rules for calculating the total value of the portfolio: <br><img src="https://habrastorage.org/webt/95/ai/fn/95aifnv4r6bngnaeqrb9tlu2hfy.png" alt="Formulas for calculating the total value of the portfolio"><br></li></ol><br><br><p>  Of course, everything that is written in clause 5 is the subject of separate disputes and doubts, but let it be that business wanted it that way. </p><br><h2 id="start-proekta">  Project start </h2><br><p>  So, go to the framework's official website and see how we can start developing.  The official site offers to install the sdkman tool.  A thing that facilitates the development and management of projects on the micronaut framework (and others including, for example, Grails). <br></p><br><img src="https://habrastorage.org/webt/af/rd/3z/afrd3zhw_oodv3s1kroj5vx6bgu.png" alt="The same manager of various SDK"><br><br>  A small remark: If you just start project initialization without any keys, then by default the gradle collector is selected.  Delete the folder, try again, this time with the key: <br><pre> <code class="hljs pgsql">mn <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-app com.room606.cryptonaut -b=maven</code> </pre> <br><p>  An interesting point is also that, like Spring Tool Suite, sdkman offers you at the stage of creating a project to ask which ‚Äúcubes‚Äù you want to use at the start.  I didn‚Äôt experiment with that much, I also created it with a default preset. </p><br><p>  Finally, we open the project in Intellij Idea and admire the set of sources and resources and blanks that supplied us with a wizard for creating a micronaut project. <br></p><br><img src="https://habrastorage.org/webt/8n/oh/ko/8nohkocdymxsv2ctnkqlvnvr1x4.png" alt="Naked project structure"><br><br>  The eye clings to the Dockerfile file <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">FROM</span></span> openjdk:8u171-alpine3.<span class="hljs-number"><span class="hljs-number">7</span></span> RUN apk --<span class="hljs-literal"><span class="hljs-literal">no</span></span>-cache add curl COPY target/cryptonaut<span class="hljs-regexp"><span class="hljs-regexp">*.jar</span></span> cryptonaut.jar CMD java <span class="hljs-variable"><span class="hljs-variable">${JAVA_OPTS}</span></span> -jar cryptonaut.jar</code> </pre> <br><p>  Well, this is fun and commendable.  We were immediately equipped with a tool to quickly output the application to the Prod / INT / QA / whatever environment.  For this mental plus sign to the project. </p><br><p>  All you need to do is to build the Maven project, then build the Docker image and publish it to your Docker registry, or simply export the image binaries as an option to your CI system, as you please. </p><br><p>  In the resource folder, we also prepared a blank for us with application configuration parameters (similar to application.properties in Spring), as well as a config file for the logback library.  Cool! </p><br><p>  We go to the entry point of the application and study the class.  We see a picture painfully familiar to us from Spring Boot.  Here, the developers of the framework also did not become wise and invent anything. </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ Micronaut.run(Application.class); }</code> </pre> <br><p>  Compare it with the familiar Spring code. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { SpringApplication.run(Application.class, args); }</code> </pre> <br><p>  Those.  we also raise the IoC container with all the bins that come into operation as they are needed.  A little run on the official documentation, slowly begin development. </p><br><p>  <em>We will need:</em> </p><br><ol><li>  Domain Models </li><li>  Controllers for implementing REST API. </li><li>  Data storage layer (Database client or ORM or something else) </li><li>  The code of consumers of data from cryptographic and fiat currency exchange data.  Those.  we need to write the simplest customers for 3rd party services.  In Spring, RestTemplate known to us was well suited for this role. </li><li>  The minimum configuration for flexible management and application start (think about what and how we will make in the configuration) </li><li>  Tests!  Yes, in order to confidently and safely code and implement new functionality we need to be confident in the stability of the old </li><li>  Caching  This is not a basic requirement, but something that would be nice to have for good performance, and in our scenario there are places where caching is definitely a good tool. <br>  Spoiler: here everything goes very bad. </li></ol><br><h3 id="modeli-predmetnoy-oblasti">  Domain Models </h3><br><p>  The following models will suffice for our purposes: cryptocurrency portfolio models, fiat currency exchange rates, fiat currency cryptocurrency prices, total portfolio value. </p><br><p>  Below is the code for only pairs of models, the rest can be viewed <a href="">in the repository</a> .  And yes, I was too lazy to screw <code>Lombok</code> on this project. </p><br><pre> <code class="hljs java">Portfolio.java <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.domain; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TreeMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Portfolio</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, BigDecimal&gt; coins = Collections.emptyMap(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCoins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeMap&lt;&gt;(coins); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCoins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, BigDecimal&gt; coins)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.coins = coins; }</code> </pre> <br><pre> <code class="hljs cs">FiatRate.java package com.room606.cryptonaut.domain; import java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FiatRate</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String counter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FiatRate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">base</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String counter, BigDecimal </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = counter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">base</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String counter</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BigDecimal </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Price</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Prices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> (–∞–≥—Ä–µ–≥–∞—Ç) ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Total</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> ...</code> </pre> <br><h3 id="kontrollery">  Controllers </h3><br><p>  We try to write a controller that implements the simplest API, issuing the cost of cryptocurrency for given letter codes of coins. <br>  Those. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /cryptonaut/restapi/prices.json?coins=BTC&amp;coins=ETH&amp;fiatCurrency=RUR</code> </pre> <br><p>  Must issue something like: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"prices"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"coin"</span></span>:<span class="hljs-string"><span class="hljs-string">"BTC"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-number"><span class="hljs-number">407924.043300000000</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"coin"</span></span>:<span class="hljs-string"><span class="hljs-string">"ETH"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-number"><span class="hljs-number">13040.638266000000</span></span>}],<span class="hljs-attr"><span class="hljs-attr">"fiatCurrency"</span></span>:<span class="hljs-string"><span class="hljs-string">"RUR"</span></span>}</code> </pre> <br><p>  According to the <a href="https://docs.micronaut.io/latest/guide/index.html">documentation</a> , nothing complicated and resembles the same approaches and conventions of <code>Spring</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.rest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Price; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Prices; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.CryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.MediaType; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Stream; <span class="hljs-meta"><span class="hljs-meta">@Controller(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/cryptonaut/restapi/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MarketDataController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CryptoMarketDataService cryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FiatExchangeRatesService fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MarketDataController(CryptoMarketDataService cryptoMarketDataService, FiatExchangeRatesService fiatExchangeRatesService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cryptoMarketDataService = cryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fiatExchangeRatesService = fiatExchangeRatesService; } <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/prices.json"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Prices pricesAsJson(<span class="hljs-meta"><span class="hljs-meta">@QueryValue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"coins"</span></span></span><span class="hljs-meta">)</span></span> String[] coins, <span class="hljs-meta"><span class="hljs-meta">@QueryValue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fiatCurrency"</span></span></span><span class="hljs-meta">)</span></span> String fiatCurrency) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getPrices(coins, fiatCurrency); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Prices getPrices(String[] coins, String fiatCurrency) { List&lt;Price&gt; prices = Stream.of(coins) .map(coin -&gt; new Price(coin, cryptoMarketDataService.getPrice(coin, fiatCurrency))) .collect(Collectors.toList()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Prices(prices, fiatCurrency); } }</code> </pre> <br><p>  Those.  we calmly indicate our <code>POJO</code> returned type, and without configuring any serializers / deserializers, even without hanging additional Micronaut annotations from the box, build the correct http body with the data.  Let's compare with the <code>Spring</code> way: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@RequestMapping(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/prices.json"</span></span></span><span class="hljs-meta">, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ResponseEntity&lt;Prices&gt; pricesAsJson(<span class="hljs-meta"><span class="hljs-meta">@RequestParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"userId"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] coins, <span class="hljs-meta"><span class="hljs-meta">@RequestParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fiatCurrency"</span></span></span><span class="hljs-meta">)</span></span> String fiatCurrency) {</code> </pre> <br><p>  In general, I had no problems with controllers, they just worked as expected from them, according to the documentation.  Their writing was intuitive and simple.  Moving on. </p><br><h3 id="sloy-hraneniya-dannyh">  Data storage layer </h3><br><p>  For the first version of the application, we will store only the user's portfolio.  In general, we will store only one portfolio of one user.  Simply put, we will not yet have support for a multitude of users, only one main user with his cryptocurrency portfolio.  That's cool! </p><br><p>  For the implementation of data persistence, the documentation offers variants with JPA connections, as well as fragmentary examples of using various clients to read from the database (section ‚Äú12.1.5 Configuring Postgres‚Äù).  <code>JPA</code> strongly discarded and preference was given to handwriting requests and manipulating them.  The database configuration has been added to application.yml ( <code>Postgres</code> was selected as the RDBMS), according to the documentation: </p><br><pre> <code class="hljs pgsql">postgres: reactive: client: port: <span class="hljs-number"><span class="hljs-number">5432</span></span> host: localhost <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: cryptonaut <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: crypto <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: r1ch13r1ch maxSize: <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><p>  A <code>postgres-reactive</code> library has been added.  This is a client for working with the database both in an asynchronous manner and in a synchronous manner. </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.micronaut.configuration<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>postgres-reactive<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0.M4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>compile<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  And, finally, a <code>docker-compose.yml</code> file was added to the / <code>docker-compose.yml</code> to deploy the future environment of our application, where the database component was added: </p><br><pre> <code class="hljs pgsql">db: image: postgres:<span class="hljs-number"><span class="hljs-number">9.6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: POSTGRES_USER: crypto POSTGRES_PASSWORD: r1ch13r1ch POSTGRES_DB: cryptonaut ports: - <span class="hljs-number"><span class="hljs-number">5432</span></span>:<span class="hljs-number"><span class="hljs-number">5432</span></span> volumes: - ${PWD}/../db/init_tables.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>:/docker-entrypoint-initdb.d/<span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>_init_tables.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span></code> </pre> <br><p>  Below is the initialization script database with a very simple table structure: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> portfolio ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> coin_amt_primary_key PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, coin <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span>, amount <span class="hljs-built_in"><span class="hljs-built_in">NUMERIC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre> <br><p>  Now we will try to distribute the code that updates the user's portfolio.  Our component for working with the portfolio will look like this: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadPortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Optional&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateTotalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio, String fiatCurrency)</span></span></span></span>; }</code> </pre> <br><p>  Looking at the set of client methods of the <code>Postgres reactive client</code> We throw in this class: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.CryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.context.annotation.Requires; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.reactiverse.pgclient.Numeric; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.reactiverse.reactivex.pgclient.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PgPool pgPool; ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String UPDATE_COIN_AMT = <span class="hljs-string"><span class="hljs-string">"INSERT INTO portfolio (coin, amount) VALUES (?, ?) ON CONFLICT (coin) "</span></span> + <span class="hljs-string"><span class="hljs-string">"DO UPDATE SET amount = ?"</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Tuple&gt; records = portfolio.getCoins() .entrySet() .stream() .map(entry -&gt; Tuple.of(entry.getKey(), Numeric.create(entry.getValue()), Numeric.create(entry.getValue()))) .collect(Collectors.toList()); pgPool.preparedBatch(UPDATE_COIN_AMT, records, pgRowSetAsyncResult -&gt; { <span class="hljs-comment"><span class="hljs-comment">//–ù–µ –¥–µ–ª–∞–π—Ç–µ —Ç–∞–∫ pgRowSetAsyncResult.cause().printStackTrace(); }); return portfolio; } ... }</span></span></code> </pre> <br><p>  We start the environment, try to update our portfolio through the prudently implemented in advance API: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rest</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PortfolioService</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.domain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Portfolio</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.micronaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MediaType</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.micronaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.annotation</span></span>.*; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">javax</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.inject</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Inject</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">Controller</span></span>("/<span class="hljs-keyword"><span class="hljs-keyword">cryptonaut</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">restapi</span></span>/") public class ConfigController { @<span class="hljs-keyword"><span class="hljs-keyword">Inject</span></span> private PortfolioService portfolioService; @<span class="hljs-keyword"><span class="hljs-keyword">Post</span></span>("/<span class="hljs-keyword"><span class="hljs-keyword">portfolio</span></span>") @Produces(MediaType.APPLICATION_JSON) @Consumes(MediaType.APPLICATION_JSON) public Portfolio savePortfolio(@Body Portfolio portfolio) { <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">portfolioService</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.savePortfolio</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">portfolio</span></span>); }</code> </pre> <br><p>  Perform a <code>curl</code> request: </p><br><pre> <code class="hljs erlang">curl http://localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span>/cryptonaut/restapi/portfolio -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> --data '{<span class="hljs-string"><span class="hljs-string">"coins"</span></span>: {<span class="hljs-string"><span class="hljs-string">"XRP"</span></span>: <span class="hljs-string"><span class="hljs-string">"35.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"LSK"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.03"</span></span>, <span class="hljs-string"><span class="hljs-string">"XEM"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.23"</span></span>}}' -v</code> </pre> <br><p>  And ... we catch an error in the logs: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PgException</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">syntax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">or</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">near</span></span> "," <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PrepareStatementCommand</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.handleErrorResponse</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">PrepareStatementCommand</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:74)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.codec</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decodeError</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:250)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.codec</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decodeMessage</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:139)</span></span> ...</code> </pre> <br><p>  Having scratched our turnips, we don‚Äôt find any solution in the official dock, we try to google the dock for the <code>postgres-reactive</code> , and this turns out to be the right solution, as there are detailed examples and the correct query syntax.  The point was in the placeholder parameters, it turns out that you need to apply numbered tags of the form <code>$x ($1, $2, etc.)</code> .  So the fix is ‚Äã‚Äãto rewrite the target query: </p><br><pre> <code class="hljs sql">private static final String UPDATE_COIN_AMT = "<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> portfolio (coin, amount) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (coin) <span class="hljs-string"><span class="hljs-string">" + "</span></span><span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> amount = $<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-string"><span class="hljs-string">";</span></span></code> </pre> <br><p>  Restart the application, try the same <code>REST</code> request ... hurray.  The data is added up.  Let's go on to read. </p><br><p>  We are faced with the simplest task to read the user's cryptocurrency portfolio from the database and map them to a POJO object.  For these purposes, we use the pgPool.query method (SELECT_COINS_AMTS, pgRowSetAsyncResult): </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Portfolio loadPortfolio() { Map&lt;String, BigDecimal&gt; coins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); pgPool.query(SELECT_COINS_AMTS, pgRowSetAsyncResult -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pgRowSetAsyncResult.succeeded()) { PgRowSet <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> = pgRowSetAsyncResult.result(); PgIterator pgIterator = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pgIterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = pgIterator.next(); coins.put(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getString("coin"), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getFloat("amount"))); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("Failure: " + pgRowSetAsyncResult.cause().getMessage()); } }); Portfolio portfolio = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Portfolio(); portfolio.setCoins(coins); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; }</code> </pre> <br><p>  We connect all this together with the controller responsible for the cryptocurrency portfolio: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Controller(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/cryptonaut/restapi/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigController</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/portfolio"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Portfolio loadPortfolio() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolioService.loadPortfolio(); } ...</code> </pre> <br><p>  Restart the service.  For testing, first fill this very portfolio with at least some data: </p><br><pre> <code class="hljs erlang">curl http://localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span>/cryptonaut/restapi/portfolio -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> --data '{<span class="hljs-string"><span class="hljs-string">"coins"</span></span>: {<span class="hljs-string"><span class="hljs-string">"XRP"</span></span>: <span class="hljs-string"><span class="hljs-string">"35.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"LSK"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.03"</span></span>, <span class="hljs-string"><span class="hljs-string">"XEM"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.23"</span></span>}}' -v</code> </pre> <br><p>  Now finally test our code reading from the database: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> http://localhost:8080/cryptonaut/restapi/portfolio -v</code> </pre> <br><p>  And ... we get ... something strange: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"coins"</span></span>:{}}</code> </pre> <br><p>  Pretty strange isn't it?  We recheck the request ten times, try to make the <code>curl</code> request again, even restart our service.  The result is still the same wild ... After reading the signature of the method, and also remembering that we have a <code>Reactive Pg client</code> , we come to the conclusion that we are dealing with asynchronous.  Thoughtful debag confirmed this!  It was worth a little slowly podobezhit code, like voila, we returned non-empty data! </p><br><p>  Once again, referring to the library dock, rolling up our sleeves to rewrite the code on a truly blocking, but completely predictable: </p><br><pre> <code class="hljs pgsql">Map&lt;String, BigDecimal&gt; coins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); PgIterator pgIterator = pgPool.rxPreparedQuery(SELECT_COINS_AMTS).blockingGet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pgIterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = pgIterator.next(); coins.put(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getString("coin"), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getValue("amount").toString())); }</code> </pre> <br><p>  Now we get what we expect.  This problem was solved, moving on. </p><br><h3 id="pishem-klient-dlya-polucheniya-dannyh-po-rynkam">  We write the client to obtain data on the markets </h3><br><p>  Here, of course, I would like to solve the problem with the least amount of bicycles.  The result was two solutions: </p><br><ul><li>  ready-made client libraries for accessing specific cryptochemicals </li><li>  a small, personally written client code for applying for the exchange rate.  It came in handy that out of the box offers Micronaut. </li></ul><br><p>  With ready libraries everything is not so interesting.  I will only note that during a quick search, the project <a href="https://github.com/knowm/XChange">https://github.com/knowm/XChange</a> was chosen. </p><br><p>  In principle, the library's architecture is as simple as two kopecks - there is a set of interfaces for receiving data, main interfaces and classes of <code>Ticker</code> models (you can learn <code>bid</code> , <code>ask</code> , all sorts of open price, close price etc.), <code>CurrencyPair</code> , <code>Currency</code> .  Further, you initialize the implementations themselves in the code by first connecting the implementation with the implementation that addresses the specific crypto-exchange for this purpose.  And the main class through which we act is <code>MarketDataService.java</code> </p><br><p>  For example, for our experiments, for the beginning, we will be satisfied with this ‚Äúconfiguration‚Äù: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.knowm.xchange<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>xchange-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.3.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.knowm.xchange<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>xchange-bittrex<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.3.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Below is the code that performs the key function - calculating the value of a particular cryptocurrency in fiat terms (see the Formulas described in the beginning of the article in the requirements block): </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.markets; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.exceptions.CryptonautException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.currency.Currency; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.currency.CurrencyPair; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.dto.marketdata.Ticker; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.exceptions.CurrencyPairNotValidException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.service.marketdata.MarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CryptoMarketDataService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FiatExchangeRatesService fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MarketDataService marketDataService; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CryptoMarketDataService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FiatExchangeRatesService fiatExchangeRatesService, MarketDataServiceFactory marketDataServiceFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fiatExchangeRatesService = fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketDataService = marketDataServiceFactory.getMarketDataService(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String coinCode, String fiatCurrencyCode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ BigDecimal price = getPriceForBasicCurrency(coinCode, Currency.USD.getCurrencyCode()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Currency.USD.equals(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> price; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> price.multiply(fiatExchangeRatesService.getFiatPrice(Currency.USD.getCurrencyCode(), fiatCurrencyCode)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPriceForBasicCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String coinCode, String fiatCurrencyCode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ Ticker ticker = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ticker = marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticker.getBid(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CurrencyPairNotValidException e) { ticker = getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), Currency.BTC); Ticker ticker2 = getTicker(Currency.BTC, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticker.getBid().multiply(ticker2.getBid()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptonautException(<span class="hljs-string"><span class="hljs-string">"Failed to get price for Pair "</span></span> + coinCode + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + fiatCurrencyCode + <span class="hljs-string"><span class="hljs-string">": "</span></span> + e.getMessage(), e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Ticker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTicker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Currency base, Currency counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(base, counter)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CurrencyPairNotValidException | IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptonautException(<span class="hljs-string"><span class="hljs-string">"Failed to get price for Pair "</span></span> + base.getCurrencyCode() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + counter.getCurrencyCode() + <span class="hljs-string"><span class="hljs-string">": "</span></span> + e.getMessage(), e); } } }</code> </pre> <br><p>  Everything here is done as much as possible using our own interfaces in order to slightly abstract away from the specific implementations provided by the project <a href="https://github.com/knowm/XChange">https://github.com/knowm/XChange</a> . </p><br><p>  In view of the fact that on many, if not on all cryptobirds in circulation, only a limited set of fiat currencies (USD, EUR, perhaps that's all ..), for the final answer to the user's question, you need to add another source of data - fiat currency rates, and also an additional converter.  Those.  To answer the question of how much the WTF cryptocurrency in the RUR (target currency, target currency) now costs, you will have to answer two sub-questions: WTF / BaseCurrency (consider that USD), BaseCurrency / RUR, then multiply these two values ‚Äã‚Äãand return as a result. </p><br><p>  For our first version of the service, we will maintain only USD and RUR as target currencies. <br>  So, in order to support RUR, it would be advisable to take sources that are relevant to the geographical location of the service (we will host and use it exclusively in Russia).  In short, we are satisfied with the course of the Central Bank.  On the Internet, an open source of such data was found, which can be consumed as JSON.  Perfectly. </p><br><p>  Below is the response of the service to the request for the current exchange rate: </p><br><pre> <code class="hljs objectivec">{ <span class="hljs-string"><span class="hljs-string">"Date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-16T11:30:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"PreviousDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-13T11:30:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"PreviousURL"</span></span>: <span class="hljs-string"><span class="hljs-string">"\/\/www.cbr-xml-daily.ru\/archive\/2018\/10\/13\/daily_json.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"Timestamp"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-15T23:00:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"Valute"</span></span>: { <span class="hljs-string"><span class="hljs-string">"AUD"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01010"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"036"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"AUD"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"–†—í–†–Ü–°–É–°‚Äö–°–Ç–†¬∞–†¬ª–†—ë–†‚Ññ–°–É–†—î–†—ë–†‚Ññ –†“ë–†—ï–†¬ª–†¬ª–†¬∞–°–Ç"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">46.8672</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">46.9677</span></span> }, <span class="hljs-string"><span class="hljs-string">"AZN"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01020A"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"944"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"AZN"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"–†—í–†¬∑–†¬µ–°–Ç–†¬±–†¬∞–†‚Ññ–†“ë–†¬∂–†¬∞–†–Ö–°–É–†—î–†—ë–†‚Ññ –†—ò–†¬∞–†–Ö–†¬∞–°‚Äö"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">38.7567</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">38.8889</span></span> }, <span class="hljs-string"><span class="hljs-string">"GBP"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01035"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"826"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"GBP"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"–†¬§–°—ì–†–Ö–°‚Äö –°–É–°‚Äö–†¬µ–°–Ç–†¬ª–†—ë–†–Ö–†—ñ–†—ï–†–Ü –†–é–†—ï–†¬µ–†“ë–†—ë–†–Ö–†¬µ–†–Ö–†–Ö–†—ï–†—ñ–†—ï –†—î–†—ï–°–Ç–†—ï–†¬ª–†¬µ–†–Ü–°–É–°‚Äö–†–Ü–†¬∞"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">86.2716</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">87.2059</span></span> }, ...</code> </pre> <br><p>  Actually, below is the client code <code>CbrExchangeRatesClient</code> : </p><br><pre> <code class="hljs pgsql">package com.room606.cryptonaut.markets.clients; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.JsonNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectMapper; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.exceptions.CryptonautException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.HttpRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.client.Client; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.client.RxHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; @Singleton <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CbrExchangeRatesClient { private static final String CBR_DATA_URI = "https://www.cbr-xml-daily.ru/daily_json.js"; @Client(CBR_DATA_URI) @Inject private RxHttpClient httpClient; private final ObjectReader objectReader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ObjectMapper().reader(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Map&lt;String, BigDecimal&gt; getRates() { try { //<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ratesCache.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("fiatRates"); HttpRequest&lt;?&gt; req = HttpRequest.<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>(""); String response = httpClient.retrieve(req, String.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>).blockingSingle(); JsonNode <span class="hljs-type"><span class="hljs-type">json</span></span> = objectReader.readTree(response); String usdPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("USD").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); String eurPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("EUR").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); String gbpPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("GBP").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); Map&lt;String, BigDecimal&gt; prices = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); prices.put("USD", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(usdPrice)); prices.put("GBP", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(gbpPrice)); prices.put("EUR", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(eurPrice)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prices; } catch (IOException e) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CryptonautException("Failed to obtain exchange rates: " + e.getMessage(), e); } } }</code> </pre> <br><p>  Here we inject <code>RxHttpClient</code> , a component from the <code>Micronaut</code> .  It also gives us the choice to do asynchronous request processing or blocking.  Choose a classic blocking: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">httpClient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.retrieve</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">req</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">String</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.class</span></span>)<span class="hljs-selector-class"><span class="hljs-selector-class">.blockingSingle</span></span>();</code> </pre> <br><h3 id="konfiguraciya">  Configuration </h3><br><p>  In the project, you can highlight things that change and affect business logic or some specific aspects.  Let's make a list of supported fiatnnyh currencies as a property and we will inject it at the start of the application. </p><br><p>  The following code will discard currency codes for which we are unable to calculate the value of the portfolio for the time being: </p><br><pre> <code class="hljs javascript">public BigDecimal getFiatPrice(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> baseCurrency, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> counterCurrency) throws NotSupportedFiatException { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!supportedCounterCurrencies.contains(counterCurrency)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotSupportedFiatException(<span class="hljs-string"><span class="hljs-string">"Counter currency not supported: "</span></span> + counterCurrency); } <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; rates = cbrExchangeRatesClient.getRates(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rates.get(baseCurrency); }</code> </pre> <br><p>  Accordingly, our intention is to somehow inject the value from <code>application.yml</code> into the variable <code>supportedCounterCurrencies</code> . </p><br><p>  In the first version such code was written, below the field of the class FiatExchangeRatesService.java: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${cryptonaut.currencies:RUR}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String supportedCurrencies; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;String&gt; supportedCounterCurrencies = Arrays.asList(supportedCurrencies.split(<span class="hljs-string"><span class="hljs-string">"[,]"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre> <br><p>  Here, the <code>placeholder</code> corresponds to the following structure of the <code>application.yml</code> document: </p><br><pre> <code class="hljs pgsql">micronaut: application: <span class="hljs-type"><span class="hljs-type">name</span></span>: cryptonaut #Uncomment <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: port: <span class="hljs-number"><span class="hljs-number">8080</span></span> postgres: reactive: client: port: <span class="hljs-number"><span class="hljs-number">5432</span></span> host: localhost <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: cryptonaut <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: crypto <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: r1ch13r1ch maxSize: <span class="hljs-number"><span class="hljs-number">5</span></span> # app / business logic specific properties cryptonaut: currencies: "RUR"</code> </pre> <br><p>  Running the app, quick smoke test ... Error! </p><br><pre> <code class="hljs dos">Caused by: io.micronaut.context.exceptions.BeanInstantiationException: Error instantiating bean of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> [com.room606.cryptonaut.markets.CryptoMarketDataService] <span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> Taken: new MarketDataController([CryptoMarketDataService cryptoMarketDataService],FiatExchangeRatesService fiatExchangeRatesService) --&gt; new CryptoMarketDataService([FiatExchangeRatesService fiatExchangeRatesService],MarketDataServiceFactory marketDataServiceFactory) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.doCreateBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1266</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.createAndRegisterSingleton(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1677</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBeanForDefinition(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1447</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBeanInternal(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1427</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">852</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.AbstractBeanDefinition.getBeanForConstructorArgument(AbstractBeanDefinition.java:<span class="hljs-number"><span class="hljs-number">943</span></span>) ... <span class="hljs-number"><span class="hljs-number">36</span></span> common frames omitted Caused by: java.lang.NullPointerException: null <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService.&lt;init&gt;(FiatExchangeRatesService.java:<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.room606.cryptonaut.markets.$FiatExchangeRatesServiceDefinition.build(Unknown Source) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.doCreateBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1252</span></span>) ... <span class="hljs-number"><span class="hljs-number">41</span></span> common frames omitted</code> </pre> <br><p> –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ <code>Micronaut</code> —Ç–∞–∫–∂–µ –∫–∞–∫ –∏ <code>Spring</code> –∑–¥–µ—Å—å –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤—Å—ë —Ç–∞–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –º–∞–≥–∏—á–µ—Å–∫–∏ –≤–æ –≤—Ä–µ–º—è <code>compile time</code> . –î–æ—Å–∞–¥–Ω–æ –ø–æ–∫–æ—Ä–∏–≤ —Å–µ–±—è –∑–∞ —Ç–∞–∫—É—é –æ—à–∏–±–∫—É –Ω–µ–ø–æ–Ω–∏–º–∞–Ω–∏—è, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–¥ –≤ —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${cryptonaut.currencies:RUR}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String supportedCurrencies; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;String&gt; supportedCounterCurrencies; <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> void <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { supportedCounterCurrencies = Arrays.asList(supportedCurrencies.split(<span class="hljs-string"><span class="hljs-string">"[,]"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>)); }</code> </pre> <br><p> –î–∞, —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π –¥—Ä—É–≥ ‚Äì <code>javax.annotation.PostConstruct</code> , –Ω–∞—Å –∑–¥–µ—Å—å –≤—ã—Ä—É—á–∏–ª –∏ –ø—Ä–æ–∏–Ω–∂–µ–∫—Ç–∏–ª –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –º–æ–º–µ–Ω—Ç, –∫–æ–≥–¥–∞ –±–∏–Ω —É–∂–µ —Ä–æ–¥–∏–ª—Å—è, –∂–∏–≤ –∏ –≥–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã, –Ω–æ —Å–∞–º–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –µ—â–µ –Ω–µ –æ–±—ä—è–≤–∏–ª–æ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏. –°–∞–º—ã–π –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è –Ω–∞—Å. </p><br><p> –í —Ü–µ–ª–æ–º, —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –º–µ—Ö–∞–Ω–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –∏ –≤ Spring. –ù–∞—Ä—è–¥—É —Å —ç—Ç–∏–º micronaut —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ <code>@Property</code> –¥–ª—è —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –ø–∞—á–∫–∏ —Å–≤–æ–π—Å—Ç–≤ –≤ –æ–±—ä–µ–∫—Ç <code>Map&lt;String, String&gt;</code> , –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é <code>@Configuration</code> –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π, <code>Random Properties</code> (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–æ–∂–Ω–æ –ø—Ä–æ–∏–Ω–∂–µ–∫—Ç–∏—Ç—å –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É –∫–∞–∫ <code>ID</code> –Ω–µ–∫–æ–π —Å—É—â–Ω–æ—Å—Ç–∏, —É–¥–æ–±–Ω–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–≥–∞—Ç—å –∫–∞–∫–∏—Ö-–Ω–∏–±—É–¥—å –∫–æ–ª–ª–∏–∑–∏–π –ø—Ä–∏ –¥–µ–ø–ª–æ–µ) –∏ —Ç–∞–∫–∂–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏—é <code>PropertySourceLoader</code> , —Ç.–µ. –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å—á–∏—Ç—ã–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π. –ë–ª–∏–∂–∞–π—à–∏–π –∞–Ω–∞–ª–æ–≥ –≤ <code>Spring</code> ‚Äì —ç—Ç–æ –Ω–∞–≤–µ—Ä–Ω–æ–µ <code>ApplicationContext</code> ( <code>xml</code> , <code>web</code> , <code>groovy</code> , <code>ClassPath</code> etc.) –í–∏–¥–Ω–æ, —á—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–¥–µ–ª–∞–Ω–∞ –±–æ–ª—å—à–∞—è —Ä–∞–±–æ—Ç–∞ –∏ —ç—Ç–æ—Ç –∞—Å–ø–µ–∫—Ç –ø—Ä–æ–¥—É–º–∞–Ω –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –∏ –ø–æ–¥—Ä–æ–±–Ω–æ. </p><br><h3 id="testy">  Tests </h3><br><p> –ü–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —è –Ω–µ –æ—Å–æ–±–æ –≤–ø–µ—á–∞—Ç–ª–∏–ª—Å—è —Ç–µ–º, —á—Ç–æ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç micronaut. –ù–∞–º —Ä–µ–∫–ª–∞–º–∏—Ä—É—é—Ç Embedded Server feature, –∞ —Ç–∞–∫–∂–µ –∫–∞–∫ –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ <code>Groovy</code> —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ <code>Spock</code> . –¢–∞–∫ –∫–∞–∫ –º—ã —Ç–æ–ø–∏–º –∑–∞ <code>Java</code> , —Ç–æ groovy-—Ç–µ—Å—Ç—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ö–æ–¥–∏–º –º–∏–º–æ. –í–æ–æ–±—â–µ–º, —è –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Ç–æ–ª—å–∫–æ <code>EmbeddedServer</code> + <code>HttpClient</code> –∏–∑ –ø–æ—Å—Ç–∞–≤–∫–∏ <code>Micronaut</code> –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª –æ–¥–Ω—É –∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö API ‚Äî </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /cryptonaut/restapi/portfolio/total.json?fiatCurrency={x}</code> </pre> <br><p> –ö–ª—é—á–µ–≤–æ–µ API, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã—á–∏—Å–ª—è–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –Ω–µ–∫–æ–π —Ü–µ–ª–µ–≤–æ–π —Ñ–∏–∞—Ç–Ω–æ–π –≤–∞–ª—é—Ç–µ. </p><br><p> –ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ç–µ—Å—Ç–∞ –Ω–∏–∂–µ: </p><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioReportsControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EmbeddedServer <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HttpClient <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>; @Inject <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PortfolioService portfolioService; @BeforeClass <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> setupServer() { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = ApplicationContext.run(EmbeddedServer.class); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> .getApplicationContext() .createBean(HttpClient.class, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.getURL()); } @AfterClass <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> stopServer() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.stop(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.stop(); } } @Test <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> total() { <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Seems like code smell. I don't like it.. portfolioService = server.getApplicationContext().getBean(PortfolioService.class); Portfolio portfolio = new Portfolio(); Map&lt;String, BigDecimal&gt; coins = new HashMap&lt;&gt;(); BigDecimal amt1 = new BigDecimal("570.05"); BigDecimal amt2 = new BigDecimal("2.5"); coins.put("XRP", amt1); coins.put("QTUM", amt2); portfolio.setCoins(coins); portfolioService.savePortfolio(portfolio); HttpRequest request = HttpRequest.GET("/cryptonaut/restapi/portfolio/total.json?fiatCurrency=USD"); HttpResponse&lt;Total&gt; rsp = client.toBlocking().exchange(request, Total.class); assertEquals(200, rsp.status().getCode()); assertEquals(MediaType.APPLICATION_JSON_TYPE, rsp.getContentType().get()); Total val = rsp.body(); assertEquals("USD", val.getFiatCurrency()); assertEquals(TEST_VALUE.toString(), val.getValue().toString()); assertEquals(amt1.toString(), val.getPortfolio().getCoins().get("XRP").toString()); assertEquals(amt2.toString(), val.getPortfolio().getCoins().get("QTUM").toString()); } }</span></span></code> </pre> <br><p> –ò–∑ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ —Å—Ç–æ–∏—Ç –æ—Ç–º–µ—Ç–∏—Ç—å —Ç–æ, —á—Ç–æ –¥–ª—è —Ü–µ–ª–µ–π —Ç–µ—Å—Ç–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ mock —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ <code>PortfolioService.java</code> : </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.context.annotation.Requires; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Requires</span></span>(env=<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockPortfolioService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Portfolio portfolio; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BigDecimal TEST_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"56.65"</span></span>); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.portfolio = portfolio; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadPortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Optional&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateTotalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio, String fiatCurrency)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.of(TEST_VALUE); } }</code> </pre> <br><p> –ó–¥–µ—Å—å —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é <code>@Requires(env="test")</code> , —ç—Ç–æ —Å–ø–æ—Å–æ–± –≤–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏—è –±–∏–Ω–æ–≤ –≤ <code>Application Context</code> –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ-—É–º–æ–ª—á–∞–Ω–∏—é, –≤–æ –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤ micronaut –ø–æ–¥—ã–º–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ test, –∏ –∑–¥–µ—Å—å —ç—Ç–æ —Å–ø–æ—Å–æ–± —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ç–µ—Å—Ç–∞—Ö. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∞–≤—Ç–æ–≤–∞–π—Ä–∏–Ω–≥–∞ –≤ —Ç–µ—Å—Ç–∞—Ö –∏ –Ω–∞ –∑–∞–ø—É—Å–∫–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏, –∏—Å—Ç–∏–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è <code>PortfolioServiceImpl</code> –±—ã–ª–∞ –ø–æ–º–µ—á–µ–Ω–∞ –≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–µ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏–µ–π <code>@Requires(notEnv="test")</code> . –í–æ—Ç —Ç–∞–∫–∏–µ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ç–µ–ª–æ–¥–≤–∏–∂–µ–Ω–∏—è –ø–æ–∑–≤–æ–ª—è—é—Ç –≥–∏–±–∫–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–±–æ—Ä–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö ‚Äì –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–æ–≤ –∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω–µ. –ó–¥–µ—Å—å <code>Micronaut</code> –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ —Å–µ–±—è –ø—Ä–æ—è–≤–∏–ª –∏ –Ω–∏–∫–∞–∫–∏—Ö –∑–∞—Ç—Ä—É–¥–Ω–µ–Ω–∏–π –≤ —Ä–µ—à–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –Ω–µ –≤—ã–∑–≤–∞–ª. </p><br><p> –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞, –∫–∞–∫ —Ç–æ ‚Äì —Ä–∞—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏, —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã –≤ —Ñ–∏–∞—Ç–Ω–æ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏, –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≤—ã–∑–æ–≤—ã ‚Äì –±—ã–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫—Ä—ã—Ç—ã –æ–±—ã—á–Ω—ã–º–∏ —Ç–µ—Å—Ç–∞–º–∏ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º <code>mockito</code> . –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –æ–¥–∏–Ω –∏–∑ —Ç–µ—Å—Ç–æ–≤ —Ç–∞–∫–æ–≥–æ –Ω–∞–±–æ—Ä–∞: </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priceForUsdDirectRate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ when(marketDataServiceFactory.getMarketDataService()).thenReturn(marketDataService); String coinCode = <span class="hljs-string"><span class="hljs-string">"ETH"</span></span>; String fiatCurrencyCode = <span class="hljs-string"><span class="hljs-string">"USD"</span></span>; BigDecimal priceA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"218.58"</span></span>); Ticker targetTicker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ticker.Builder().bid(priceA).build(); when(marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode)))).thenReturn(targetTicker); CryptoMarketDataService cryptoMarketDataService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoMarketDataService(fiatExchangeRatesService, marketDataServiceFactory); assertEquals(priceA, cryptoMarketDataService.getPrice(coinCode, fiatCurrencyCode)); }</code> </pre> <br><h3 id="keshirovanie"> –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ </h3><br><p> –û–±—Ä–∞—Ç–∏–º –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –æ–¥–Ω–∞ –≤–µ—â—å –æ—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—é. –ö—É—Ä—Å —Ñ–∏–∞—Ç–Ω—ã—Ö –≤–∞–ª—é—Ç –º—ã –ø–æ–ª—É—á–∞–µ–º –∫–∞–∫ –∏–∑–≤–µ—Å—Ç–Ω–æ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¶–ë. –ò –∫–∞–∫ –º—ã –∑–Ω–∞–µ–º, –æ–Ω –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –∏ –∫—É—Ä—Å –∞–∫—Ç—É–∞–ª–µ–Ω —Ä–æ–≤–Ω–æ —Å—É—Ç–∫–∏. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ, –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ —Å–º—ã—Å–ª–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ä–∞–∑ –∑–∞ —Ä–∞–∑–æ–º, —Ä–∏—Å–∫—É—è –Ω–∞—Ä–≤–∞—Ç—å—Å—è –Ω–∞ —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥ –∏–ª–∏ –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å –±–∞–Ω –ø–æ IP. –ó–¥–µ—Å—å –Ω–∞–º –ø–æ–º–æ–∂–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ª–µ–≥–∫–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—Ä–æ–ø–µ—Ä—Ç–µ–π –∏ –Ω–∞–≤–µ—à–∏–≤–∞–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ <code>@Cacheable</code> —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∏–º–µ–Ω–∏ –∫–µ—à–∞. <br></p><br><img src="https://habrastorage.org/webt/yz/xn/mc/yzxnmcojgibaurai_jflh202xic.jpeg" alt="Cache"><br><br> –û–¥–Ω–∞–∫–æ, –∑–¥–µ—Å—å –≤—Å–µ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–µ –∑–∞–¥–∞–ª–æ—Å—å. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ —ç—Ç–æ–º –∞—Å–ø–µ–∫—Ç–µ —Å–±–∏–≤–∞–µ—Ç —Å —Ç–æ–ª–∫—É, –≥–¥–µ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏–≤ –ø–∞—Ä—É —ç–∫—Ä–∞–Ω–æ–≤ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—à—å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–µ –¥—Ä—É–≥ –¥—Ä—É–≥—É –∫—É—Å–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π ( <code>appliction.yml</code> ). –í –∫–∞—á–µ—Å—Ç–≤–µ –∫–µ—à–∞ –±—ã–ª –≤—ã–±—Ä–∞–Ω redis, —Ç–∞–∫–∂–µ –ø–æ–¥–Ω–∏–º–∞–µ–º—ã–π –≤ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ —Ä—è–¥—ã—à–∫–æ–º. –í–æ—Ç –µ–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: <br><pre> <code class="hljs mel">redis: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: <span class="hljs-string"><span class="hljs-string">'bitnami/redis:latest'</span></span> environment: - ALLOW_EMPTY_PASSWORD=yes ports: - <span class="hljs-string"><span class="hljs-string">'6379:6379'</span></span></code> </pre> <br><p> –ê –≤–æ—Ç –∫—É—Å–æ–∫ –∫–æ–¥–∞ –ø—Ä–æ–∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π @Cacheable: </p><br><pre> <code class="hljs vbscript">@Cacheable(<span class="hljs-string"><span class="hljs-string">"fiatRates"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; getRates() { HttpRequest&lt;?&gt; req = HttpRequest.<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-built_in"><span class="hljs-built_in">response</span></span> = httpClient.retrieve(req, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>).blockingSingle(); try { JsonNode json = objectReader.readTree(<span class="hljs-built_in"><span class="hljs-built_in">response</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> usdPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"USD"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> eurPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"EUR"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> gbpPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"GBP"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); Map&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; prices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); prices.put(<span class="hljs-string"><span class="hljs-string">"USD"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(usdPrice)); prices.put(<span class="hljs-string"><span class="hljs-string">"GBP"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(gbpPrice)); prices.put(<span class="hljs-string"><span class="hljs-string">"EUR"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(eurPrice)); return prices; } catch (IOException e) { throw <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } }</code> </pre> <br><p> –ê –≤–æ—Ç —Å <code>application.yml</code> –±—ã–ª–∞ —Å–∞–º–∞—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–≥–∞–¥–∫–∞. –Ø –ø–µ—Ä–µ–ø—Ä–æ–±–æ–≤–∞–ª –≤—Å—è—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –í–æ—Ç —Ç–∞–∫—É—é: </p><br><pre> <code class="hljs pgsql">caches: fiatrates: expireAfterWrite: "1h" redis: caches: fiatRates: expireAfterWrite: "1h" port: <span class="hljs-number"><span class="hljs-number">6379</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: localhost</code> </pre> <br><p> –í–æ—Ç —Ç–∞–∫—É—é: </p><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#cache redis: uri: localhost:6379 caches: fiatRates: expireAfterWrite: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1h"</span></span></span></span></code> </pre> <br><p> –ò –¥–∞–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª —É–±–∏—Ä–∞—Ç—å –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –±—É–∫–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∫–µ—à–∞. –ù–æ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–ª—É—á–∞–ª –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî ‚ÄúUnexpected error occurred: No cache configured for name: fiatRates‚Äù: </p><br><pre> <code class="hljs sql">ERROR imhsnetty.RoutingInBoundHandler - Unexpected error occurred: No <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: fiatRates io.micronaut.context.exceptions.ConfigurationException: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: fiatRates <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.DefaultCacheManager.getCache(DefaultCacheManager.java:<span class="hljs-number"><span class="hljs-number">67</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.interceptor.CacheInterceptor.interceptSync(CacheInterceptor.java:<span class="hljs-number"><span class="hljs-number">176</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.interceptor.CacheInterceptor.intercept(CacheInterceptor.java:<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.aop.MethodInterceptor.intercept(MethodInterceptor.java:<span class="hljs-number"><span class="hljs-number">41</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.aop.chain.InterceptorChain.proceed(InterceptorChain.java:<span class="hljs-number"><span class="hljs-number">147</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.markets.clients.$CbrExchangeRatesClientDefinition$Intercepted.getRates(<span class="hljs-literal"><span class="hljs-literal">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Source</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService.getFiatPrice(FiatExchangeRatesService.java:<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.rest.MarketDataController.index(MarketDataController.java:<span class="hljs-number"><span class="hljs-number">34</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.rest.$MarketDataControllerDefinition$$exec2.invokeInternal(<span class="hljs-literal"><span class="hljs-literal">Unknown</span></span> ...</code> </pre> <br><p> –ü–æ–∏—Å–∫ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ <code>GitHub</code> -–µ –∏–ª–∏ –ø–æ <code>SO</code> –Ω–µ –ø–æ–º–æ–≥ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É. –ù–µ–º–Ω–æ–≥–æ –ø–æ–∫–æ–ø–∞–≤—à–∏—Å—å –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞—Ö —Ç–∞–∫–∂–µ –±—ã–ª —Ä–∞—Å—Ç–µ—Ä—è–Ω –∏ –ø–∞–ª –¥—É—Ö–æ–º. –ó–∞—Ç–µ—è –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å, –∂–∞–ª—å. –ê –≤–µ–¥—å –≤ –ø–ª–∞–Ω–∞—Ö –µ—â—ë –±—ã–ª–∞ –∑–∞–¥—É–º–∫–∞ –¥–∞–ª–µ–µ –Ω–∞–≤–µ—Å–∏—Ç—å –∫–æ–¥, –≤—ã–ø–æ–ª–Ω—è—é—â–∏–π—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É—é—â–∏–π —ç—Ç–æ—Ç –∫–µ—à. –ü–∏—Å–∞—Ç—å –∫–µ—à–∏—Ä—É—é—â–∏–π boilerplate-–∫–æ–¥, –Ω–∞–ø—Ä—è–º—É—é –æ–±—Ä–∞—â–∞—é—â–∏–π—Å—è –∫ –∫–∞–∫–æ–º—É-–Ω–∏–±—É–¥—å —Å–∫–∞–∂–µ–º <code>Redis</code> -–∫–ª–∏–µ–Ω—Ç—É —è –Ω–µ –∑–∞—Ö–æ—Ç–µ–ª, –º—ã—Å–ª–µ–Ω–Ω–æ –¥–ª—è —Å–µ–±—è –ø–æ—Å—á–∏—Ç–∞–≤, —á—Ç–æ –∑–¥–µ—Å—å Spring Boot –æ—Ç—Ö–≤–∞—Ç–∏–ª –ø–æ–±–µ–¥—É, –∏–º–µ—è –±–æ–ª–µ–µ –ø–æ–ª–Ω—É—é –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø–æ–º–æ—â—å –∫–æ–º—å—é–Ω–∏—Ç–∏. </p><br><h3 id="sidim-v-kustah-s-sekundomerom"> –°–∏–¥–∏–º –≤ –∫—É—Å—Ç–∞—Ö —Å —Å–µ–∫—É–Ω–¥–æ–º–µ—Ä–æ–º </h3><br><p> –î–ª—è —É—Ç–æ–ª–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ª—é–±–æ–ø—ã—Ç—Å—Ç–≤–∞ –∏ —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–ª–∏ –æ–ø—Ä–æ–≤–µ—Ä–≥–Ω—É—Ç—å —Ç–æ, —á—Ç–æ –ø—Ä–µ–ø–æ–¥–Ω–æ—Å–∏—Ç—Å—è –∫–∞–∫ –≤–µ—Å–æ–º–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ <code>Micronaut</code> ‚Äì –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ–µ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞, —è —Ä–µ—à–∏–ª —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–º–µ—Ä–æ–≤ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å—Ä–∞–≤–Ω–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–æ Spring-–æ–º. <br></p><br><img src="https://habrastorage.org/webt/6z/nu/h5/6znuh5vgxk7g0vueo5vs1ktkznc.jpeg" alt="Benchmarking"><br><br> –ó–¥–µ—Å—å –∫–æ–Ω–µ—á–Ω–æ –Ω—É–∂–Ω–æ –±—ã —É–∫–∞–∑–∞—Ç—å —Å –¥—é–∂–∏–Ω—É Disclaimer-–æ–≤: –æ —Ç–æ–º, —á—Ç–æ —è –Ω–µ –±–µ–Ω—á–º–∞—Ä–∫-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç, –æ –º–µ—Ç–æ–¥–∏–∫–µ –∑–∞–ø—É—Å–∫–∞ –∏ –∑–∞–º–µ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å—Ç–∞—Ä—Ç–∞, –æ–± —É—Å–ª–æ–≤–∏—è—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –º–∞—à–∏–Ω—ã, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∂–µ–ª–µ–∑–∞, –û–°, –ø—Ä–æ—á–µ–µ). <br><p> –í–ø—Ä–æ—á–µ–º, –ø–æ—Å–ª–µ–¥–Ω–µ–µ —É–∫–∞–∂—É: </p><br><p> <strong>OS:</strong> 16.04.1-Ubuntu x86_64 x86_64 x86_64 GNU/Linux <br> <strong>CPU:</strong> Intel¬Æ Core(TM) i7-7700HQ CPU @ 2.80GHz <br> <strong>Mem:</strong> 2 –ø–ª–∞—à–∫–∏ –ø–æ 8 Gb DDR4, Speed: 2400 MHz <br> <strong>SSD Disk:</strong> –¢–≤–µ—Ä–¥–æ—Ç–µ–ª—å–Ω—ã–π –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å PCIe NVMe M.2, 256 –ì–±–∞–π—Ç </p><br><p> –ú–æ—è <del>  defense </del> –º–µ—Ç–æ–¥–∏–∫–∞: </p><br><ol><li> –ü–æ–≥–∞—Å–∏—Ç—å —Ç–∞—á–∫—É </li><li> –í–∫–ª—é—á–∏—Ç—å —Ç–∞—á–∫—É </li><li> –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è </li><li> –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —ç—Ç–∏–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥ –≤ —Ü–∏–∫–ª–µ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–¥–Ω—É API, –ø—Ä–æ—Å—Ç–æ –≤—ã–¥–∞—é—â—É—é —Å—Ç—Ä–æ–∫—É –≤ –æ—Ç–≤–µ—Ç–µ </li><li> –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç –æ—Ç API –ø–æ–ª—É—á–µ–Ω ‚Äì ‚Äú—Ç–∞–π–º–µ—Ä‚Äù –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è. </li><li> –í —Ç–∞–±–ª–∏—á–∫—É —Ç—â–∞—Ç–µ–ª—å–Ω–æ –∑–∞–Ω–æ—Å–∏—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –º–∏–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö </li></ol><br><p> –ò –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã —à–∞–±–ª–æ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —Å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º–∏ –Ω–∞–±–æ—Ä–∞–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ ‚Äì –æ–¥–∏–Ω <code>Rest Controller</code> –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –∫–ª–∞—Å—Å ‚Äì –∑–∞–ø—É—Å–∫–∞—é—â–∏–π IoC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –≤—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞. </p><br><p> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–µ–¥–Ω–∏—Ö –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö ‚Äú–≤—Ä–µ–º–µ–Ω–∏ —Å—Ç–∞—Ä—Ç–∞‚Äù –∑–∞–Ω–µ—Å–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É –Ω–∏–∂–µ: </p><br><table><thead><tr><th></th><th> Micronaut </th><th> Spring Boot </th></tr></thead><tbody><tr><td> Avg.(ms) </td><td> 2708.4 </td><td> 2735.2 </td></tr><tr><td> –°—Ç–∞—Ä—Ç–∞–ø –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è cryptonaut –ø–æ –≤–µ—Ä—Å–∏–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ (ms) </td><td>  1082 </td><td>  - </td></tr></tbody></table><br><p> –ö–∞–∫ –≤–∏–¥–∏–º, –Ω–∞ —Ç–∞–∫–∏—Ö –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ä–∞–∑–Ω–∏—Ü–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞ ‚Äì –ø–æ—Ä—è–¥–∫–∞ <strong>27</strong> –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –≤ –ø–æ–ª—å–∑—É <code>Micronaut</code> . –í–æ–∑–º–æ–∂–Ω–æ, —Ä–∞–∑–Ω–∏—Ü–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ—â—É—Ç–∏–º–µ–µ —Å —Ä–æ—Å—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–∏ –±–æ–ª—å—à–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –Ω–∏–º–∏. </p><br><h3 id="chto-po-itogu"> –ß—Ç–æ –ø–æ –∏—Ç–æ–≥—É? </h3><br><p> –ü–æ–¥–≤–µ–¥–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∏—Ç–æ–≥–∏. –û—Å–Ω–æ–≤–Ω—É—é —Ü–µ–ª—å, –∞ –æ–Ω–∞ –±—ã–ª–∞, –Ω–∞–ø–æ–º–∏–Ω–∞—é, –≤—ã—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ –Ω–æ–≤–æ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ ‚Äì –±—ã–ª–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞. –ù–∞ —ç—Ç–æ–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–µ –≤–ø–æ–ª–Ω–µ –º–æ–∂–Ω–æ –≤–µ—Å—Ç–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –¥–∞–∂–µ –≤–ø–æ–ª–Ω–µ –Ω–∞—Ä–∞—â–∏–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–∫–∞ –±–æ–ª—å—à–µ –∑–∞—Ç–æ—á–µ–Ω–∞ –ø–æ–¥ Groovy-–∞–¥–µ–ø—Ç–æ–≤, –∏ —ç—Ç–æ –Ω–µ —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –≤—Å–ø–æ–º–Ω–∏—Ç—å –∫—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –ù–µ—Ç —Ç–∞–∫–æ–π —Ç—É—Å–æ–≤–∫–∏ –Ω–∞ <a href="https://stackoverflow.com/"><code>SO</code></a> –∫–∞–∫ —É —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–µ–∫—Ç–æ–≤ Spring. –ù–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∞ —Ç–∞–∫–∂–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π –≤–ø–æ–ª–Ω–µ –¥—Ä—É–∂–µ–ª—é–±–µ–Ω –¥–ª—è –Ω–æ–≤—á–∏–∫–∞ –∏ –Ω–∞—á–∞—Ç—å –ø–∏—Å–∞—Ç—å —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø—Ä–æ–µ–∫—Ç –º–æ–∂–Ω–æ –ø—Ä–æ–±–æ–≤–∞—Ç—å —É–∂–µ —Å–µ–π—á–∞—Å. –ù–æ –¥–∞–±—ã –Ω–µ –ª—É–∫–∞–≤–∏—Ç—å —Å–∫–∞–∂—É —Å–∞–º –∑–∞ —Å–µ–±—è ‚Äî —è –ø–æ–∫–∞ —á—Ç–æ –æ—Å—Ç–∞–Ω—É—Å—å –≤ –ª–∞–≥–µ—Ä–µ –í–µ—Å–Ω—É—à–µ—á–Ω–∏–∫–æ–≤. –£–∂ –±–æ–ª—å–Ω–æ —Ö–æ—Ä–æ—à–æ –Ω–∞–±–∏—Ç–∞ —Ä—É–∫–∞ –∏ –∑–∞—Ç–æ—á–µ–Ω–æ –º—ã—à–ª–µ–Ω–∏–µ –ø–æ–¥ –∏–¥–µ–æ–ª–æ–≥–∏—é Spring. </p><br><p> <strong>–ß—Ç–æ –Ω–µ –±—ã–ª–æ –æ–ø—Ä–æ–±–æ–≤–∞–Ω–æ:</strong> </p><br><ul><li> –º–Ω–æ–≥–∏–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –∏–∑ –∫–æ—Ä–æ–±–∫–∏ —Ñ–∏—à–∫–∏ Micronaut ‚Äì –≤—Å—è—á–µ—Å–∫–∏–µ service-discovery, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ª—è–º–±–¥ –≤ AWS </li><li>  authorization </li><li> –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞–ø–∏—Å–∞—Ç—å —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞ Java. –¢–æ –µ—Å—Ç—å –Ω–∞ Kotlin –ª–∏–±–æ –Ω–∞ Groovy. </li></ul><br><p> –ò—Å—Ö–æ–¥–Ω–∏–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –º–æ–∂–Ω–æ –∏–∑—É—á–∏—Ç—å <a href="">—Ç—É—Ç</a> . </p></div><p>Source: <a href="https://habr.com/ru/post/427595/">https://habr.com/ru/post/427595/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>