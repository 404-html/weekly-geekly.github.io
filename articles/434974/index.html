<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with the 1C: Enterprise configuration format</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to publish the C # source code for working with the 1C: Enterprise configuration format. 


 https://github.com/elisy/MdInternals 


 MdInte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <div class="page-header-logo-container"></div>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with the 1C: Enterprise configuration format</h1><div class="post__text post__text-html js-mediator-article"><p>  I decided to publish the C # source code for working with the 1C: Enterprise configuration format. </p><br><p>  <b><a href="https://github.com/elisy/MdInternals">https://github.com/elisy/MdInternals</a></b> </p><br><p>  MdInternals understands the format of cf, cfu, epf, erf, unpacks the content into readable Xml and text files and loads it back.  Allows you to programmatically access the internal files and properties of objects. </p><br><p>  The project consists of parts: <br><br></p><ul><li>  MdInternals programmatically refers to configuration objects and properties. </li><li>  CfProject is responsible for the serialization and deserialization of MdInternals objects. </li><li>  MdInternals.Cil decompiles bytecode (OpCode) 1C </li><li>  MdInternals.Serialization works with internal semi-JSON format 1C of the form "{19 {" ", 2}}" </li></ul><br><br><a name="habracut"></a><br><h2>  Upload files cf, cfu, epf, erf to disk </h2><br><pre><code class="plaintext hljs">var cf = new CfPackage(); //–∏–ª–∏ var cf = new EpfPackage(); //–∏–ª–∏ var cf = new ErfPackage(); //–∏–ª–∏ var cf = new CfuPackage(); cf.Open(@"D:\config.cf"); var project = new CfProject(); project.Save(epf, @"D:\Config\Xml\Config.cfproj", ProjectType.Xml);</code> </pre> <br><p>  Recognized files are written to the directory tree by object type.  Unrecognized are placed in the Unresolved directory: </p><br><img src="http://www.richmedia.us/image.axd?picture=2019%2f1%2fimage2.png"><br><br><p>  Recognized files are uploaded in XML format.  The XML format allows you to control the logical integrity of files and process files with third-party programs.  Known properties are moved to the appropriate sections (attributes or tags) of the XML structure: </p><br><br><img src="http://www.richmedia.us/image.axd?picture=2019%2f1%2fimage3.png"><br><br><h2>  Read from MSSQL table </h2><br><pre> <code class="plaintext hljs">var image = ImageReader.ReadImageFromConfig(@"data source=192.168.1.2\SQL2005;user=login;pwd=password;database=Database1C");</code> </pre> <br><br><h2>  Accessing internal files </h2><br><pre> <code class="plaintext hljs">var mp = new EpfPackage(); mp.Open(file); var root = mp.MetadataObjects.Where(m =&gt; m.ImageRow.FileName == "root").FirstOrDefault(); var rp = new RootPointer(root.ImageRow); var part = mp.MetadataObjects.Where(m =&gt; m.ImageRow.FileName == rp.MetadataPackageFileName.ToString()).FirstOrDefault();</code> </pre><br><h2>  Creating a file from the uploaded xml format </h2><br><pre> <code class="plaintext hljs">var project = new CfProject(); var mp = project.Load(@"D:\Config\Xml\Config.cfproj"); mp.Save(@"D:\config.cf");</code> </pre><br><h2>  Cf Format Description </h2><br><p>  The cf file consists of the image header (ImageHeader) and the following pages (ImagePage1-ImagePageN).  The image header consists of 4 bytes of the signature, which is 0xFF 0xFF 0xFF 0x7F, 4x page size bytes and 8 reserved bytes.  After the header of the file are in order of the page with the data.  Each previous page refers to the next. </p><br><br><img src="http://www.richmedia.us/image.axd?picture=2019%2f1%2fimage4.png"><br><br><p>  Each page (ImagePage) consists of a page header (ImagePageHeader), a group of pointers to ImageRowPointers entries, and an ImageRows area. </p><br><br><img src="http://www.richmedia.us/image.axd?picture=2019%2f1%2fimage1.png"><br><br><p>  The header of the ImagePageHeader page contains: reserved 2 bytes 0x0D 0x0A, 27 bytes of text information, and reserved 2 bytes 0x0D 0x0A.  Text information contains 3 hexadecimal numbers: the total data size of all pages (FullSize), the size of the current page (PageSize) and the address of the next page in the file (NextPageAddress).  FullSize is affixed only for the first page of the page chain.  For the remaining pages of the thread, this value is 0. For the last page of the thread, the NextPageAddress is taken to be 0xFF 0xFF 0xFF 0x7F. </p><br><p>  The block of pointers ImageRowPointers is the size specified in the PageSize value of the page.  Each pointer consists of 4 bytes of the HeaderAddress header address and 4 bytes of the BodyAddress body address.  At the end of each pointer is placed the signature 0xFF 0xFF 0xFF 0x7F.  Addresses indicate locations within the current page to the ImageRows area. </p><br><p>  The ImageRowHeader header starts with the ImagePageHeader page title block, which tells you how many bytes are allocated for the header.  Next come 20 reserved bytes, a UTF-16 data identifier string (Id) and 4 reserved bytes. </p><br><p>  The body of ImageRowBody begins with the block header of the ImagePageHeader page, which tells you how many bytes are allocated to the data body.  If the data body starts at 0xEF 0xBB 0xBF (signature UTF8), then the body contains a UTF-8 string.  Otherwise, the data body contains packed data.  If the unpacked data starts with 0xFF 0xFF 0xFF 0x7F, then the contents are a sequence of objects, and they are written in CF format.  Otherwise, the content is a serialization string. </p><br><br><h2>  What is not implemented </h2><br><ul><li>  The utility recognizes only configuration objects of the 1st level, placing them in subdirectories.  Does not recognize the rest: forms, layouts, placing in the directory Unresolved </li><li>  The Unresolved directory does not decompress composite objects with the img extension. </li><li>  MdInternals recognizes a limited number of object properties </li></ul></div><p>Source: <a href="https://habr.com/ru/post/434974/">https://habr.com/ru/post/434974/</a></p>
<section class="navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><p>Waiting for the list form <a href="../../index.html">here</a>...</p></nav>
</section>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>
</body>

</html>